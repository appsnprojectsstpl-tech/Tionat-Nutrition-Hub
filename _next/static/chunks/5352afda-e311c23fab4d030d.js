"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[8042],{71144:(e,t,n)=>{var r,i,s,a,o=n(87358),l=n(44134).hp;Object.defineProperty(t,"__esModule",{value:!0});var u=n(29438),c=n(79910),h=n(63517),d=n(28793),f=n(77061),m=n(74905);let g="@firebase/firestore",p="4.7.17";class y{constructor(e){this.uid=e}isAuthenticated(){return null!=this.uid}toKey(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}isEqual(e){return e.uid===this.uid}}y.UNAUTHENTICATED=new y(null),y.GOOGLE_CREDENTIALS=new y("google-credentials-uid"),y.FIRST_PARTY=new y("first-party-uid"),y.MOCK_USER=new y("mock-user");let w="11.9.0",v=new h.Logger("@firebase/firestore");function I(){return v.logLevel}function _(e,...t){if(v.logLevel<=h.LogLevel.DEBUG){let n=t.map(E);v.debug(`Firestore (${w}): ${e}`,...n)}}function T(e,...t){if(v.logLevel<=h.LogLevel.ERROR){let n=t.map(E);v.error(`Firestore (${w}): ${e}`,...n)}}function b(e,...t){if(v.logLevel<=h.LogLevel.WARN){let n=t.map(E);v.warn(`Firestore (${w}): ${e}`,...n)}}function E(e){if("string"==typeof e)return e;try{return JSON.stringify(e)}catch(t){return e}}function x(e,t,n){let r="Unexpected state";"string"==typeof t?r=t:n=t,S(e,r,n)}function S(e,t,n){let r=`FIRESTORE (${w}) INTERNAL ASSERTION FAILED: ${t} (ID: ${e.toString(16)})`;if(void 0!==n)try{r+=" CONTEXT: "+JSON.stringify(n)}catch(e){r+=" CONTEXT: "+n}throw T(r),Error(r)}function C(e,t,n,r){let i="Unexpected state";"string"==typeof n?i=n:r=n,e||S(t,i,r)}let N={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"};class D extends d.FirebaseError{constructor(e,t){super(e,t),this.code=e,this.message=t,this.toString=()=>`${this.name}: [code=${this.code}]: ${this.message}`}}class A{constructor(){this.promise=new Promise((e,t)=>{this.resolve=e,this.reject=t})}}class k{constructor(e,t){this.user=t,this.type="OAuth",this.headers=new Map,this.headers.set("Authorization",`Bearer ${e}`)}}class R{getToken(){return Promise.resolve(null)}invalidateToken(){}start(e,t){e.enqueueRetryable(()=>t(y.UNAUTHENTICATED))}shutdown(){}}class M{constructor(e){this.token=e,this.changeListener=null}getToken(){return Promise.resolve(this.token)}invalidateToken(){}start(e,t){this.changeListener=t,e.enqueueRetryable(()=>t(this.token.user))}shutdown(){this.changeListener=null}}class F{constructor(e){this.t=e,this.currentUser=y.UNAUTHENTICATED,this.i=0,this.forceRefresh=!1,this.auth=null}start(e,t){C(void 0===this.o,42304);let n=this.i,r=e=>this.i!==n?(n=this.i,t(e)):Promise.resolve(),i=new A;this.o=()=>{this.i++,this.currentUser=this.u(),i.resolve(),i=new A,e.enqueueRetryable(()=>r(this.currentUser))};let s=()=>{let t=i;e.enqueueRetryable(async()=>{await t.promise,await r(this.currentUser)})},a=e=>{_("FirebaseAuthCredentialsProvider","Auth detected"),this.auth=e,this.o&&(this.auth.addAuthTokenListener(this.o),s())};this.t.onInit(e=>a(e)),setTimeout(()=>{if(!this.auth){let e=this.t.getImmediate({optional:!0});e?a(e):(_("FirebaseAuthCredentialsProvider","Auth not yet detected"),i.resolve(),i=new A)}},0),s()}getToken(){let e=this.i,t=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(t).then(t=>this.i!==e?(_("FirebaseAuthCredentialsProvider","getToken aborted due to token change."),this.getToken()):t?(C("string"==typeof t.accessToken,31837,{l:t}),new k(t.accessToken,this.currentUser)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.auth&&this.o&&this.auth.removeAuthTokenListener(this.o),this.o=void 0}u(){let e=this.auth&&this.auth.getUid();return C(null===e||"string"==typeof e,2055,{h:e}),new y(e)}}class V{constructor(e,t,n){this.P=e,this.T=t,this.I=n,this.type="FirstParty",this.user=y.FIRST_PARTY,this.A=new Map}R(){return this.I?this.I():null}get headers(){this.A.set("X-Goog-AuthUser",this.P);let e=this.R();return e&&this.A.set("Authorization",e),this.T&&this.A.set("X-Goog-Iam-Authorization-Token",this.T),this.A}}class L{constructor(e,t,n){this.P=e,this.T=t,this.I=n}getToken(){return Promise.resolve(new V(this.P,this.T,this.I))}start(e,t){e.enqueueRetryable(()=>t(y.FIRST_PARTY))}shutdown(){}invalidateToken(){}}class P{constructor(e){this.value=e,this.type="AppCheck",this.headers=new Map,e&&e.length>0&&this.headers.set("x-firebase-appcheck",this.value)}}class O{constructor(e,t){this.V=t,this.forceRefresh=!1,this.appCheck=null,this.m=null,this.p=null,u._isFirebaseServerApp(e)&&e.settings.appCheckToken&&(this.p=e.settings.appCheckToken)}start(e,t){C(void 0===this.o,3512);let n=e=>{null!=e.error&&_("FirebaseAppCheckTokenProvider",`Error getting App Check token; using placeholder token instead. Error: ${e.error.message}`);let n=e.token!==this.m;return this.m=e.token,_("FirebaseAppCheckTokenProvider",`Received ${n?"new":"existing"} token.`),n?t(e.token):Promise.resolve()};this.o=t=>{e.enqueueRetryable(()=>n(t))};let r=e=>{_("FirebaseAppCheckTokenProvider","AppCheck detected"),this.appCheck=e,this.o&&this.appCheck.addTokenListener(this.o)};this.V.onInit(e=>r(e)),setTimeout(()=>{if(!this.appCheck){let e=this.V.getImmediate({optional:!0});e?r(e):_("FirebaseAppCheckTokenProvider","AppCheck not yet detected")}},0)}getToken(){if(this.p)return Promise.resolve(new P(this.p));let e=this.forceRefresh;return this.forceRefresh=!1,this.appCheck?this.appCheck.getToken(e).then(e=>e?(C("string"==typeof e.token,44558,{tokenResult:e}),this.m=e.token,new P(e.token)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.appCheck&&this.o&&this.appCheck.removeTokenListener(this.o),this.o=void 0}}class q{getToken(){return Promise.resolve(new P(""))}invalidateToken(){}start(e,t){}shutdown(){}}function U(){return new TextEncoder}class B{static newId(){let e=62*Math.floor(256/62),t="";for(;t.length<20;){let n=function(e){let t="undefined"!=typeof self&&(self.crypto||self.msCrypto),n=new Uint8Array(40);if(t&&"function"==typeof t.getRandomValues)t.getRandomValues(n);else for(let e=0;e<40;e++)n[e]=Math.floor(256*Math.random());return n}(40);for(let r=0;r<n.length;++r)t.length<20&&n[r]<e&&(t+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789".charAt(n[r]%62))}return t}}function z(e,t){return e<t?-1:+(e>t)}function $(e,t){let n=0;for(;n<e.length&&n<t.length;){let r=e.codePointAt(n),i=t.codePointAt(n);if(r!==i){if(r<128&&i<128)return z(r,i);{let s=U(),a=function(e,t){for(let n=0;n<e.length&&n<t.length;++n)if(e[n]!==t[n])return z(e[n],t[n]);return z(e.length,t.length)}(s.encode(K(e,n)),s.encode(K(t,n)));return 0!==a?a:z(r,i)}}n+=r>65535?2:1}return z(e.length,t.length)}function K(e,t){return e.codePointAt(t)>65535?e.substring(t,t+2):e.substring(t,t+1)}function G(e,t,n){return e.length===t.length&&e.every((e,r)=>n(e,t[r]))}class Q{static now(){return Q.fromMillis(Date.now())}static fromDate(e){return Q.fromMillis(e.getTime())}static fromMillis(e){let t=Math.floor(e/1e3),n=Math.floor((e-1e3*t)*1e6);return new Q(t,n)}constructor(e,t){if(this.seconds=e,this.nanoseconds=t,t<0||t>=1e9)throw new D(N.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(e<-0xe7791f700||e>=0x3afff44180)throw new D(N.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e)}toDate(){return new Date(this.toMillis())}toMillis(){return 1e3*this.seconds+this.nanoseconds/1e6}_compareTo(e){return this.seconds===e.seconds?z(this.nanoseconds,e.nanoseconds):z(this.seconds,e.seconds)}isEqual(e){return e.seconds===this.seconds&&e.nanoseconds===this.nanoseconds}toString(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}toJSON(){return{seconds:this.seconds,nanoseconds:this.nanoseconds}}valueOf(){return String(this.seconds- -0xe7791f700).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")}}class j{static fromTimestamp(e){return new j(e)}static min(){return new j(new Q(0,0))}static max(){return new j(new Q(0x3afff4417f,0x3b9ac9ff))}constructor(e){this.timestamp=e}compareTo(e){return this.timestamp._compareTo(e.timestamp)}isEqual(e){return this.timestamp.isEqual(e.timestamp)}toMicroseconds(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}toString(){return"SnapshotVersion("+this.timestamp.toString()+")"}toTimestamp(){return this.timestamp}}let W="__name__";class H{constructor(e,t,n){void 0===t?t=0:t>e.length&&x(637,{offset:t,range:e.length}),void 0===n?n=e.length-t:n>e.length-t&&x(1746,{length:n,range:e.length-t}),this.segments=e,this.offset=t,this.len=n}get length(){return this.len}isEqual(e){return 0===H.comparator(this,e)}child(e){let t=this.segments.slice(this.offset,this.limit());return e instanceof H?e.forEach(e=>{t.push(e)}):t.push(e),this.construct(t)}limit(){return this.offset+this.length}popFirst(e){return e=void 0===e?1:e,this.construct(this.segments,this.offset+e,this.length-e)}popLast(){return this.construct(this.segments,this.offset,this.length-1)}firstSegment(){return this.segments[this.offset]}lastSegment(){return this.get(this.length-1)}get(e){return this.segments[this.offset+e]}isEmpty(){return 0===this.length}isPrefixOf(e){if(e.length<this.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}isImmediateParentOf(e){if(this.length+1!==e.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}forEach(e){for(let t=this.offset,n=this.limit();t<n;t++)e(this.segments[t])}toArray(){return this.segments.slice(this.offset,this.limit())}static comparator(e,t){let n=Math.min(e.length,t.length);for(let r=0;r<n;r++){let n=H.compareSegments(e.get(r),t.get(r));if(0!==n)return n}return z(e.length,t.length)}static compareSegments(e,t){let n=H.isNumericId(e),r=H.isNumericId(t);return n&&!r?-1:!n&&r?1:n&&r?H.extractNumericId(e).compare(H.extractNumericId(t)):$(e,t)}static isNumericId(e){return e.startsWith("__id")&&e.endsWith("__")}static extractNumericId(e){return f.Integer.fromString(e.substring(4,e.length-2))}}class Y extends H{construct(e,t,n){return new Y(e,t,n)}canonicalString(){return this.toArray().join("/")}toString(){return this.canonicalString()}toUriEncodedString(){return this.toArray().map(encodeURIComponent).join("/")}static fromString(...e){let t=[];for(let n of e){if(n.indexOf("//")>=0)throw new D(N.INVALID_ARGUMENT,`Invalid segment (${n}). Paths must not contain // in them.`);t.push(...n.split("/").filter(e=>e.length>0))}return new Y(t)}static emptyPath(){return new Y([])}}let J=/^[_a-zA-Z][_a-zA-Z0-9]*$/;class X extends H{construct(e,t,n){return new X(e,t,n)}static isValidIdentifier(e){return J.test(e)}canonicalString(){return this.toArray().map(e=>(e=e.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),X.isValidIdentifier(e)||(e="`"+e+"`"),e)).join(".")}toString(){return this.canonicalString()}isKeyField(){return 1===this.length&&this.get(0)===W}static keyField(){return new X([W])}static fromServerFormat(e){let t=[],n="",r=0,i=()=>{if(0===n.length)throw new D(N.INVALID_ARGUMENT,`Invalid field path (${e}). Paths must not be empty, begin with '.', end with '.', or contain '..'`);t.push(n),n=""},s=!1;for(;r<e.length;){let t=e[r];if("\\"===t){if(r+1===e.length)throw new D(N.INVALID_ARGUMENT,"Path has trailing escape character: "+e);let t=e[r+1];if("\\"!==t&&"."!==t&&"`"!==t)throw new D(N.INVALID_ARGUMENT,"Path has invalid escape sequence: "+e);n+=t,r+=2}else"`"===t?s=!s:"."!==t||s?n+=t:i(),r++}if(i(),s)throw new D(N.INVALID_ARGUMENT,"Unterminated ` in path: "+e);return new X(t)}static emptyPath(){return new X([])}}class Z{constructor(e){this.path=e}static fromPath(e){return new Z(Y.fromString(e))}static fromName(e){return new Z(Y.fromString(e).popFirst(5))}static empty(){return new Z(Y.emptyPath())}get collectionGroup(){return this.path.popLast().lastSegment()}hasCollectionId(e){return this.path.length>=2&&this.path.get(this.path.length-2)===e}getCollectionGroup(){return this.path.get(this.path.length-2)}getCollectionPath(){return this.path.popLast()}isEqual(e){return null!==e&&0===Y.comparator(this.path,e.path)}toString(){return this.path.toString()}static comparator(e,t){return Y.comparator(e.path,t.path)}static isDocumentKey(e){return e.length%2==0}static fromSegments(e){return new Z(new Y(e.slice()))}}class ee{constructor(e,t,n,r){this.indexId=e,this.collectionGroup=t,this.fields=n,this.indexState=r}}function et(e){return e.fields.find(e=>2===e.kind)}function en(e){return e.fields.filter(e=>2!==e.kind)}function er(e,t){let n=z(e.collectionGroup,t.collectionGroup);if(0!==n)return n;for(let r=0;r<Math.min(e.fields.length,t.fields.length);++r)if(0!==(n=function(e,t){let n=X.comparator(e.fieldPath,t.fieldPath);return 0!==n?n:z(e.kind,t.kind)}(e.fields[r],t.fields[r])))return n;return z(e.fields.length,t.fields.length)}ee.UNKNOWN_ID=-1;class ei{constructor(e,t){this.fieldPath=e,this.kind=t}}class es{constructor(e,t){this.sequenceNumber=e,this.offset=t}static empty(){return new es(0,el.min())}}function ea(e,t){let n=e.toTimestamp().seconds,r=e.toTimestamp().nanoseconds+1;return new el(j.fromTimestamp(1e9===r?new Q(n+1,0):new Q(n,r)),Z.empty(),t)}function eo(e){return new el(e.readTime,e.key,-1)}class el{constructor(e,t,n){this.readTime=e,this.documentKey=t,this.largestBatchId=n}static min(){return new el(j.min(),Z.empty(),-1)}static max(){return new el(j.max(),Z.empty(),-1)}}function eu(e,t){let n=e.readTime.compareTo(t.readTime);return 0!==n||0!==(n=Z.comparator(e.documentKey,t.documentKey))?n:z(e.largestBatchId,t.largestBatchId)}let ec="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.";class eh{constructor(){this.onCommittedListeners=[]}addOnCommittedListener(e){this.onCommittedListeners.push(e)}raiseOnCommittedEvent(){this.onCommittedListeners.forEach(e=>e())}}async function ed(e){if(e.code!==N.FAILED_PRECONDITION||e.message!==ec)throw e;_("LocalStore","Unexpectedly lost primary lease")}class ef{constructor(e){this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,e(e=>{this.isDone=!0,this.result=e,this.nextCallback&&this.nextCallback(e)},e=>{this.isDone=!0,this.error=e,this.catchCallback&&this.catchCallback(e)})}catch(e){return this.next(void 0,e)}next(e,t){return this.callbackAttached&&x(59440),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(t,this.error):this.wrapSuccess(e,this.result):new ef((n,r)=>{this.nextCallback=t=>{this.wrapSuccess(e,t).next(n,r)},this.catchCallback=e=>{this.wrapFailure(t,e).next(n,r)}})}toPromise(){return new Promise((e,t)=>{this.next(e,t)})}wrapUserFunction(e){try{let t=e();return t instanceof ef?t:ef.resolve(t)}catch(e){return ef.reject(e)}}wrapSuccess(e,t){return e?this.wrapUserFunction(()=>e(t)):ef.resolve(t)}wrapFailure(e,t){return e?this.wrapUserFunction(()=>e(t)):ef.reject(t)}static resolve(e){return new ef((t,n)=>{t(e)})}static reject(e){return new ef((t,n)=>{n(e)})}static waitFor(e){return new ef((t,n)=>{let r=0,i=0,s=!1;e.forEach(e=>{++r,e.next(()=>{++i,s&&i===r&&t()},e=>n(e))}),s=!0,i===r&&t()})}static or(e){let t=ef.resolve(!1);for(let n of e)t=t.next(e=>e?ef.resolve(e):n());return t}static forEach(e,t){let n=[];return e.forEach((e,r)=>{n.push(t.call(this,e,r))}),this.waitFor(n)}static mapArray(e,t){return new ef((n,r)=>{let i=e.length,s=Array(i),a=0;for(let o=0;o<i;o++){let l=o;t(e[l]).next(e=>{s[l]=e,++a===i&&n(s)},e=>r(e))}})}static doWhile(e,t){return new ef((n,r)=>{let i=()=>{!0===e()?t().next(()=>{i()},r):n()};i()})}}let em="SimpleDb";class eg{static open(e,t,n,r){try{return new eg(t,e.transaction(r,n))}catch(e){throw new ev(t,e)}}constructor(e,t){this.action=e,this.transaction=t,this.aborted=!1,this.S=new A,this.transaction.oncomplete=()=>{this.S.resolve()},this.transaction.onabort=()=>{t.error?this.S.reject(new ev(e,t.error)):this.S.resolve()},this.transaction.onerror=t=>{let n=eE(t.target.error);this.S.reject(new ev(e,n))}}get D(){return this.S.promise}abort(e){e&&this.S.reject(e),this.aborted||(_(em,"Aborting transaction:",e?e.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())}v(){let e=this.transaction;this.aborted||"function"!=typeof e.commit||e.commit()}store(e){return new e_(this.transaction.objectStore(e))}}class ep{static delete(e){return _(em,"Removing database:",e),eT(d.getGlobal().indexedDB.deleteDatabase(e)).toPromise()}static C(){if(!d.isIndexedDBAvailable())return!1;if(ep.F())return!0;let e=d.getUA(),t=ep.M(e),n=ey(e);return!(e.indexOf("MSIE ")>0||e.indexOf("Trident/")>0||e.indexOf("Edge/")>0||0<t&&t<10||0<n&&n<4.5)}static F(){var e;return void 0!==o&&"YES"===(null==(e=o.__PRIVATE_env)?void 0:e.O)}static N(e,t){return e.store(t)}static M(e){let t=e.match(/i(?:phone|pad|pod) os ([\d_]+)/i);return Number(t?t[1].split("_").slice(0,2).join("."):"-1")}constructor(e,t,n){this.name=e,this.version=t,this.B=n,this.L=null,12.2===ep.M(d.getUA())&&T("Firestore persistence suffers from a bug in iOS 12.2 Safari that may cause your app to stop working. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.")}async k(e){return this.db||(_(em,"Opening database:",this.name),this.db=await new Promise((t,n)=>{let r=indexedDB.open(this.name,this.version);r.onsuccess=e=>{t(e.target.result)},r.onblocked=()=>{n(new ev(e,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},r.onerror=t=>{let r=t.target.error;"VersionError"===r.name?n(new D(N.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh.")):"InvalidStateError"===r.name?n(new D(N.FAILED_PRECONDITION,"Unable to open an IndexedDB connection. This could be due to running in a private browsing session on a browser whose private browsing sessions do not support IndexedDB: "+r)):n(new ev(e,r))},r.onupgradeneeded=e=>{_(em,'Database "'+this.name+'" requires upgrade from version:',e.oldVersion);let t=e.target.result;if(null!==this.L&&this.L!==e.oldVersion)throw Error(`refusing to open IndexedDB database due to potential corruption of the IndexedDB database data; this corruption could be caused by clicking the "clear site data" button in a web browser; try reloading the web page to re-initialize the IndexedDB database: lastClosedDbVersion=${this.L}, event.oldVersion=${e.oldVersion}, event.newVersion=${e.newVersion}, db.version=${t.version}`);this.B.q(t,r.transaction,e.oldVersion,this.version).next(()=>{_(em,"Database upgrade to version "+this.version+" complete")})}}),this.db.addEventListener("close",e=>{let t=e.target;this.L=t.version},{passive:!0})),this.$&&(this.db.onversionchange=e=>this.$(e)),this.db}U(e){this.$=e,this.db&&(this.db.onversionchange=t=>e(t))}async runTransaction(e,t,n,r){let i="readonly"===t,s=0;for(;;){++s;try{this.db=await this.k(e);let t=eg.open(this.db,e,i?"readonly":"readwrite",n),s=r(t).next(e=>(t.v(),e)).catch(e=>(t.abort(e),ef.reject(e))).toPromise();return s.catch(()=>{}),await t.D,s}catch(t){let e="FirebaseError"!==t.name&&s<3;if(_(em,"Transaction failed with error:",t.message,"Retrying:",e),this.close(),!e)return Promise.reject(t)}}}close(){this.db&&this.db.close(),this.db=void 0}}function ey(e){let t=e.match(/Android ([\d.]+)/i);return Number(t?t[1].split(".").slice(0,2).join("."):"-1")}class ew{constructor(e){this.K=e,this.W=!1,this.G=null}get isDone(){return this.W}get j(){return this.G}set cursor(e){this.K=e}done(){this.W=!0}H(e){this.G=e}delete(){return eT(this.K.delete())}}class ev extends D{constructor(e,t){super(N.UNAVAILABLE,`IndexedDB transaction '${e}' failed: ${t}`),this.name="IndexedDbTransactionError"}}function eI(e){return"IndexedDbTransactionError"===e.name}class e_{constructor(e){this.store=e}put(e,t){let n;return void 0!==t?(_(em,"PUT",this.store.name,e,t),n=this.store.put(t,e)):(_(em,"PUT",this.store.name,"<auto-key>",e),n=this.store.put(e)),eT(n)}add(e){return _(em,"ADD",this.store.name,e,e),eT(this.store.add(e))}get(e){return eT(this.store.get(e)).next(t=>(void 0===t&&(t=null),_(em,"GET",this.store.name,e,t),t))}delete(e){return _(em,"DELETE",this.store.name,e),eT(this.store.delete(e))}count(){return _(em,"COUNT",this.store.name),eT(this.store.count())}J(e,t){let n=this.options(e,t),r=n.index?this.store.index(n.index):this.store;if("function"==typeof r.getAll){let e=r.getAll(n.range);return new ef((t,n)=>{e.onerror=e=>{n(e.target.error)},e.onsuccess=e=>{t(e.target.result)}})}{let e=this.cursor(n),t=[];return this.Y(e,(e,n)=>{t.push(n)}).next(()=>t)}}Z(e,t){let n=this.store.getAll(e,null===t?void 0:t);return new ef((e,t)=>{n.onerror=e=>{t(e.target.error)},n.onsuccess=t=>{e(t.target.result)}})}X(e,t){_(em,"DELETE ALL",this.store.name);let n=this.options(e,t);n.ee=!1;let r=this.cursor(n);return this.Y(r,(e,t,n)=>n.delete())}te(e,t){let n;t?n=e:(n={},t=e);let r=this.cursor(n);return this.Y(r,t)}ne(e){let t=this.cursor({});return new ef((n,r)=>{t.onerror=e=>{r(eE(e.target.error))},t.onsuccess=t=>{let r=t.target.result;r?e(r.primaryKey,r.value).next(e=>{e?r.continue():n()}):n()}})}Y(e,t){let n=[];return new ef((r,i)=>{e.onerror=e=>{i(e.target.error)},e.onsuccess=e=>{let i=e.target.result;if(!i)return void r();let s=new ew(i),a=t(i.primaryKey,i.value,s);if(a instanceof ef){let e=a.catch(e=>(s.done(),ef.reject(e)));n.push(e)}s.isDone?r():null===s.j?i.continue():i.continue(s.j)}}).next(()=>ef.waitFor(n))}options(e,t){let n;return void 0!==e&&("string"==typeof e?n=e:t=e),{index:n,range:t}}cursor(e){let t="next";if(e.reverse&&(t="prev"),e.index){let n=this.store.index(e.index);return e.ee?n.openKeyCursor(e.range,t):n.openCursor(e.range,t)}return this.store.openCursor(e.range,t)}}function eT(e){return new ef((t,n)=>{e.onsuccess=e=>{t(e.target.result)},e.onerror=e=>{n(eE(e.target.error))}})}let eb=!1;function eE(e){let t=ep.M(d.getUA());if(t>=12.2&&t<13){let t="An internal error was encountered in the Indexed Database server";if(e.message.indexOf(t)>=0){let e=new D("internal",`IOS_INDEXEDDB_BUG1: IndexedDb has thrown '${t}'. This is likely due to an unavoidable bug in iOS. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.`);return eb||(eb=!0,setTimeout(()=>{throw e},0)),e}}return e}let ex="IndexBackfiller";class eS{constructor(e,t){this.asyncQueue=e,this.re=t,this.task=null}start(){this.ie(15e3)}stop(){this.task&&(this.task.cancel(),this.task=null)}get started(){return null!==this.task}ie(e){_(ex,`Scheduled in ${e}ms`),this.task=this.asyncQueue.enqueueAfterDelay("index_backfill",e,async()=>{this.task=null;try{let e=await this.re.se();_(ex,`Documents written: ${e}`)}catch(e){eI(e)?_(ex,"Ignoring IndexedDB error during index backfill: ",e):await ed(e)}await this.ie(6e4)})}}class eC{constructor(e,t){this.localStore=e,this.persistence=t}async se(e=50){return this.persistence.runTransaction("Backfill Indexes","readwrite-primary",t=>this.oe(t,e))}oe(e,t){let n=new Set,r=t,i=!0;return ef.doWhile(()=>!0===i&&r>0,()=>this.localStore.indexManager.getNextCollectionGroupToUpdate(e).next(t=>{if(null!==t&&!n.has(t))return _(ex,`Processing collection: ${t}`),this._e(e,t,r).next(e=>{r-=e,n.add(t)});i=!1})).next(()=>t-r)}_e(e,t,n){return this.localStore.indexManager.getMinOffsetFromCollectionGroup(e,t).next(r=>this.localStore.localDocuments.getNextDocuments(e,t,r,n).next(n=>{let i=n.changes;return this.localStore.indexManager.updateIndexEntries(e,i).next(()=>this.ae(r,n)).next(n=>(_(ex,`Updating offset: ${n}`),this.localStore.indexManager.updateCollectionGroup(e,t,n))).next(()=>i.size)}))}ae(e,t){let n=e;return t.changes.forEach((e,t)=>{let r=eo(t);eu(r,n)>0&&(n=r)}),new el(n.readTime,n.documentKey,Math.max(t.batchId,e.largestBatchId))}}class eN{constructor(e,t){this.previousValue=e,t&&(t.sequenceNumberHandler=e=>this.ue(e),this.ce=e=>t.writeSequenceNumber(e))}ue(e){return this.previousValue=Math.max(e,this.previousValue),this.previousValue}next(){let e=++this.previousValue;return this.ce&&this.ce(e),e}}function eD(e){return null==e}function eA(e){return 0===e&&1/e==-1/0}function ek(e){return"number"==typeof e&&Number.isInteger(e)&&!eA(e)&&e<=Number.MAX_SAFE_INTEGER&&e>=Number.MIN_SAFE_INTEGER}function eR(e){let t="";for(let n=0;n<e.length;n++)t.length>0&&(t+="\x01\x01"),t=function(e,t){let n=t,r=e.length;for(let t=0;t<r;t++){let r=e.charAt(t);switch(r){case"\0":n+="\x01\x10";break;case"\x01":n+="\x01\x11";break;default:n+=r}}return n}(e.get(n),t);return t+"\x01\x01"}eN.le=-1;function eM(e){let t=e.length;if(C(t>=2,64408,{path:e}),2===t)return C("\x01"===e.charAt(0)&&"\x01"===e.charAt(1),56145,{path:e}),Y.emptyPath();let n=t-2,r=[],i="";for(let s=0;s<t;){let t=e.indexOf("\x01",s);switch((t<0||t>n)&&x(50515,{path:e}),e.charAt(t+1)){case"\x01":let a,o=e.substring(s,t);0===i.length?a=o:(i+=o,a=i,i=""),r.push(a);break;case"\x10":i+=e.substring(s,t),i+="\0";break;case"\x11":i+=e.substring(s,t+1);break;default:x(61167,{path:e})}s=t+2}return new Y(r)}let eF="remoteDocuments",eV="owner",eL="owner",eP="mutationQueues",eO="mutations",eq="batchId",eU="userMutationsIndex",eB=["userId","batchId"],ez={},e$="documentMutations",eK="remoteDocumentsV14",eG=["prefixPath","collectionGroup","readTime","documentId"],eQ="documentKeyIndex",ej=["prefixPath","collectionGroup","documentId"],eW="collectionGroupIndex",eH=["collectionGroup","readTime","prefixPath","documentId"],eY="remoteDocumentGlobal",eJ="remoteDocumentGlobalKey",eX="targets",eZ="queryTargetsIndex",e0=["canonicalId","targetId"],e1="targetDocuments",e2=["targetId","path"],e5="documentTargetsIndex",e4=["path","targetId"],e3="targetGlobalKey",e6="targetGlobal",e8="collectionParents",e9=["collectionId","parent"],e7="clientMetadata",te="bundles",tt="namedQueries",tn="indexConfiguration",tr="collectionGroupIndex",ti="indexState",ts=["indexId","uid"],ta="sequenceNumberIndex",to=["uid","sequenceNumber"],tl="indexEntries",tu=["indexId","uid","arrayValue","directionalValue","orderedDocumentKey","documentKey"],tc="documentKeyIndex",th=["indexId","uid","orderedDocumentKey"],td="documentOverlays",tf=["userId","collectionPath","documentId"],tm="collectionPathOverlayIndex",tg=["userId","collectionPath","largestBatchId"],tp="collectionGroupOverlayIndex",ty=["userId","collectionGroup","largestBatchId"],tw="globals",tv=[eP,eO,e$,eF,eX,eV,e6,e1,e7,eY,e8,te,tt],tI=[...tv,td],t_=[eP,eO,e$,eK,eX,eV,e6,e1,e7,eY,e8,te,tt,td],tT=[...t_,tn,ti,tl],tb=[...tT,tw];class tE extends eh{constructor(e,t){super(),this.he=e,this.currentSequenceNumber=t}}function tx(e,t){return ep.N(e.he,t)}function tS(e){let t=0;for(let n in e)Object.prototype.hasOwnProperty.call(e,n)&&t++;return t}function tC(e,t){for(let n in e)Object.prototype.hasOwnProperty.call(e,n)&&t(n,e[n])}function tN(e,t){let n=[];for(let r in e)Object.prototype.hasOwnProperty.call(e,r)&&n.push(t(e[r],r,e));return n}function tD(e){for(let t in e)if(Object.prototype.hasOwnProperty.call(e,t))return!1;return!0}class tA{constructor(e,t){this.comparator=e,this.root=t||tR.EMPTY}insert(e,t){return new tA(this.comparator,this.root.insert(e,t,this.comparator).copy(null,null,tR.BLACK,null,null))}remove(e){return new tA(this.comparator,this.root.remove(e,this.comparator).copy(null,null,tR.BLACK,null,null))}get(e){let t=this.root;for(;!t.isEmpty();){let n=this.comparator(e,t.key);if(0===n)return t.value;n<0?t=t.left:n>0&&(t=t.right)}return null}indexOf(e){let t=0,n=this.root;for(;!n.isEmpty();){let r=this.comparator(e,n.key);if(0===r)return t+n.left.size;r<0?n=n.left:(t+=n.left.size+1,n=n.right)}return -1}isEmpty(){return this.root.isEmpty()}get size(){return this.root.size}minKey(){return this.root.minKey()}maxKey(){return this.root.maxKey()}inorderTraversal(e){return this.root.inorderTraversal(e)}forEach(e){this.inorderTraversal((t,n)=>(e(t,n),!1))}toString(){let e=[];return this.inorderTraversal((t,n)=>(e.push(`${t}:${n}`),!1)),`{${e.join(", ")}}`}reverseTraversal(e){return this.root.reverseTraversal(e)}getIterator(){return new tk(this.root,null,this.comparator,!1)}getIteratorFrom(e){return new tk(this.root,e,this.comparator,!1)}getReverseIterator(){return new tk(this.root,null,this.comparator,!0)}getReverseIteratorFrom(e){return new tk(this.root,e,this.comparator,!0)}}class tk{constructor(e,t,n,r){this.isReverse=r,this.nodeStack=[];let i=1;for(;!e.isEmpty();)if(i=t?n(e.key,t):1,t&&r&&(i*=-1),i<0)e=this.isReverse?e.left:e.right;else{if(0===i){this.nodeStack.push(e);break}this.nodeStack.push(e),e=this.isReverse?e.right:e.left}}getNext(){let e=this.nodeStack.pop(),t={key:e.key,value:e.value};if(this.isReverse)for(e=e.left;!e.isEmpty();)this.nodeStack.push(e),e=e.right;else for(e=e.right;!e.isEmpty();)this.nodeStack.push(e),e=e.left;return t}hasNext(){return this.nodeStack.length>0}peek(){if(0===this.nodeStack.length)return null;let e=this.nodeStack[this.nodeStack.length-1];return{key:e.key,value:e.value}}}class tR{constructor(e,t,n,r,i){this.key=e,this.value=t,this.color=null!=n?n:tR.RED,this.left=null!=r?r:tR.EMPTY,this.right=null!=i?i:tR.EMPTY,this.size=this.left.size+1+this.right.size}copy(e,t,n,r,i){return new tR(null!=e?e:this.key,null!=t?t:this.value,null!=n?n:this.color,null!=r?r:this.left,null!=i?i:this.right)}isEmpty(){return!1}inorderTraversal(e){return this.left.inorderTraversal(e)||e(this.key,this.value)||this.right.inorderTraversal(e)}reverseTraversal(e){return this.right.reverseTraversal(e)||e(this.key,this.value)||this.left.reverseTraversal(e)}min(){return this.left.isEmpty()?this:this.left.min()}minKey(){return this.min().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(e,t,n){let r=this,i=n(e,r.key);return(r=i<0?r.copy(null,null,null,r.left.insert(e,t,n),null):0===i?r.copy(null,t,null,null,null):r.copy(null,null,null,null,r.right.insert(e,t,n))).fixUp()}removeMin(){if(this.left.isEmpty())return tR.EMPTY;let e=this;return e.left.isRed()||e.left.left.isRed()||(e=e.moveRedLeft()),(e=e.copy(null,null,null,e.left.removeMin(),null)).fixUp()}remove(e,t){let n,r=this;if(0>t(e,r.key))r.left.isEmpty()||r.left.isRed()||r.left.left.isRed()||(r=r.moveRedLeft()),r=r.copy(null,null,null,r.left.remove(e,t),null);else{if(r.left.isRed()&&(r=r.rotateRight()),r.right.isEmpty()||r.right.isRed()||r.right.left.isRed()||(r=r.moveRedRight()),0===t(e,r.key)){if(r.right.isEmpty())return tR.EMPTY;n=r.right.min(),r=r.copy(n.key,n.value,null,null,r.right.removeMin())}r=r.copy(null,null,null,null,r.right.remove(e,t))}return r.fixUp()}isRed(){return this.color}fixUp(){let e=this;return e.right.isRed()&&!e.left.isRed()&&(e=e.rotateLeft()),e.left.isRed()&&e.left.left.isRed()&&(e=e.rotateRight()),e.left.isRed()&&e.right.isRed()&&(e=e.colorFlip()),e}moveRedLeft(){let e=this.colorFlip();return e.right.left.isRed()&&(e=(e=(e=e.copy(null,null,null,null,e.right.rotateRight())).rotateLeft()).colorFlip()),e}moveRedRight(){let e=this.colorFlip();return e.left.left.isRed()&&(e=(e=e.rotateRight()).colorFlip()),e}rotateLeft(){let e=this.copy(null,null,tR.RED,null,this.right.left);return this.right.copy(null,null,this.color,e,null)}rotateRight(){let e=this.copy(null,null,tR.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,e)}colorFlip(){let e=this.left.copy(null,null,!this.left.color,null,null),t=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,e,t)}checkMaxDepth(){return Math.pow(2,this.check())<=this.size+1}check(){if(this.isRed()&&this.left.isRed())throw x(43730,{key:this.key,value:this.value});if(this.right.isRed())throw x(14113,{key:this.key,value:this.value});let e=this.left.check();if(e!==this.right.check())throw x(27949);return e+ +!this.isRed()}}tR.EMPTY=null,tR.RED=!0,tR.BLACK=!1,tR.EMPTY=new class{constructor(){this.size=0}get key(){throw x(57766)}get value(){throw x(16141)}get color(){throw x(16727)}get left(){throw x(29726)}get right(){throw x(36894)}copy(e,t,n,r,i){return this}insert(e,t,n){return new tR(e,t)}remove(e,t){return this}isEmpty(){return!0}inorderTraversal(e){return!1}reverseTraversal(e){return!1}minKey(){return null}maxKey(){return null}isRed(){return!1}checkMaxDepth(){return!0}check(){return 0}};class tM{constructor(e){this.comparator=e,this.data=new tA(this.comparator)}has(e){return null!==this.data.get(e)}first(){return this.data.minKey()}last(){return this.data.maxKey()}get size(){return this.data.size}indexOf(e){return this.data.indexOf(e)}forEach(e){this.data.inorderTraversal((t,n)=>(e(t),!1))}forEachInRange(e,t){let n=this.data.getIteratorFrom(e[0]);for(;n.hasNext();){let r=n.getNext();if(this.comparator(r.key,e[1])>=0)return;t(r.key)}}forEachWhile(e,t){let n;for(n=void 0!==t?this.data.getIteratorFrom(t):this.data.getIterator();n.hasNext();)if(!e(n.getNext().key))return}firstAfterOrEqual(e){let t=this.data.getIteratorFrom(e);return t.hasNext()?t.getNext().key:null}getIterator(){return new tF(this.data.getIterator())}getIteratorFrom(e){return new tF(this.data.getIteratorFrom(e))}add(e){return this.copy(this.data.remove(e).insert(e,!0))}delete(e){return this.has(e)?this.copy(this.data.remove(e)):this}isEmpty(){return this.data.isEmpty()}unionWith(e){let t=this;return t.size<e.size&&(t=e,e=this),e.forEach(e=>{t=t.add(e)}),t}isEqual(e){if(!(e instanceof tM)||this.size!==e.size)return!1;let t=this.data.getIterator(),n=e.data.getIterator();for(;t.hasNext();){let e=t.getNext().key,r=n.getNext().key;if(0!==this.comparator(e,r))return!1}return!0}toArray(){let e=[];return this.forEach(t=>{e.push(t)}),e}toString(){let e=[];return this.forEach(t=>e.push(t)),"SortedSet("+e.toString()+")"}copy(e){let t=new tM(this.comparator);return t.data=e,t}}class tF{constructor(e){this.iter=e}getNext(){return this.iter.getNext().key}hasNext(){return this.iter.hasNext()}}function tV(e){return e.hasNext()?e.getNext():void 0}class tL{constructor(e){this.fields=e,e.sort(X.comparator)}static empty(){return new tL([])}unionWith(e){let t=new tM(X.comparator);for(let e of this.fields)t=t.add(e);for(let n of e)t=t.add(n);return new tL(t.toArray())}covers(e){for(let t of this.fields)if(t.isPrefixOf(e))return!0;return!1}isEqual(e){return G(this.fields,e.fields,(e,t)=>e.isEqual(t))}}class tP extends Error{constructor(){super(...arguments),this.name="Base64DecodeError"}}class tO{constructor(e){this.binaryString=e}static fromBase64String(e){return new tO(function(e){try{return atob(e)}catch(e){throw"undefined"!=typeof DOMException&&e instanceof DOMException?new tP("Invalid base64 string: "+e):e}}(e))}static fromUint8Array(e){return new tO(function(e){let t="";for(let n=0;n<e.length;++n)t+=String.fromCharCode(e[n]);return t}(e))}[Symbol.iterator](){let e=0;return{next:()=>e<this.binaryString.length?{value:this.binaryString.charCodeAt(e++),done:!1}:{value:void 0,done:!0}}}toBase64(){return btoa(this.binaryString)}toUint8Array(){var e=this.binaryString;let t=new Uint8Array(e.length);for(let n=0;n<e.length;n++)t[n]=e.charCodeAt(n);return t}approximateByteSize(){return 2*this.binaryString.length}compareTo(e){return z(this.binaryString,e.binaryString)}isEqual(e){return this.binaryString===e.binaryString}}tO.EMPTY_BYTE_STRING=new tO("");let tq=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function tU(e){if(C(!!e,39018),"string"==typeof e){let t=0,n=tq.exec(e);if(C(!!n,46558,{timestamp:e}),n[1]){let e=n[1];t=Number(e=(e+"000000000").substr(0,9))}return{seconds:Math.floor(new Date(e).getTime()/1e3),nanos:t}}return{seconds:tB(e.seconds),nanos:tB(e.nanos)}}function tB(e){return"number"==typeof e?e:"string"==typeof e?Number(e):0}function tz(e){return"string"==typeof e?tO.fromBase64String(e):tO.fromUint8Array(e)}let t$="server_timestamp",tK="__type__",tG="__previous_value__",tQ="__local_write_time__";function tj(e){var t,n;return(null==(n=((null==(t=null==e?void 0:e.mapValue)?void 0:t.fields)||{})[tK])?void 0:n.stringValue)===t$}function tW(e){let t=e.mapValue.fields[tG];return tj(t)?tW(t):t}function tH(e){let t=tU(e.mapValue.fields[tQ].timestampValue);return new Q(t.seconds,t.nanos)}class tY{constructor(e,t,n,r,i,s,a,o,l,u){this.databaseId=e,this.appId=t,this.persistenceKey=n,this.host=r,this.ssl=i,this.forceLongPolling=s,this.autoDetectLongPolling=a,this.longPollingOptions=o,this.useFetchStreams=l,this.isUsingEmulator=u}}let tJ="(default)";class tX{constructor(e,t){this.projectId=e,this.database=t||tJ}static empty(){return new tX("","")}get isDefaultDatabase(){return this.database===tJ}isEqual(e){return e instanceof tX&&e.projectId===this.projectId&&e.database===this.database}}let tZ="__type__",t0="__max__",t1={mapValue:{fields:{__type__:{stringValue:t0}}}},t2="__vector__",t5="value",t4={nullValue:"NULL_VALUE"};function t3(e){return"nullValue"in e?0:"booleanValue"in e?1:"integerValue"in e||"doubleValue"in e?2:"timestampValue"in e?3:"stringValue"in e?5:"bytesValue"in e?6:"referenceValue"in e?7:"geoPointValue"in e?8:"arrayValue"in e?9:"mapValue"in e?tj(e)?4:nc(e)?0x1fffffffffffff:nl(e)?10:11:x(28295,{value:e})}function t6(e,t){if(e===t)return!0;let n=t3(e);if(n!==t3(t))return!1;switch(n){case 0:case 0x1fffffffffffff:return!0;case 1:return e.booleanValue===t.booleanValue;case 4:return tH(e).isEqual(tH(t));case 3:if("string"==typeof e.timestampValue&&"string"==typeof t.timestampValue&&e.timestampValue.length===t.timestampValue.length)return e.timestampValue===t.timestampValue;let r=tU(e.timestampValue),i=tU(t.timestampValue);return r.seconds===i.seconds&&r.nanos===i.nanos;case 5:return e.stringValue===t.stringValue;case 6:return tz(e.bytesValue).isEqual(tz(t.bytesValue));case 7:return e.referenceValue===t.referenceValue;case 8:return tB(e.geoPointValue.latitude)===tB(t.geoPointValue.latitude)&&tB(e.geoPointValue.longitude)===tB(t.geoPointValue.longitude);case 2:if("integerValue"in e&&"integerValue"in t)return tB(e.integerValue)===tB(t.integerValue);if("doubleValue"in e&&"doubleValue"in t){let n=tB(e.doubleValue),r=tB(t.doubleValue);return n===r?eA(n)===eA(r):isNaN(n)&&isNaN(r)}return!1;case 9:return G(e.arrayValue.values||[],t.arrayValue.values||[],t6);case 10:case 11:let s=e.mapValue.fields||{},a=t.mapValue.fields||{};if(tS(s)!==tS(a))return!1;for(let e in s)if(s.hasOwnProperty(e)&&(void 0===a[e]||!t6(s[e],a[e])))return!1;return!0;default:return x(52216,{left:e})}}function t8(e,t){return void 0!==(e.values||[]).find(e=>t6(e,t))}function t9(e,t){if(e===t)return 0;let n=t3(e),r=t3(t);if(n!==r)return z(n,r);switch(n){case 0:case 0x1fffffffffffff:return 0;case 1:return z(e.booleanValue,t.booleanValue);case 2:let i=tB(e.integerValue||e.doubleValue),s=tB(t.integerValue||t.doubleValue);return i<s?-1:i>s?1:i===s?0:isNaN(i)?isNaN(s)?0:-1:1;case 3:return t7(e.timestampValue,t.timestampValue);case 4:return t7(tH(e),tH(t));case 5:return $(e.stringValue,t.stringValue);case 6:return function(e,t){let n=tz(e),r=tz(t);return n.compareTo(r)}(e.bytesValue,t.bytesValue);case 7:return function(e,t){let n=e.split("/"),r=t.split("/");for(let e=0;e<n.length&&e<r.length;e++){let t=z(n[e],r[e]);if(0!==t)return t}return z(n.length,r.length)}(e.referenceValue,t.referenceValue);case 8:return function(e,t){let n=z(tB(e.latitude),tB(t.latitude));return 0!==n?n:z(tB(e.longitude),tB(t.longitude))}(e.geoPointValue,t.geoPointValue);case 9:return ne(e.arrayValue,t.arrayValue);case 10:return function(e,t){var n,r,i,s;let a=e.fields||{},o=t.fields||{},l=null==(n=a[t5])?void 0:n.arrayValue,u=null==(r=o[t5])?void 0:r.arrayValue,c=z((null==(i=null==l?void 0:l.values)?void 0:i.length)||0,(null==(s=null==u?void 0:u.values)?void 0:s.length)||0);return 0!==c?c:ne(l,u)}(e.mapValue,t.mapValue);case 11:return function(e,t){if(e===t1.mapValue&&t===t1.mapValue)return 0;if(e===t1.mapValue)return 1;if(t===t1.mapValue)return -1;let n=e.fields||{},r=Object.keys(n),i=t.fields||{},s=Object.keys(i);r.sort(),s.sort();for(let e=0;e<r.length&&e<s.length;++e){let t=$(r[e],s[e]);if(0!==t)return t;let a=t9(n[r[e]],i[s[e]]);if(0!==a)return a}return z(r.length,s.length)}(e.mapValue,t.mapValue);default:throw x(23264,{Pe:n})}}function t7(e,t){if("string"==typeof e&&"string"==typeof t&&e.length===t.length)return z(e,t);let n=tU(e),r=tU(t),i=z(n.seconds,r.seconds);return 0!==i?i:z(n.nanos,r.nanos)}function ne(e,t){let n=e.values||[],r=t.values||[];for(let e=0;e<n.length&&e<r.length;++e){let t=t9(n[e],r[e]);if(t)return t}return z(n.length,r.length)}function nt(e){var t,n;return"nullValue"in e?"null":"booleanValue"in e?""+e.booleanValue:"integerValue"in e?""+e.integerValue:"doubleValue"in e?""+e.doubleValue:"timestampValue"in e?function(e){let t=tU(e);return`time(${t.seconds},${t.nanos})`}(e.timestampValue):"stringValue"in e?e.stringValue:"bytesValue"in e?tz(e.bytesValue).toBase64():"referenceValue"in e?(t=e.referenceValue,Z.fromName(t).toString()):"geoPointValue"in e?(n=e.geoPointValue,`geo(${n.latitude},${n.longitude})`):"arrayValue"in e?function(e){let t="[",n=!0;for(let r of e.values||[])n?n=!1:t+=",",t+=nt(r);return t+"]"}(e.arrayValue):"mapValue"in e?function(e){let t=Object.keys(e.fields||{}).sort(),n="{",r=!0;for(let i of t)r?r=!1:n+=",",n+=`${i}:${nt(e.fields[i])}`;return n+"}"}(e.mapValue):x(61005,{value:e})}function nn(e,t){return{referenceValue:`projects/${e.projectId}/databases/${e.database}/documents/${t.path.canonicalString()}`}}function nr(e){return!!e&&"integerValue"in e}function ni(e){return!!e&&"arrayValue"in e}function ns(e){return!!e&&"nullValue"in e}function na(e){return!!e&&"doubleValue"in e&&isNaN(Number(e.doubleValue))}function no(e){return!!e&&"mapValue"in e}function nl(e){var t,n;return(null==(n=((null==(t=null==e?void 0:e.mapValue)?void 0:t.fields)||{})[tZ])?void 0:n.stringValue)===t2}function nu(e){if(e.geoPointValue)return{geoPointValue:Object.assign({},e.geoPointValue)};if(e.timestampValue&&"object"==typeof e.timestampValue)return{timestampValue:Object.assign({},e.timestampValue)};if(e.mapValue){let t={mapValue:{fields:{}}};return tC(e.mapValue.fields,(e,n)=>t.mapValue.fields[e]=nu(n)),t}if(e.arrayValue){let t={arrayValue:{values:[]}};for(let n=0;n<(e.arrayValue.values||[]).length;++n)t.arrayValue.values[n]=nu(e.arrayValue.values[n]);return t}return Object.assign({},e)}function nc(e){return(((e.mapValue||{}).fields||{}).__type__||{}).stringValue===t0}let nh={mapValue:{fields:{[tZ]:{stringValue:t2},[t5]:{arrayValue:{}}}}};function nd(e,t){let n=t9(e.value,t.value);return 0!==n?n:e.inclusive&&!t.inclusive?-1:!e.inclusive&&t.inclusive?1:0}function nf(e,t){let n=t9(e.value,t.value);return 0!==n?n:e.inclusive&&!t.inclusive?1:!e.inclusive&&t.inclusive?-1:0}class nm{constructor(e){this.value=e}static empty(){return new nm({mapValue:{}})}field(e){if(e.isEmpty())return this.value;{let t=this.value;for(let n=0;n<e.length-1;++n)if(!no(t=(t.mapValue.fields||{})[e.get(n)]))return null;return(t=(t.mapValue.fields||{})[e.lastSegment()])||null}}set(e,t){this.getFieldsMap(e.popLast())[e.lastSegment()]=nu(t)}setAll(e){let t=X.emptyPath(),n={},r=[];e.forEach((e,i)=>{if(!t.isImmediateParentOf(i)){let e=this.getFieldsMap(t);this.applyChanges(e,n,r),n={},r=[],t=i.popLast()}e?n[i.lastSegment()]=nu(e):r.push(i.lastSegment())});let i=this.getFieldsMap(t);this.applyChanges(i,n,r)}delete(e){let t=this.field(e.popLast());no(t)&&t.mapValue.fields&&delete t.mapValue.fields[e.lastSegment()]}isEqual(e){return t6(this.value,e.value)}getFieldsMap(e){let t=this.value;t.mapValue.fields||(t.mapValue={fields:{}});for(let n=0;n<e.length;++n){let r=t.mapValue.fields[e.get(n)];no(r)&&r.mapValue.fields||(r={mapValue:{fields:{}}},t.mapValue.fields[e.get(n)]=r),t=r}return t.mapValue.fields}applyChanges(e,t,n){for(let r of(tC(t,(t,n)=>e[t]=n),n))delete e[r]}clone(){return new nm(nu(this.value))}}class ng{constructor(e,t,n,r,i,s,a){this.key=e,this.documentType=t,this.version=n,this.readTime=r,this.createTime=i,this.data=s,this.documentState=a}static newInvalidDocument(e){return new ng(e,0,j.min(),j.min(),j.min(),nm.empty(),0)}static newFoundDocument(e,t,n,r){return new ng(e,1,t,j.min(),n,r,0)}static newNoDocument(e,t){return new ng(e,2,t,j.min(),j.min(),nm.empty(),0)}static newUnknownDocument(e,t){return new ng(e,3,t,j.min(),j.min(),nm.empty(),2)}convertToFoundDocument(e,t){return this.createTime.isEqual(j.min())&&(2===this.documentType||0===this.documentType)&&(this.createTime=e),this.version=e,this.documentType=1,this.data=t,this.documentState=0,this}convertToNoDocument(e){return this.version=e,this.documentType=2,this.data=nm.empty(),this.documentState=0,this}convertToUnknownDocument(e){return this.version=e,this.documentType=3,this.data=nm.empty(),this.documentState=2,this}setHasCommittedMutations(){return this.documentState=2,this}setHasLocalMutations(){return this.documentState=1,this.version=j.min(),this}setReadTime(e){return this.readTime=e,this}get hasLocalMutations(){return 1===this.documentState}get hasCommittedMutations(){return 2===this.documentState}get hasPendingWrites(){return this.hasLocalMutations||this.hasCommittedMutations}isValidDocument(){return 0!==this.documentType}isFoundDocument(){return 1===this.documentType}isNoDocument(){return 2===this.documentType}isUnknownDocument(){return 3===this.documentType}isEqual(e){return e instanceof ng&&this.key.isEqual(e.key)&&this.version.isEqual(e.version)&&this.documentType===e.documentType&&this.documentState===e.documentState&&this.data.isEqual(e.data)}mutableCopy(){return new ng(this.key,this.documentType,this.version,this.readTime,this.createTime,this.data.clone(),this.documentState)}toString(){return`Document(${this.key}, ${this.version}, ${JSON.stringify(this.data.value)}, {createTime: ${this.createTime}}), {documentType: ${this.documentType}}), {documentState: ${this.documentState}})`}}class np{constructor(e,t){this.position=e,this.inclusive=t}}function ny(e,t,n){let r=0;for(let i=0;i<e.position.length;i++){let s=t[i],a=e.position[i];if(r=s.field.isKeyField()?Z.comparator(Z.fromName(a.referenceValue),n.key):t9(a,n.data.field(s.field)),"desc"===s.dir&&(r*=-1),0!==r)break}return r}function nw(e,t){if(null===e)return null===t;if(null===t||e.inclusive!==t.inclusive||e.position.length!==t.position.length)return!1;for(let n=0;n<e.position.length;n++)if(!t6(e.position[n],t.position[n]))return!1;return!0}class nv{constructor(e,t="asc"){this.field=e,this.dir=t}}class nI{}class n_ extends nI{constructor(e,t,n){super(),this.field=e,this.op=t,this.value=n}static create(e,t,n){return e.isKeyField()?"in"===t||"not-in"===t?this.createKeyFieldInFilter(e,t,n):new nN(e,t,n):"array-contains"===t?new nR(e,n):"in"===t?new nM(e,n):"not-in"===t?new nF(e,n):"array-contains-any"===t?new nV(e,n):new n_(e,t,n)}static createKeyFieldInFilter(e,t,n){return"in"===t?new nD(e,n):new nA(e,n)}matches(e){let t=e.data.field(this.field);return"!="===this.op?null!==t&&void 0===t.nullValue&&this.matchesComparison(t9(t,this.value)):null!==t&&t3(this.value)===t3(t)&&this.matchesComparison(t9(t,this.value))}matchesComparison(e){switch(this.op){case"<":return e<0;case"<=":return e<=0;case"==":return 0===e;case"!=":return 0!==e;case">":return e>0;case">=":return e>=0;default:return x(47266,{operator:this.op})}}isInequality(){return["<","<=",">",">=","!=","not-in"].indexOf(this.op)>=0}getFlattenedFilters(){return[this]}getFilters(){return[this]}}class nT extends nI{constructor(e,t){super(),this.filters=e,this.op=t,this.Te=null}static create(e,t){return new nT(e,t)}matches(e){return nb(this)?void 0===this.filters.find(t=>!t.matches(e)):void 0!==this.filters.find(t=>t.matches(e))}getFlattenedFilters(){return null!==this.Te||(this.Te=this.filters.reduce((e,t)=>e.concat(t.getFlattenedFilters()),[])),this.Te}getFilters(){return Object.assign([],this.filters)}}function nb(e){return"and"===e.op}function nE(e){return"or"===e.op}function nx(e){return nS(e)&&nb(e)}function nS(e){for(let t of e.filters)if(t instanceof nT)return!1;return!0}function nC(e,t){let n=e.filters.concat(t);return nT.create(n,e.op)}class nN extends n_{constructor(e,t,n){super(e,t,n),this.key=Z.fromName(n.referenceValue)}matches(e){let t=Z.comparator(e.key,this.key);return this.matchesComparison(t)}}class nD extends n_{constructor(e,t){super(e,"in",t),this.keys=nk("in",t)}matches(e){return this.keys.some(t=>t.isEqual(e.key))}}class nA extends n_{constructor(e,t){super(e,"not-in",t),this.keys=nk("not-in",t)}matches(e){return!this.keys.some(t=>t.isEqual(e.key))}}function nk(e,t){var n;return((null==(n=t.arrayValue)?void 0:n.values)||[]).map(e=>Z.fromName(e.referenceValue))}class nR extends n_{constructor(e,t){super(e,"array-contains",t)}matches(e){let t=e.data.field(this.field);return ni(t)&&t8(t.arrayValue,this.value)}}class nM extends n_{constructor(e,t){super(e,"in",t)}matches(e){let t=e.data.field(this.field);return null!==t&&t8(this.value.arrayValue,t)}}class nF extends n_{constructor(e,t){super(e,"not-in",t)}matches(e){if(t8(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;let t=e.data.field(this.field);return null!==t&&void 0===t.nullValue&&!t8(this.value.arrayValue,t)}}class nV extends n_{constructor(e,t){super(e,"array-contains-any",t)}matches(e){let t=e.data.field(this.field);return!(!ni(t)||!t.arrayValue.values)&&t.arrayValue.values.some(e=>t8(this.value.arrayValue,e))}}class nL{constructor(e,t=null,n=[],r=[],i=null,s=null,a=null){this.path=e,this.collectionGroup=t,this.orderBy=n,this.filters=r,this.limit=i,this.startAt=s,this.endAt=a,this.Ie=null}}function nP(e,t=null,n=[],r=[],i=null,s=null,a=null){return new nL(e,t,n,r,i,s,a)}function nO(e){if(null===e.Ie){let t=e.path.canonicalString();null!==e.collectionGroup&&(t+="|cg:"+e.collectionGroup),t+="|f:",t+=e.filters.map(e=>(function e(t){if(t instanceof n_)return t.field.canonicalString()+t.op.toString()+nt(t.value);if(nx(t))return t.filters.map(t=>e(t)).join(",");{let n=t.filters.map(t=>e(t)).join(",");return`${t.op}(${n})`}})(e)).join(","),t+="|ob:",t+=e.orderBy.map(e=>e.field.canonicalString()+e.dir).join(","),eD(e.limit)||(t+="|l:",t+=e.limit),e.startAt&&(t+="|lb:",t+=e.startAt.inclusive?"b:":"a:",t+=e.startAt.position.map(e=>nt(e)).join(",")),e.endAt&&(t+="|ub:",t+=e.endAt.inclusive?"a:":"b:",t+=e.endAt.position.map(e=>nt(e)).join(",")),e.Ie=t}return e.Ie}function nq(e,t){if(e.limit!==t.limit||e.orderBy.length!==t.orderBy.length)return!1;for(let i=0;i<e.orderBy.length;i++){var n,r;if(n=e.orderBy[i],r=t.orderBy[i],!(n.dir===r.dir&&n.field.isEqual(r.field)))return!1}if(e.filters.length!==t.filters.length)return!1;for(let n=0;n<e.filters.length;n++)if(!function e(t,n){return t instanceof n_?n instanceof n_&&t.op===n.op&&t.field.isEqual(n.field)&&t6(t.value,n.value):t instanceof nT?n instanceof nT&&t.op===n.op&&t.filters.length===n.filters.length&&t.filters.reduce((t,r,i)=>t&&e(r,n.filters[i]),!0):void x(19439)}(e.filters[n],t.filters[n]))return!1;return e.collectionGroup===t.collectionGroup&&!!e.path.isEqual(t.path)&&!!nw(e.startAt,t.startAt)&&nw(e.endAt,t.endAt)}function nU(e){return Z.isDocumentKey(e.path)&&null===e.collectionGroup&&0===e.filters.length}function nB(e,t){return e.filters.filter(e=>e instanceof n_&&e.field.isEqual(t))}function nz(e,t,n){let r=t4,i=!0;for(let n of nB(e,t)){let e=t4,t=!0;switch(n.op){case"<":case"<=":var s;e="nullValue"in(s=n.value)?t4:"booleanValue"in s?{booleanValue:!1}:"integerValue"in s||"doubleValue"in s?{doubleValue:NaN}:"timestampValue"in s?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"stringValue"in s?{stringValue:""}:"bytesValue"in s?{bytesValue:""}:"referenceValue"in s?nn(tX.empty(),Z.empty()):"geoPointValue"in s?{geoPointValue:{latitude:-90,longitude:-180}}:"arrayValue"in s?{arrayValue:{}}:"mapValue"in s?nl(s)?nh:{mapValue:{}}:x(35942,{value:s});break;case"==":case"in":case">=":e=n.value;break;case">":e=n.value,t=!1;break;case"!=":case"not-in":e=t4}0>nd({value:r,inclusive:i},{value:e,inclusive:t})&&(r=e,i=t)}if(null!==n){for(let s=0;s<e.orderBy.length;++s)if(e.orderBy[s].field.isEqual(t)){let e=n.position[s];0>nd({value:r,inclusive:i},{value:e,inclusive:n.inclusive})&&(r=e,i=n.inclusive);break}}return{value:r,inclusive:i}}function n$(e,t,n){let r=t1,i=!0;for(let n of nB(e,t)){let e=t1,t=!0;switch(n.op){case">=":case">":var s;e="nullValue"in(s=n.value)?{booleanValue:!1}:"booleanValue"in s?{doubleValue:NaN}:"integerValue"in s||"doubleValue"in s?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"timestampValue"in s?{stringValue:""}:"stringValue"in s?{bytesValue:""}:"bytesValue"in s?nn(tX.empty(),Z.empty()):"referenceValue"in s?{geoPointValue:{latitude:-90,longitude:-180}}:"geoPointValue"in s?{arrayValue:{}}:"arrayValue"in s?nh:"mapValue"in s?nl(s)?{mapValue:{}}:t1:x(61959,{value:s}),t=!1;break;case"==":case"in":case"<=":e=n.value;break;case"<":e=n.value,t=!1;break;case"!=":case"not-in":e=t1}nf({value:r,inclusive:i},{value:e,inclusive:t})>0&&(r=e,i=t)}if(null!==n){for(let s=0;s<e.orderBy.length;++s)if(e.orderBy[s].field.isEqual(t)){let e=n.position[s];nf({value:r,inclusive:i},{value:e,inclusive:n.inclusive})>0&&(r=e,i=n.inclusive);break}}return{value:r,inclusive:i}}class nK{constructor(e,t=null,n=[],r=[],i=null,s="F",a=null,o=null){this.path=e,this.collectionGroup=t,this.explicitOrderBy=n,this.filters=r,this.limit=i,this.limitType=s,this.startAt=a,this.endAt=o,this.Ee=null,this.de=null,this.Ae=null,this.startAt,this.endAt}}function nG(e){return new nK(e)}function nQ(e){return 0===e.filters.length&&null===e.limit&&null==e.startAt&&null==e.endAt&&(0===e.explicitOrderBy.length||1===e.explicitOrderBy.length&&e.explicitOrderBy[0].field.isKeyField())}function nj(e){return null!==e.collectionGroup}function nW(e){if(null===e.Ee){let t;e.Ee=[];let n=new Set;for(let t of e.explicitOrderBy)e.Ee.push(t),n.add(t.field.canonicalString());let r=e.explicitOrderBy.length>0?e.explicitOrderBy[e.explicitOrderBy.length-1].dir:"asc";(t=new tM(X.comparator),e.filters.forEach(e=>{e.getFlattenedFilters().forEach(e=>{e.isInequality()&&(t=t.add(e.field))})}),t).forEach(t=>{n.has(t.canonicalString())||t.isKeyField()||e.Ee.push(new nv(t,r))}),n.has(X.keyField().canonicalString())||e.Ee.push(new nv(X.keyField(),r))}return e.Ee}function nH(e){return e.de||(e.de=nJ(e,nW(e))),e.de}function nY(e){return e.Ae||(e.Ae=nJ(e,e.explicitOrderBy)),e.Ae}function nJ(e,t){if("F"===e.limitType)return nP(e.path,e.collectionGroup,t,e.filters,e.limit,e.startAt,e.endAt);{t=t.map(e=>{let t="desc"===e.dir?"asc":"desc";return new nv(e.field,t)});let n=e.endAt?new np(e.endAt.position,e.endAt.inclusive):null,r=e.startAt?new np(e.startAt.position,e.startAt.inclusive):null;return nP(e.path,e.collectionGroup,t,e.filters,e.limit,n,r)}}function nX(e,t){let n=e.filters.concat([t]);return new nK(e.path,e.collectionGroup,e.explicitOrderBy.slice(),n,e.limit,e.limitType,e.startAt,e.endAt)}function nZ(e,t,n){return new nK(e.path,e.collectionGroup,e.explicitOrderBy.slice(),e.filters.slice(),t,n,e.startAt,e.endAt)}function n0(e,t){return nq(nH(e),nH(t))&&e.limitType===t.limitType}function n1(e){return`${nO(nH(e))}|lt:${e.limitType}`}function n2(e){var t;let n;return`Query(target=${n=(t=nH(e)).path.canonicalString(),null!==t.collectionGroup&&(n+=" collectionGroup="+t.collectionGroup),t.filters.length>0&&(n+=`, filters: [${t.filters.map(e=>(function e(t){return t instanceof n_?`${t.field.canonicalString()} ${t.op} ${nt(t.value)}`:t instanceof nT?t.op.toString()+" {"+t.getFilters().map(e).join(" ,")+"}":"Filter"})(e)).join(", ")}]`),eD(t.limit)||(n+=", limit: "+t.limit),t.orderBy.length>0&&(n+=`, orderBy: [${t.orderBy.map(e=>`${e.field.canonicalString()} (${e.dir})`).join(", ")}]`),t.startAt&&(n+=", startAt: ",n+=t.startAt.inclusive?"b:":"a:",n+=t.startAt.position.map(e=>nt(e)).join(",")),t.endAt&&(n+=", endAt: ",n+=t.endAt.inclusive?"a:":"b:",n+=t.endAt.position.map(e=>nt(e)).join(",")),`Target(${n})`}; limitType=${e.limitType})`}function n5(e,t){return t.isFoundDocument()&&function(e,t){let n=t.key.path;return null!==e.collectionGroup?t.key.hasCollectionId(e.collectionGroup)&&e.path.isPrefixOf(n):Z.isDocumentKey(e.path)?e.path.isEqual(n):e.path.isImmediateParentOf(n)}(e,t)&&function(e,t){for(let n of nW(e))if(!n.field.isKeyField()&&null===t.data.field(n.field))return!1;return!0}(e,t)&&function(e,t){for(let n of e.filters)if(!n.matches(t))return!1;return!0}(e,t)&&(!e.startAt||!!function(e,t,n){let r=ny(e,t,n);return e.inclusive?r<=0:r<0}(e.startAt,nW(e),t))&&(!e.endAt||!!function(e,t,n){let r=ny(e,t,n);return e.inclusive?r>=0:r>0}(e.endAt,nW(e),t))}function n4(e){return e.collectionGroup||(e.path.length%2==1?e.path.lastSegment():e.path.get(e.path.length-2))}function n3(e){return(t,n)=>{let r=!1;for(let i of nW(e)){let e=function(e,t,n){let r=e.field.isKeyField()?Z.comparator(t.key,n.key):function(e,t,n){let r=t.data.field(e),i=n.data.field(e);return null!==r&&null!==i?t9(r,i):x(42886)}(e.field,t,n);switch(e.dir){case"asc":return r;case"desc":return -1*r;default:return x(19790,{direction:e.dir})}}(i,t,n);if(0!==e)return e;r=r||i.field.isKeyField()}return 0}}class n6{constructor(e,t){this.mapKeyFn=e,this.equalsFn=t,this.inner={},this.innerSize=0}get(e){let t=this.mapKeyFn(e),n=this.inner[t];if(void 0!==n){for(let[t,r]of n)if(this.equalsFn(t,e))return r}}has(e){return void 0!==this.get(e)}set(e,t){let n=this.mapKeyFn(e),r=this.inner[n];if(void 0===r)return this.inner[n]=[[e,t]],void this.innerSize++;for(let n=0;n<r.length;n++)if(this.equalsFn(r[n][0],e))return void(r[n]=[e,t]);r.push([e,t]),this.innerSize++}delete(e){let t=this.mapKeyFn(e),n=this.inner[t];if(void 0===n)return!1;for(let r=0;r<n.length;r++)if(this.equalsFn(n[r][0],e))return 1===n.length?delete this.inner[t]:n.splice(r,1),this.innerSize--,!0;return!1}forEach(e){tC(this.inner,(t,n)=>{for(let[t,r]of n)e(t,r)})}isEmpty(){return tD(this.inner)}size(){return this.innerSize}}let n8=new tA(Z.comparator),n9=new tA(Z.comparator);function n7(...e){let t=n9;for(let n of e)t=t.insert(n.key,n);return t}function re(e){let t=n9;return e.forEach((e,n)=>t=t.insert(e,n.overlayedDocument)),t}function rt(){return new n6(e=>e.toString(),(e,t)=>e.isEqual(t))}let rn=new tA(Z.comparator),rr=new tM(Z.comparator);function ri(...e){let t=rr;for(let n of e)t=t.add(n);return t}let rs=new tM(z);function ra(e,t){if(e.useProto3Json){if(isNaN(t))return{doubleValue:"NaN"};if(t===1/0)return{doubleValue:"Infinity"};if(t===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:eA(t)?"-0":t}}function ro(e){return{integerValue:""+e}}function rl(e,t){return ek(t)?ro(t):ra(e,t)}class ru{constructor(){this._=void 0}}function rc(e,t){return e instanceof rp?nr(t)||t&&"doubleValue"in t?t:{integerValue:0}:null}class rh extends ru{}class rd extends ru{constructor(e){super(),this.elements=e}}function rf(e,t){let n=rw(t);for(let t of e.elements)n.some(e=>t6(e,t))||n.push(t);return{arrayValue:{values:n}}}class rm extends ru{constructor(e){super(),this.elements=e}}function rg(e,t){let n=rw(t);for(let t of e.elements)n=n.filter(e=>!t6(e,t));return{arrayValue:{values:n}}}class rp extends ru{constructor(e,t){super(),this.serializer=e,this.Re=t}}function ry(e){return tB(e.integerValue||e.doubleValue)}function rw(e){return ni(e)&&e.arrayValue.values?e.arrayValue.values.slice():[]}class rv{constructor(e,t){this.field=e,this.transform=t}}class rI{constructor(e,t){this.version=e,this.transformResults=t}}class r_{constructor(e,t){this.updateTime=e,this.exists=t}static none(){return new r_}static exists(e){return new r_(void 0,e)}static updateTime(e){return new r_(e)}get isNone(){return void 0===this.updateTime&&void 0===this.exists}isEqual(e){return this.exists===e.exists&&(this.updateTime?!!e.updateTime&&this.updateTime.isEqual(e.updateTime):!e.updateTime)}}function rT(e,t){return void 0!==e.updateTime?t.isFoundDocument()&&t.version.isEqual(e.updateTime):void 0===e.exists||e.exists===t.isFoundDocument()}class rb{}function rE(e,t){if(!e.hasLocalMutations||t&&0===t.fields.length)return null;if(null===t)return e.isNoDocument()?new rR(e.key,r_.none()):new rC(e.key,e.data,r_.none());{let n=e.data,r=nm.empty(),i=new tM(X.comparator);for(let e of t.fields)if(!i.has(e)){let t=n.field(e);null===t&&e.length>1&&(e=e.popLast(),t=n.field(e)),null===t?r.delete(e):r.set(e,t),i=i.add(e)}return new rN(e.key,r,new tL(i.toArray()),r_.none())}}function rx(e,t,n,r){return e instanceof rC?function(e,t,n,r){if(!rT(e.precondition,t))return n;let i=e.value.clone(),s=rk(e.fieldTransforms,r,t);return i.setAll(s),t.convertToFoundDocument(t.version,i).setHasLocalMutations(),null}(e,t,n,r):e instanceof rN?function(e,t,n,r){if(!rT(e.precondition,t))return n;let i=rk(e.fieldTransforms,r,t),s=t.data;return(s.setAll(rD(e)),s.setAll(i),t.convertToFoundDocument(t.version,s).setHasLocalMutations(),null===n)?null:n.unionWith(e.fieldMask.fields).unionWith(e.fieldTransforms.map(e=>e.field))}(e,t,n,r):rT(e.precondition,t)?(t.convertToNoDocument(t.version).setHasLocalMutations(),null):n}function rS(e,t){var n,r;return e.type===t.type&&!!e.key.isEqual(t.key)&&!!e.precondition.isEqual(t.precondition)&&(n=e.fieldTransforms,r=t.fieldTransforms,!!(void 0===n&&void 0===r||!(!n||!r)&&G(n,r,(e,t)=>{var n,r;return e.field.isEqual(t.field)&&(n=e.transform,r=t.transform,n instanceof rd&&r instanceof rd||n instanceof rm&&r instanceof rm?G(n.elements,r.elements,t6):n instanceof rp&&r instanceof rp?t6(n.Re,r.Re):n instanceof rh&&r instanceof rh)})))&&(0===e.type?e.value.isEqual(t.value):1!==e.type||e.data.isEqual(t.data)&&e.fieldMask.isEqual(t.fieldMask))}class rC extends rb{constructor(e,t,n,r=[]){super(),this.key=e,this.value=t,this.precondition=n,this.fieldTransforms=r,this.type=0}getFieldMask(){return null}}class rN extends rb{constructor(e,t,n,r,i=[]){super(),this.key=e,this.data=t,this.fieldMask=n,this.precondition=r,this.fieldTransforms=i,this.type=1}getFieldMask(){return this.fieldMask}}function rD(e){let t=new Map;return e.fieldMask.fields.forEach(n=>{if(!n.isEmpty()){let r=e.data.field(n);t.set(n,r)}}),t}function rA(e,t,n){let r=new Map;C(e.length===n.length,32656,{Ve:n.length,me:e.length});for(let s=0;s<n.length;s++){var i;let a=e[s],o=a.transform,l=t.data.field(a.field);r.set(a.field,(i=n[s],o instanceof rd?rf(o,l):o instanceof rm?rg(o,l):i))}return r}function rk(e,t,n){let r=new Map;for(let i of e){let e=i.transform,s=n.data.field(i.field);r.set(i.field,e instanceof rh?function(e,t){let n={fields:{[tK]:{stringValue:t$},[tQ]:{timestampValue:{seconds:e.seconds,nanos:e.nanoseconds}}}};return t&&tj(t)&&(t=tW(t)),t&&(n.fields[tG]=t),{mapValue:n}}(t,s):e instanceof rd?rf(e,s):e instanceof rm?rg(e,s):function(e,t){let n=rc(e,t),r=ry(n)+ry(e.Re);return nr(n)&&nr(e.Re)?ro(r):ra(e.serializer,r)}(e,s))}return r}class rR extends rb{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=2,this.fieldTransforms=[]}getFieldMask(){return null}}class rM extends rb{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=3,this.fieldTransforms=[]}getFieldMask(){return null}}class rF{constructor(e,t,n,r){this.batchId=e,this.localWriteTime=t,this.baseMutations=n,this.mutations=r}applyToRemoteDocument(e,t){let n=t.mutationResults;for(let t=0;t<this.mutations.length;t++){let r=this.mutations[t];r.key.isEqual(e.key)&&function(e,t,n){e instanceof rC?function(e,t,n){let r=e.value.clone(),i=rA(e.fieldTransforms,t,n.transformResults);r.setAll(i),t.convertToFoundDocument(n.version,r).setHasCommittedMutations()}(e,t,n):e instanceof rN?function(e,t,n){if(!rT(e.precondition,t))return t.convertToUnknownDocument(n.version);let r=rA(e.fieldTransforms,t,n.transformResults),i=t.data;i.setAll(rD(e)),i.setAll(r),t.convertToFoundDocument(n.version,i).setHasCommittedMutations()}(e,t,n):t.convertToNoDocument(n.version).setHasCommittedMutations()}(r,e,n[t])}}applyToLocalView(e,t){for(let n of this.baseMutations)n.key.isEqual(e.key)&&(t=rx(n,e,t,this.localWriteTime));for(let n of this.mutations)n.key.isEqual(e.key)&&(t=rx(n,e,t,this.localWriteTime));return t}applyToLocalDocumentSet(e,t){let n=rt();return this.mutations.forEach(r=>{let i=e.get(r.key),s=i.overlayedDocument,a=this.applyToLocalView(s,i.mutatedFields),o=rE(s,a=t.has(r.key)?null:a);null!==o&&n.set(r.key,o),s.isValidDocument()||s.convertToNoDocument(j.min())}),n}keys(){return this.mutations.reduce((e,t)=>e.add(t.key),ri())}isEqual(e){return this.batchId===e.batchId&&G(this.mutations,e.mutations,(e,t)=>rS(e,t))&&G(this.baseMutations,e.baseMutations,(e,t)=>rS(e,t))}}class rV{constructor(e,t,n,r){this.batch=e,this.commitVersion=t,this.mutationResults=n,this.docVersions=r}static from(e,t,n){C(e.mutations.length===n.length,58842,{fe:e.mutations.length,ge:n.length});let r=rn,i=e.mutations;for(let e=0;e<i.length;e++)r=r.insert(i[e].key,n[e].version);return new rV(e,t,n,r)}}class rL{constructor(e,t){this.largestBatchId=e,this.mutation=t}getKey(){return this.mutation.key}isEqual(e){return null!==e&&this.mutation===e.mutation}toString(){return`Overlay{
      largestBatchId: ${this.largestBatchId},
      mutation: ${this.mutation.toString()}
    }`}}class rP{constructor(e,t,n){this.alias=e,this.aggregateType=t,this.fieldPath=n}}class rO{constructor(e,t){this.count=e,this.unchangedNames=t}}function rq(e){switch(e){case N.OK:return x(64938);case N.CANCELLED:case N.UNKNOWN:case N.DEADLINE_EXCEEDED:case N.RESOURCE_EXHAUSTED:case N.INTERNAL:case N.UNAVAILABLE:case N.UNAUTHENTICATED:return!1;case N.INVALID_ARGUMENT:case N.NOT_FOUND:case N.ALREADY_EXISTS:case N.PERMISSION_DENIED:case N.FAILED_PRECONDITION:case N.ABORTED:case N.OUT_OF_RANGE:case N.UNIMPLEMENTED:case N.DATA_LOSS:return!0;default:return x(15467,{code:e})}}function rU(e){if(void 0===e)return T("GRPC error has no .code"),N.UNKNOWN;switch(e){case r.OK:return N.OK;case r.CANCELLED:return N.CANCELLED;case r.UNKNOWN:return N.UNKNOWN;case r.DEADLINE_EXCEEDED:return N.DEADLINE_EXCEEDED;case r.RESOURCE_EXHAUSTED:return N.RESOURCE_EXHAUSTED;case r.INTERNAL:return N.INTERNAL;case r.UNAVAILABLE:return N.UNAVAILABLE;case r.UNAUTHENTICATED:return N.UNAUTHENTICATED;case r.INVALID_ARGUMENT:return N.INVALID_ARGUMENT;case r.NOT_FOUND:return N.NOT_FOUND;case r.ALREADY_EXISTS:return N.ALREADY_EXISTS;case r.PERMISSION_DENIED:return N.PERMISSION_DENIED;case r.FAILED_PRECONDITION:return N.FAILED_PRECONDITION;case r.ABORTED:return N.ABORTED;case r.OUT_OF_RANGE:return N.OUT_OF_RANGE;case r.UNIMPLEMENTED:return N.UNIMPLEMENTED;case r.DATA_LOSS:return N.DATA_LOSS;default:return x(39323,{code:e})}}(i=r||(r={}))[i.OK=0]="OK",i[i.CANCELLED=1]="CANCELLED",i[i.UNKNOWN=2]="UNKNOWN",i[i.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",i[i.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",i[i.NOT_FOUND=5]="NOT_FOUND",i[i.ALREADY_EXISTS=6]="ALREADY_EXISTS",i[i.PERMISSION_DENIED=7]="PERMISSION_DENIED",i[i.UNAUTHENTICATED=16]="UNAUTHENTICATED",i[i.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",i[i.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",i[i.ABORTED=10]="ABORTED",i[i.OUT_OF_RANGE=11]="OUT_OF_RANGE",i[i.UNIMPLEMENTED=12]="UNIMPLEMENTED",i[i.INTERNAL=13]="INTERNAL",i[i.UNAVAILABLE=14]="UNAVAILABLE",i[i.DATA_LOSS=15]="DATA_LOSS";let rB=null,rz=new f.Integer([0xffffffff,0xffffffff],0);function r$(e){let t=U().encode(e),n=new f.Md5;return n.update(t),new Uint8Array(n.digest())}function rK(e){let t=new DataView(e.buffer),n=t.getUint32(0,!0),r=t.getUint32(4,!0),i=t.getUint32(8,!0),s=t.getUint32(12,!0);return[new f.Integer([n,r],0),new f.Integer([i,s],0)]}class rG{constructor(e,t,n){if(this.bitmap=e,this.padding=t,this.hashCount=n,t<0||t>=8)throw new rQ(`Invalid padding: ${t}`);if(n<0||e.length>0&&0===this.hashCount)throw new rQ(`Invalid hash count: ${n}`);if(0===e.length&&0!==t)throw new rQ(`Invalid padding when bitmap length is 0: ${t}`);this.pe=8*e.length-t,this.ye=f.Integer.fromNumber(this.pe)}we(e,t,n){let r=e.add(t.multiply(f.Integer.fromNumber(n)));return 1===r.compare(rz)&&(r=new f.Integer([r.getBits(0),r.getBits(1)],0)),r.modulo(this.ye).toNumber()}be(e){return!!(this.bitmap[Math.floor(e/8)]&1<<e%8)}mightContain(e){if(0===this.pe)return!1;let[t,n]=rK(r$(e));for(let e=0;e<this.hashCount;e++){let r=this.we(t,n,e);if(!this.be(r))return!1}return!0}static create(e,t,n){let r=new rG(new Uint8Array(Math.ceil(e/8)),e%8==0?0:8-e%8,t);return n.forEach(e=>r.insert(e)),r}insert(e){if(0===this.pe)return;let[t,n]=rK(r$(e));for(let e=0;e<this.hashCount;e++){let r=this.we(t,n,e);this.Se(r)}}Se(e){let t=Math.floor(e/8);this.bitmap[t]|=1<<e%8}}class rQ extends Error{constructor(){super(...arguments),this.name="BloomFilterError"}}class rj{constructor(e,t,n,r,i){this.snapshotVersion=e,this.targetChanges=t,this.targetMismatches=n,this.documentUpdates=r,this.resolvedLimboDocuments=i}static createSynthesizedRemoteEventForCurrentChange(e,t,n){let r=new Map;return r.set(e,rW.createSynthesizedTargetChangeForCurrentChange(e,t,n)),new rj(j.min(),r,new tA(z),n8,ri())}}class rW{constructor(e,t,n,r,i){this.resumeToken=e,this.current=t,this.addedDocuments=n,this.modifiedDocuments=r,this.removedDocuments=i}static createSynthesizedTargetChangeForCurrentChange(e,t,n){return new rW(n,t,ri(),ri(),ri())}}class rH{constructor(e,t,n,r){this.De=e,this.removedTargetIds=t,this.key=n,this.ve=r}}class rY{constructor(e,t){this.targetId=e,this.Ce=t}}class rJ{constructor(e,t,n=tO.EMPTY_BYTE_STRING,r=null){this.state=e,this.targetIds=t,this.resumeToken=n,this.cause=r}}class rX{constructor(){this.Fe=0,this.Me=r1(),this.xe=tO.EMPTY_BYTE_STRING,this.Oe=!1,this.Ne=!0}get current(){return this.Oe}get resumeToken(){return this.xe}get Be(){return 0!==this.Fe}get Le(){return this.Ne}ke(e){e.approximateByteSize()>0&&(this.Ne=!0,this.xe=e)}qe(){let e=ri(),t=ri(),n=ri();return this.Me.forEach((r,i)=>{switch(i){case 0:e=e.add(r);break;case 2:t=t.add(r);break;case 1:n=n.add(r);break;default:x(38017,{changeType:i})}}),new rW(this.xe,this.Oe,e,t,n)}Qe(){this.Ne=!1,this.Me=r1()}$e(e,t){this.Ne=!0,this.Me=this.Me.insert(e,t)}Ue(e){this.Ne=!0,this.Me=this.Me.remove(e)}Ke(){this.Fe+=1}We(){this.Fe-=1,C(this.Fe>=0,3241,{Fe:this.Fe})}Ge(){this.Ne=!0,this.Oe=!0}}class rZ{constructor(e){this.ze=e,this.je=new Map,this.He=n8,this.Je=r0(),this.Ye=r0(),this.Ze=new tA(z)}Xe(e){for(let t of e.De)e.ve&&e.ve.isFoundDocument()?this.et(t,e.ve):this.tt(t,e.key,e.ve);for(let t of e.removedTargetIds)this.tt(t,e.key,e.ve)}nt(e){this.forEachTarget(e,t=>{let n=this.rt(t);switch(e.state){case 0:this.it(t)&&n.ke(e.resumeToken);break;case 1:n.We(),n.Be||n.Qe(),n.ke(e.resumeToken);break;case 2:n.We(),n.Be||this.removeTarget(t);break;case 3:this.it(t)&&(n.Ge(),n.ke(e.resumeToken));break;case 4:this.it(t)&&(this.st(t),n.ke(e.resumeToken));break;default:x(56790,{state:e.state})}})}forEachTarget(e,t){e.targetIds.length>0?e.targetIds.forEach(t):this.je.forEach((e,n)=>{this.it(n)&&t(n)})}ot(e){let t=e.targetId,n=e.Ce.count,r=this._t(t);if(r){let i=r.target;if(nU(i))if(0===n){let e=new Z(i.path);this.tt(t,e,ng.newNoDocument(e,j.min()))}else C(1===n,20013,{expectedCount:n});else{let r=this.ut(t);if(r!==n){let n=this.ct(e),i=n?this.lt(n,e,r):1;0!==i&&(this.st(t),this.Ze=this.Ze.insert(t,2===i?"TargetPurposeExistenceFilterMismatchBloom":"TargetPurposeExistenceFilterMismatch")),null==rB||rB.ht(function(e,t,n,r,i){var s,a,o,l,u,c;let h={localCacheCount:e,existenceFilterCount:t.count,databaseId:n.database,projectId:n.projectId},d=t.unchangedNames;return d&&(h.bloomFilter={applied:0===i,hashCount:null!=(s=null==d?void 0:d.hashCount)?s:0,bitmapLength:null!=(l=null==(o=null==(a=null==d?void 0:d.bits)?void 0:a.bitmap)?void 0:o.length)?l:0,padding:null!=(c=null==(u=null==d?void 0:d.bits)?void 0:u.padding)?c:0,mightContain:e=>{var t;return null!=(t=null==r?void 0:r.mightContain(e))&&t}}),h}(r,e.Ce,this.ze.Pt(),n,i))}}}}ct(e){let t,n,r=e.Ce.unchangedNames;if(!r||!r.bits)return null;let{bits:{bitmap:i="",padding:s=0},hashCount:a=0}=r;try{t=tz(i).toUint8Array()}catch(e){if(e instanceof tP)return b("Decoding the base64 bloom filter in existence filter failed ("+e.message+"); ignoring the bloom filter and falling back to full re-query."),null;throw e}try{n=new rG(t,s,a)}catch(e){return b(e instanceof rQ?"BloomFilter error: ":"Applying bloom filter failed: ",e),null}return 0===n.pe?null:n}lt(e,t,n){return 2*(t.Ce.count!==n-this.Tt(e,t.targetId))}Tt(e,t){let n=this.ze.getRemoteKeysForTarget(t),r=0;return n.forEach(n=>{let i=this.ze.Pt(),s=`projects/${i.projectId}/databases/${i.database}/documents/${n.path.canonicalString()}`;e.mightContain(s)||(this.tt(t,n,null),r++)}),r}It(e){let t=new Map;this.je.forEach((n,r)=>{let i=this._t(r);if(i){if(n.current&&nU(i.target)){let t=new Z(i.target.path);this.Et(t).has(r)||this.dt(r,t)||this.tt(r,t,ng.newNoDocument(t,e))}n.Le&&(t.set(r,n.qe()),n.Qe())}});let n=ri();this.Ye.forEach((e,t)=>{let r=!0;t.forEachWhile(e=>{let t=this._t(e);return!t||"TargetPurposeLimboResolution"===t.purpose||(r=!1,!1)}),r&&(n=n.add(e))}),this.He.forEach((t,n)=>n.setReadTime(e));let r=new rj(e,t,this.Ze,this.He,n);return this.He=n8,this.Je=r0(),this.Ye=r0(),this.Ze=new tA(z),r}et(e,t){if(!this.it(e))return;let n=2*!!this.dt(e,t.key);this.rt(e).$e(t.key,n),this.He=this.He.insert(t.key,t),this.Je=this.Je.insert(t.key,this.Et(t.key).add(e)),this.Ye=this.Ye.insert(t.key,this.At(t.key).add(e))}tt(e,t,n){if(!this.it(e))return;let r=this.rt(e);this.dt(e,t)?r.$e(t,1):r.Ue(t),this.Ye=this.Ye.insert(t,this.At(t).delete(e)),this.Ye=this.Ye.insert(t,this.At(t).add(e)),n&&(this.He=this.He.insert(t,n))}removeTarget(e){this.je.delete(e)}ut(e){let t=this.rt(e).qe();return this.ze.getRemoteKeysForTarget(e).size+t.addedDocuments.size-t.removedDocuments.size}Ke(e){this.rt(e).Ke()}rt(e){let t=this.je.get(e);return t||(t=new rX,this.je.set(e,t)),t}At(e){let t=this.Ye.get(e);return t||(t=new tM(z),this.Ye=this.Ye.insert(e,t)),t}Et(e){let t=this.Je.get(e);return t||(t=new tM(z),this.Je=this.Je.insert(e,t)),t}it(e){let t=null!==this._t(e);return t||_("WatchChangeAggregator","Detected inactive target",e),t}_t(e){let t=this.je.get(e);return t&&t.Be?null:this.ze.Rt(e)}st(e){this.je.set(e,new rX),this.ze.getRemoteKeysForTarget(e).forEach(t=>{this.tt(e,t,null)})}dt(e,t){return this.ze.getRemoteKeysForTarget(e).has(t)}}function r0(){return new tA(Z.comparator)}function r1(){return new tA(Z.comparator)}let r2={asc:"ASCENDING",desc:"DESCENDING"},r5={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"},r4={and:"AND",or:"OR"};class r3{constructor(e,t){this.databaseId=e,this.useProto3Json=t}}function r6(e,t){return e.useProto3Json||eD(t)?t:{value:t}}function r8(e,t){return e.useProto3Json?`${new Date(1e3*t.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")}.${("000000000"+t.nanoseconds).slice(-9)}Z`:{seconds:""+t.seconds,nanos:t.nanoseconds}}function r9(e,t){return e.useProto3Json?t.toBase64():t.toUint8Array()}function r7(e){return C(!!e,49232),j.fromTimestamp(function(e){let t=tU(e);return new Q(t.seconds,t.nanos)}(e))}function ie(e,t){return it(e,t).canonicalString()}function it(e,t){let n=new Y(["projects",e.projectId,"databases",e.database]).child("documents");return void 0===t?n:n.child(t)}function ir(e){let t=Y.fromString(e);return C(i_(t),10190,{key:t.toString()}),t}function ii(e,t){return ie(e.databaseId,t.path)}function is(e,t){let n=ir(t);if(n.get(1)!==e.databaseId.projectId)throw new D(N.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+n.get(1)+" vs "+e.databaseId.projectId);if(n.get(3)!==e.databaseId.database)throw new D(N.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+n.get(3)+" vs "+e.databaseId.database);return new Z(iu(n))}function ia(e,t){return ie(e.databaseId,t)}function io(e){let t=ir(e);return 4===t.length?Y.emptyPath():iu(t)}function il(e){return new Y(["projects",e.databaseId.projectId,"databases",e.databaseId.database]).canonicalString()}function iu(e){return C(e.length>4&&"documents"===e.get(4),29091,{key:e.toString()}),e.popFirst(5)}function ic(e,t,n){return{name:ii(e,t),fields:n.value.mapValue.fields}}function ih(e,t,n){let r=is(e,t.name),i=r7(t.updateTime),s=t.createTime?r7(t.createTime):j.min(),a=new nm({mapValue:{fields:t.fields}}),o=ng.newFoundDocument(r,i,s,a);return n&&o.setHasCommittedMutations(),n?o.setHasCommittedMutations():o}function id(e,t){var n;let r;if(t instanceof rC)r={update:ic(e,t.key,t.value)};else if(t instanceof rR)r={delete:ii(e,t.key)};else if(t instanceof rN)r={update:ic(e,t.key,t.data),updateMask:function(e){let t=[];return e.fields.forEach(e=>t.push(e.canonicalString())),{fieldPaths:t}}(t.fieldMask)};else{if(!(t instanceof rM))return x(16599,{ft:t.type});r={verify:ii(e,t.key)}}return t.fieldTransforms.length>0&&(r.updateTransforms=t.fieldTransforms.map(e=>(function(e,t){let n=t.transform;if(n instanceof rh)return{fieldPath:t.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(n instanceof rd)return{fieldPath:t.field.canonicalString(),appendMissingElements:{values:n.elements}};if(n instanceof rm)return{fieldPath:t.field.canonicalString(),removeAllFromArray:{values:n.elements}};if(n instanceof rp)return{fieldPath:t.field.canonicalString(),increment:n.Re};throw x(20930,{transform:t.transform})})(0,e))),t.precondition.isNone||(r.currentDocument=void 0!==(n=t.precondition).updateTime?{updateTime:r8(e,n.updateTime.toTimestamp())}:void 0!==n.exists?{exists:n.exists}:x(27497)),r}function im(e,t){var n;let r=t.currentDocument?void 0!==(n=t.currentDocument).updateTime?r_.updateTime(r7(n.updateTime)):void 0!==n.exists?r_.exists(n.exists):r_.none():r_.none(),i=t.updateTransforms?t.updateTransforms.map(t=>{let n;return n=null,"setToServerValue"in t?(C("REQUEST_TIME"===t.setToServerValue,16630,{proto:t}),n=new rh):"appendMissingElements"in t?n=new rd(t.appendMissingElements.values||[]):"removeAllFromArray"in t?n=new rm(t.removeAllFromArray.values||[]):"increment"in t?n=new rp(e,t.increment):x(16584,{proto:t}),new rv(X.fromServerFormat(t.fieldPath),n)}):[];if(t.update){t.update.name;let n=is(e,t.update.name),s=new nm({mapValue:{fields:t.update.fields}});return t.updateMask?new rN(n,s,new tL((t.updateMask.fieldPaths||[]).map(e=>X.fromServerFormat(e))),r,i):new rC(n,s,r,i)}return t.delete?new rR(is(e,t.delete),r):t.verify?new rM(is(e,t.verify),r):x(1463,{proto:t})}function ig(e,t){return{documents:[ia(e,t.path)]}}function ip(e,t){var n,r;let i,s={structuredQuery:{}},a=t.path;null!==t.collectionGroup?(i=a,s.structuredQuery.from=[{collectionId:t.collectionGroup,allDescendants:!0}]):(i=a.popLast(),s.structuredQuery.from=[{collectionId:a.lastSegment()}]),s.parent=ia(e,i);let o=function(e){if(0!==e.length)return function e(t){return t instanceof n_?function(e){if("=="===e.op){if(na(e.value))return{unaryFilter:{field:iv(e.field),op:"IS_NAN"}};if(ns(e.value))return{unaryFilter:{field:iv(e.field),op:"IS_NULL"}}}else if("!="===e.op){if(na(e.value))return{unaryFilter:{field:iv(e.field),op:"IS_NOT_NAN"}};if(ns(e.value))return{unaryFilter:{field:iv(e.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:iv(e.field),op:r5[e.op],value:e.value}}}(t):t instanceof nT?function(t){let n=t.getFilters().map(t=>e(t));return 1===n.length?n[0]:{compositeFilter:{op:r4[t.op],filters:n}}}(t):x(54877,{filter:t})}(nT.create(e,"and"))}(t.filters);o&&(s.structuredQuery.where=o);let l=function(e){if(0!==e.length)return e.map(e=>({field:iv(e.field),direction:r2[e.dir]}))}(t.orderBy);l&&(s.structuredQuery.orderBy=l);let u=r6(e,t.limit);return null!==u&&(s.structuredQuery.limit=u),t.startAt&&(s.structuredQuery.startAt={before:(n=t.startAt).inclusive,values:n.position}),t.endAt&&(s.structuredQuery.endAt={before:!(r=t.endAt).inclusive,values:r.position}),{gt:s,parent:i}}function iy(e,t,n,r){let{gt:i,parent:s}=ip(e,t),a={},o=[],l=0;return n.forEach(e=>{let t=r?e.alias:"aggregate_"+l++;a[t]=e.alias,"count"===e.aggregateType?o.push({alias:t,count:{}}):"avg"===e.aggregateType?o.push({alias:t,avg:{field:iv(e.fieldPath)}}):"sum"===e.aggregateType&&o.push({alias:t,sum:{field:iv(e.fieldPath)}})}),{request:{structuredAggregationQuery:{aggregations:o,structuredQuery:i.structuredQuery},parent:i.parent},yt:a,parent:s}}function iw(e){var t;let n,r=io(e.parent),i=e.structuredQuery,s=i.from?i.from.length:0,a=null;if(s>0){C(1===s,65062);let e=i.from[0];e.allDescendants?a=e.collectionId:r=r.child(e.collectionId)}let o=[];i.where&&(o=function(e){let t=function e(t){return void 0!==t.unaryFilter?function(e){switch(e.unaryFilter.op){case"IS_NAN":let t=iI(e.unaryFilter.field);return n_.create(t,"==",{doubleValue:NaN});case"IS_NULL":let n=iI(e.unaryFilter.field);return n_.create(n,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":let r=iI(e.unaryFilter.field);return n_.create(r,"!=",{doubleValue:NaN});case"IS_NOT_NULL":let i=iI(e.unaryFilter.field);return n_.create(i,"!=",{nullValue:"NULL_VALUE"});case"OPERATOR_UNSPECIFIED":return x(61313);default:return x(60726)}}(t):void 0!==t.fieldFilter?n_.create(iI(t.fieldFilter.field),function(e){switch(e){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";case"OPERATOR_UNSPECIFIED":return x(58110);default:return x(50506)}}(t.fieldFilter.op),t.fieldFilter.value):void 0!==t.compositeFilter?nT.create(t.compositeFilter.filters.map(t=>e(t)),function(e){switch(e){case"AND":return"and";case"OR":return"or";default:return x(1026)}}(t.compositeFilter.op)):x(30097,{filter:t})}(e);return t instanceof nT&&nx(t)?t.getFilters():[t]}(i.where));let l=[];i.orderBy&&(l=i.orderBy.map(e=>new nv(iI(e.field),function(e){switch(e){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}(e.direction))));let u=null;i.limit&&(u=eD(n="object"==typeof(t=i.limit)?t.value:t)?null:n);let c=null;i.startAt&&(c=function(e){let t=!!e.before;return new np(e.values||[],t)}(i.startAt));let h=null;return i.endAt&&(h=function(e){let t=!e.before;return new np(e.values||[],t)}(i.endAt)),new nK(r,a,l,o,u,"F",c,h)}function iv(e){return{fieldPath:e.canonicalString()}}function iI(e){return X.fromServerFormat(e.fieldPath)}function i_(e){return e.length>=4&&"projects"===e.get(0)&&"databases"===e.get(2)}class iT{constructor(e,t,n,r,i=j.min(),s=j.min(),a=tO.EMPTY_BYTE_STRING,o=null){this.target=e,this.targetId=t,this.purpose=n,this.sequenceNumber=r,this.snapshotVersion=i,this.lastLimboFreeSnapshotVersion=s,this.resumeToken=a,this.expectedCount=o}withSequenceNumber(e){return new iT(this.target,this.targetId,this.purpose,e,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,this.expectedCount)}withResumeToken(e,t){return new iT(this.target,this.targetId,this.purpose,this.sequenceNumber,t,this.lastLimboFreeSnapshotVersion,e,null)}withExpectedCount(e){return new iT(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,e)}withLastLimboFreeSnapshotVersion(e){return new iT(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,e,this.resumeToken,this.expectedCount)}}class ib{constructor(e){this.wt=e}}function iE(e,t){let n=t.key,r={prefixPath:n.getCollectionPath().popLast().toArray(),collectionGroup:n.collectionGroup,documentId:n.path.lastSegment(),readTime:ix(t.readTime),hasCommittedMutations:t.hasCommittedMutations};if(t.isFoundDocument()){var i;r.document={name:ii(i=e.wt,t.key),fields:t.data.value.mapValue.fields,updateTime:r8(i,t.version.toTimestamp()),createTime:r8(i,t.createTime.toTimestamp())}}else if(t.isNoDocument())r.noDocument={path:n.path.toArray(),readTime:iS(t.version)};else{if(!t.isUnknownDocument())return x(57904,{document:t});r.unknownDocument={path:n.path.toArray(),version:iS(t.version)}}return r}function ix(e){let t=e.toTimestamp();return[t.seconds,t.nanoseconds]}function iS(e){let t=e.toTimestamp();return{seconds:t.seconds,nanoseconds:t.nanoseconds}}function iC(e){let t=new Q(e.seconds,e.nanoseconds);return j.fromTimestamp(t)}function iN(e,t){let n=(t.baseMutations||[]).map(t=>im(e.wt,t));for(let e=0;e<t.mutations.length-1;++e){let n=t.mutations[e];e+1<t.mutations.length&&void 0!==t.mutations[e+1].transform&&(n.updateTransforms=t.mutations[e+1].transform.fieldTransforms,t.mutations.splice(e+1,1),++e)}let r=t.mutations.map(t=>im(e.wt,t)),i=Q.fromMillis(t.localWriteTimeMs);return new rF(t.batchId,i,n,r)}function iD(e){let t=iC(e.readTime),n=void 0!==e.lastLimboFreeSnapshotVersion?iC(e.lastLimboFreeSnapshotVersion):j.min();return new iT(void 0!==e.query.documents?function(e){let t=e.documents.length;return C(1===t,1966,{count:t}),nH(nG(io(e.documents[0])))}(e.query):nH(iw(e.query)),e.targetId,"TargetPurposeListen",e.lastListenSequenceNumber,t,n,tO.fromBase64String(e.resumeToken))}function iA(e,t){let n,r=iS(t.snapshotVersion),i=iS(t.lastLimboFreeSnapshotVersion);n=nU(t.target)?ig(e.wt,t.target):ip(e.wt,t.target).gt;let s=t.resumeToken.toBase64();return{targetId:t.targetId,canonicalId:nO(t.target),readTime:r,resumeToken:s,lastListenSequenceNumber:t.sequenceNumber,lastLimboFreeSnapshotVersion:i,query:n}}function ik(e){let t=iw({parent:e.parent,structuredQuery:e.structuredQuery});return"LAST"===e.limitType?nZ(t,t.limit,"L"):t}function iR(e,t){return new rL(t.largestBatchId,im(e.wt,t.overlayMutation))}function iM(e,t){let n=t.path.lastSegment();return[e,eR(t.path.popLast()),n]}function iF(e,t,n,r){return{indexId:e,uid:t,sequenceNumber:n,readTime:iS(r.readTime),documentKey:eR(r.documentKey.path),largestBatchId:r.largestBatchId}}class iV{getBundleMetadata(e,t){return tx(e,te).get(t).next(e=>{if(e)return{id:e.bundleId,createTime:iC(e.createTime),version:e.version}})}saveBundleMetadata(e,t){return tx(e,te).put({bundleId:t.id,createTime:iS(r7(t.createTime)),version:t.version})}getNamedQuery(e,t){return tx(e,tt).get(t).next(e=>{if(e)return{name:e.name,query:ik(e.bundledQuery),readTime:iC(e.readTime)}})}saveNamedQuery(e,t){return tx(e,tt).put({name:t.name,readTime:iS(r7(t.readTime)),bundledQuery:t.bundledQuery})}}class iL{constructor(e,t){this.serializer=e,this.userId=t}static bt(e,t){return new iL(e,t.uid||"")}getOverlay(e,t){return tx(e,td).get(iM(this.userId,t)).next(e=>e?iR(this.serializer,e):null)}getOverlays(e,t){let n=rt();return ef.forEach(t,t=>this.getOverlay(e,t).next(e=>{null!==e&&n.set(t,e)})).next(()=>n)}saveOverlays(e,t,n){let r=[];return n.forEach((n,i)=>{let s=new rL(t,i);r.push(this.St(e,s))}),ef.waitFor(r)}removeOverlaysForBatchId(e,t,n){let r=new Set;t.forEach(e=>r.add(eR(e.getCollectionPath())));let i=[];return r.forEach(t=>{let r=IDBKeyRange.bound([this.userId,t,n],[this.userId,t,n+1],!1,!0);i.push(tx(e,td).X(tm,r))}),ef.waitFor(i)}getOverlaysForCollection(e,t,n){let r=rt(),i=eR(t),s=IDBKeyRange.bound([this.userId,i,n],[this.userId,i,Number.POSITIVE_INFINITY],!0);return tx(e,td).J(tm,s).next(e=>{for(let t of e){let e=iR(this.serializer,t);r.set(e.getKey(),e)}return r})}getOverlaysForCollectionGroup(e,t,n,r){let i,s=rt(),a=IDBKeyRange.bound([this.userId,t,n],[this.userId,t,Number.POSITIVE_INFINITY],!0);return tx(e,td).te({index:tp,range:a},(e,t,n)=>{let a=iR(this.serializer,t);s.size()<r||a.largestBatchId===i?(s.set(a.getKey(),a),i=a.largestBatchId):n.done()}).next(()=>s)}St(e,t){return tx(e,td).put(function(e,t,n){let[r,i,s]=iM(t,n.mutation.key);return{userId:t,collectionPath:i,documentId:s,collectionGroup:n.mutation.key.getCollectionGroup(),largestBatchId:n.largestBatchId,overlayMutation:id(e.wt,n.mutation)}}(this.serializer,this.userId,t))}}class iP{Dt(e){return tx(e,tw)}getSessionToken(e){return this.Dt(e).get("sessionToken").next(e=>{let t=null==e?void 0:e.value;return t?tO.fromUint8Array(t):tO.EMPTY_BYTE_STRING})}setSessionToken(e,t){return this.Dt(e).put({name:"sessionToken",value:t.toUint8Array()})}}class iO{constructor(){}vt(e,t){this.Ct(e,t),t.Ft()}Ct(e,t){if("nullValue"in e)this.Mt(t,5);else if("booleanValue"in e)this.Mt(t,10),t.xt(+!!e.booleanValue);else if("integerValue"in e)this.Mt(t,15),t.xt(tB(e.integerValue));else if("doubleValue"in e){let n=tB(e.doubleValue);isNaN(n)?this.Mt(t,13):(this.Mt(t,15),eA(n)?t.xt(0):t.xt(n))}else if("timestampValue"in e){let n=e.timestampValue;this.Mt(t,20),"string"==typeof n&&(n=tU(n)),t.Ot(`${n.seconds||""}`),t.xt(n.nanos||0)}else if("stringValue"in e)this.Nt(e.stringValue,t),this.Bt(t);else if("bytesValue"in e)this.Mt(t,30),t.Lt(tz(e.bytesValue)),this.Bt(t);else if("referenceValue"in e)this.kt(e.referenceValue,t);else if("geoPointValue"in e){let n=e.geoPointValue;this.Mt(t,45),t.xt(n.latitude||0),t.xt(n.longitude||0)}else"mapValue"in e?nc(e)?this.Mt(t,Number.MAX_SAFE_INTEGER):nl(e)?this.qt(e.mapValue,t):(this.Qt(e.mapValue,t),this.Bt(t)):"arrayValue"in e?(this.$t(e.arrayValue,t),this.Bt(t)):x(19022,{Ut:e})}Nt(e,t){this.Mt(t,25),this.Kt(e,t)}Kt(e,t){t.Ot(e)}Qt(e,t){let n=e.fields||{};for(let e of(this.Mt(t,55),Object.keys(n)))this.Nt(e,t),this.Ct(n[e],t)}qt(e,t){var n,r;let i=e.fields||{};this.Mt(t,53);let s=(null==(r=null==(n=i[t5].arrayValue)?void 0:n.values)?void 0:r.length)||0;this.Mt(t,15),t.xt(tB(s)),this.Nt(t5,t),this.Ct(i[t5],t)}$t(e,t){let n=e.values||[];for(let e of(this.Mt(t,50),n))this.Ct(e,t)}kt(e,t){this.Mt(t,37),Z.fromName(e).path.forEach(e=>{this.Mt(t,60),this.Kt(e,t)})}Mt(e,t){e.xt(t)}Bt(e){e.xt(2)}}function iq(e){return Math.ceil((64-function(e){let t=0;for(let n=0;n<8;++n){let r=function(e){if(0===e)return 8;let t=0;return e>>4||(t+=4,e<<=4),e>>6||(t+=2,e<<=2),e>>7||(t+=1),t}(255&e[n]);if(t+=r,8!==r)break}return t}(e))/8)}iO.Wt=new iO;class iU{constructor(){this.buffer=new Uint8Array(1024),this.position=0}Gt(e){let t=e[Symbol.iterator](),n=t.next();for(;!n.done;)this.zt(n.value),n=t.next();this.jt()}Ht(e){let t=e[Symbol.iterator](),n=t.next();for(;!n.done;)this.Jt(n.value),n=t.next();this.Yt()}Zt(e){for(let t of e){let e=t.charCodeAt(0);if(e<128)this.zt(e);else if(e<2048)this.zt(960|e>>>6),this.zt(128|63&e);else if(t<"\ud800"||"\udbff"<t)this.zt(480|e>>>12),this.zt(128|63&e>>>6),this.zt(128|63&e);else{let e=t.codePointAt(0);this.zt(240|e>>>18),this.zt(128|63&e>>>12),this.zt(128|63&e>>>6),this.zt(128|63&e)}}this.jt()}Xt(e){for(let t of e){let e=t.charCodeAt(0);if(e<128)this.Jt(e);else if(e<2048)this.Jt(960|e>>>6),this.Jt(128|63&e);else if(t<"\ud800"||"\udbff"<t)this.Jt(480|e>>>12),this.Jt(128|63&e>>>6),this.Jt(128|63&e);else{let e=t.codePointAt(0);this.Jt(240|e>>>18),this.Jt(128|63&e>>>12),this.Jt(128|63&e>>>6),this.Jt(128|63&e)}}this.Yt()}en(e){let t=this.tn(e),n=iq(t);this.nn(1+n),this.buffer[this.position++]=255&n;for(let e=t.length-n;e<t.length;++e)this.buffer[this.position++]=255&t[e]}rn(e){let t=this.tn(e),n=iq(t);this.nn(1+n),this.buffer[this.position++]=~(255&n);for(let e=t.length-n;e<t.length;++e)this.buffer[this.position++]=~(255&t[e])}sn(){this._n(255),this._n(255)}an(){this.un(255),this.un(255)}reset(){this.position=0}seed(e){this.nn(e.length),this.buffer.set(e,this.position),this.position+=e.length}cn(){return this.buffer.slice(0,this.position)}tn(e){let t=function(e){let t=new DataView(new ArrayBuffer(8));return t.setFloat64(0,e,!1),new Uint8Array(t.buffer)}(e),n=!!(128&t[0]);t[0]^=n?255:128;for(let e=1;e<t.length;++e)t[e]^=255*!!n;return t}zt(e){let t=255&e;0===t?(this._n(0),this._n(255)):255===t?(this._n(255),this._n(0)):this._n(t)}Jt(e){let t=255&e;0===t?(this.un(0),this.un(255)):255===t?(this.un(255),this.un(0)):this.un(e)}jt(){this._n(0),this._n(1)}Yt(){this.un(0),this.un(1)}_n(e){this.nn(1),this.buffer[this.position++]=e}un(e){this.nn(1),this.buffer[this.position++]=~e}nn(e){let t=e+this.position;if(t<=this.buffer.length)return;let n=2*this.buffer.length;n<t&&(n=t);let r=new Uint8Array(n);r.set(this.buffer),this.buffer=r}}class iB{constructor(e){this.ln=e}Lt(e){this.ln.Gt(e)}Ot(e){this.ln.Zt(e)}xt(e){this.ln.en(e)}Ft(){this.ln.sn()}}class iz{constructor(e){this.ln=e}Lt(e){this.ln.Ht(e)}Ot(e){this.ln.Xt(e)}xt(e){this.ln.rn(e)}Ft(){this.ln.an()}}class i${constructor(){this.ln=new iU,this.hn=new iB(this.ln),this.Pn=new iz(this.ln)}seed(e){this.ln.seed(e)}Tn(e){return 0===e?this.hn:this.Pn}cn(){return this.ln.cn()}reset(){this.ln.reset()}}class iK{constructor(e,t,n,r){this.In=e,this.En=t,this.dn=n,this.An=r}Rn(){let e=this.An.length,t=0===e||255===this.An[e-1]?e+1:e,n=new Uint8Array(t);return n.set(this.An,0),t!==e?n.set([0],this.An.length):++n[n.length-1],new iK(this.In,this.En,this.dn,n)}Vn(e,t,n){return{indexId:this.In,uid:e,arrayValue:ij(this.dn),directionalValue:ij(this.An),orderedDocumentKey:ij(t),documentKey:n.path.toArray()}}mn(e,t,n){let r=this.Vn(e,t,n);return[r.indexId,r.uid,r.arrayValue,r.directionalValue,r.orderedDocumentKey,r.documentKey]}}function iG(e,t){let n=e.In-t.In;return 0!==n||0!==(n=iQ(e.dn,t.dn))||0!==(n=iQ(e.An,t.An))?n:Z.comparator(e.En,t.En)}function iQ(e,t){for(let n=0;n<e.length&&n<t.length;++n){let r=e[n]-t[n];if(0!==r)return r}return e.length-t.length}function ij(e){return d.isSafariOrWebkit()?function(e){let t="";for(let n=0;n<e.length;n++)t+=String.fromCharCode(e[n]);return t}(e):e}function iW(e){return"string"!=typeof e?e:function(e){let t=new Uint8Array(e.length);for(let n=0;n<e.length;n++)t[n]=e.charCodeAt(n);return t}(e)}class iH{constructor(e){for(let t of(this.fn=new tM((e,t)=>X.comparator(e.field,t.field)),this.collectionId=null!=e.collectionGroup?e.collectionGroup:e.path.lastSegment(),this.gn=e.orderBy,this.pn=[],e.filters))t.isInequality()?this.fn=this.fn.add(t):this.pn.push(t)}get yn(){return this.fn.size>1}wn(e){if(C(e.collectionGroup===this.collectionId,49279),this.yn)return!1;let t=et(e);if(void 0!==t&&!this.bn(t))return!1;let n=en(e),r=new Set,i=0,s=0;for(;i<n.length&&this.bn(n[i]);++i)r=r.add(n[i].fieldPath.canonicalString());if(i===n.length)return!0;if(this.fn.size>0){let e=this.fn.getIterator().getNext();if(!r.has(e.field.canonicalString())){let t=n[i];if(!this.Sn(e,t)||!this.Dn(this.gn[s++],t))return!1}++i}for(;i<n.length;++i){let e=n[i];if(s>=this.gn.length||!this.Dn(this.gn[s++],e))return!1}return!0}vn(){if(this.yn)return null;let e=new tM(X.comparator),t=[];for(let n of this.pn)if(!n.field.isKeyField())if("array-contains"===n.op||"array-contains-any"===n.op)t.push(new ei(n.field,2));else{if(e.has(n.field))continue;e=e.add(n.field),t.push(new ei(n.field,0))}for(let n of this.gn)n.field.isKeyField()||e.has(n.field)||(e=e.add(n.field),t.push(new ei(n.field,+("asc"!==n.dir))));return new ee(ee.UNKNOWN_ID,this.collectionId,t,es.empty())}bn(e){for(let t of this.pn)if(this.Sn(t,e))return!0;return!1}Sn(e,t){if(void 0===e||!e.field.isEqual(t.fieldPath))return!1;let n="array-contains"===e.op||"array-contains-any"===e.op;return 2===t.kind===n}Dn(e,t){return!!e.field.isEqual(t.fieldPath)&&(0===t.kind&&"asc"===e.dir||1===t.kind&&"desc"===e.dir)}}function iY(e){return e instanceof n_}function iJ(e){return e instanceof nT&&nx(e)}function iX(e){return iY(e)||iJ(e)||function(e){if(e instanceof nT&&nE(e)){for(let t of e.getFilters())if(!iY(t)&&!iJ(t))return!1;return!0}return!1}(e)}function iZ(e,t){return C(e instanceof n_||e instanceof nT,38388),C(t instanceof n_||t instanceof nT,25473),i1(e instanceof n_?t instanceof n_?nT.create([e,t],"and"):i0(e,t):t instanceof n_?i0(t,e):function(e,t){if(C(e.filters.length>0&&t.filters.length>0,48005),nb(e)&&nb(t))return nC(e,t.getFilters());let n=nE(e)?e:t,r=nE(e)?t:e,i=n.filters.map(e=>iZ(e,r));return nT.create(i,"or")}(e,t))}function i0(e,t){if(nb(t))return nC(t,e.getFilters());{let n=t.filters.map(t=>iZ(e,t));return nT.create(n,"or")}}function i1(e){if(C(e instanceof n_||e instanceof nT,11850),e instanceof n_)return e;let t=e.getFilters();if(1===t.length)return i1(t[0]);if(nS(e))return e;let n=t.map(e=>i1(e)),r=[];return n.forEach(t=>{t instanceof n_?r.push(t):t instanceof nT&&(t.op===e.op?r.push(...t.filters):r.push(t))}),1===r.length?r[0]:nT.create(r,e.op)}class i2{constructor(){this.Cn=new i5}addToCollectionParentIndex(e,t){return this.Cn.add(t),ef.resolve()}getCollectionParents(e,t){return ef.resolve(this.Cn.getEntries(t))}addFieldIndex(e,t){return ef.resolve()}deleteFieldIndex(e,t){return ef.resolve()}deleteAllFieldIndexes(e){return ef.resolve()}createTargetIndexes(e,t){return ef.resolve()}getDocumentsMatchingTarget(e,t){return ef.resolve(null)}getIndexType(e,t){return ef.resolve(0)}getFieldIndexes(e,t){return ef.resolve([])}getNextCollectionGroupToUpdate(e){return ef.resolve(null)}getMinOffset(e,t){return ef.resolve(el.min())}getMinOffsetFromCollectionGroup(e,t){return ef.resolve(el.min())}updateCollectionGroup(e,t,n){return ef.resolve()}updateIndexEntries(e,t){return ef.resolve()}}class i5{constructor(){this.index={}}add(e){let t=e.lastSegment(),n=e.popLast(),r=this.index[t]||new tM(Y.comparator),i=!r.has(n);return this.index[t]=r.add(n),i}has(e){let t=e.lastSegment(),n=e.popLast(),r=this.index[t];return r&&r.has(n)}getEntries(e){return(this.index[e]||new tM(Y.comparator)).toArray()}}let i4="IndexedDbIndexManager",i3=new Uint8Array(0);class i6{constructor(e,t){this.databaseId=t,this.Fn=new i5,this.Mn=new n6(e=>nO(e),(e,t)=>nq(e,t)),this.uid=e.uid||""}addToCollectionParentIndex(e,t){if(!this.Fn.has(t)){let n=t.lastSegment(),r=t.popLast();e.addOnCommittedListener(()=>{this.Fn.add(t)});let i={collectionId:n,parent:eR(r)};return tx(e,e8).put(i)}return ef.resolve()}getCollectionParents(e,t){let n=[],r=IDBKeyRange.bound([t,""],[t+"\0",""],!1,!0);return tx(e,e8).J(r).next(e=>{for(let r of e){if(r.collectionId!==t)break;n.push(eM(r.parent))}return n})}addFieldIndex(e,t){let n=tx(e,tn),r={indexId:t.indexId,collectionGroup:t.collectionGroup,fields:t.fields.map(e=>[e.fieldPath.canonicalString(),e.kind])};delete r.indexId;let i=n.add(r);if(t.indexState){let n=tx(e,ti);return i.next(e=>{n.put(iF(e,this.uid,t.indexState.sequenceNumber,t.indexState.offset))})}return i.next()}deleteFieldIndex(e,t){let n=tx(e,tn),r=tx(e,ti),i=tx(e,tl);return n.delete(t.indexId).next(()=>r.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0))).next(()=>i.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0)))}deleteAllFieldIndexes(e){let t=tx(e,tn),n=tx(e,tl),r=tx(e,ti);return t.X().next(()=>n.X()).next(()=>r.X())}createTargetIndexes(e,t){return ef.forEach(this.xn(t),t=>this.getIndexType(e,t).next(n=>{if(0===n||1===n){let n=new iH(t).vn();if(null!=n)return this.addFieldIndex(e,n)}}))}getDocumentsMatchingTarget(e,t){let n=tx(e,tl),r=!0,i=new Map;return ef.forEach(this.xn(t),t=>this.On(e,t).next(e=>{r&&(r=!!e),i.set(t,e)})).next(()=>{if(r){let e=ri(),r=[];return ef.forEach(i,(i,s)=>{_(i4,`Using index id=${i.indexId}|cg=${i.collectionGroup}|f=${i.fields.map(e=>`${e.fieldPath}:${e.kind}`).join(",")} to execute ${nO(t)}`);let a=function(e,t){let n=et(t);if(void 0===n)return null;for(let t of nB(e,n.fieldPath))switch(t.op){case"array-contains-any":return t.value.arrayValue.values||[];case"array-contains":return[t.value]}return null}(s,i),o=function(e,t){let n=new Map;for(let r of en(t))for(let t of nB(e,r.fieldPath))switch(t.op){case"==":case"in":n.set(r.fieldPath.canonicalString(),t.value);break;case"not-in":case"!=":return n.set(r.fieldPath.canonicalString(),t.value),Array.from(n.values())}return null}(s,i),l=function(e,t){let n=[],r=!0;for(let i of en(t)){let t=0===i.kind?nz(e,i.fieldPath,e.startAt):n$(e,i.fieldPath,e.startAt);n.push(t.value),r&&(r=t.inclusive)}return new np(n,r)}(s,i),u=function(e,t){let n=[],r=!0;for(let i of en(t)){let t=0===i.kind?n$(e,i.fieldPath,e.endAt):nz(e,i.fieldPath,e.endAt);n.push(t.value),r&&(r=t.inclusive)}return new np(n,r)}(s,i),c=this.Nn(i,s,l),h=this.Nn(i,s,u),d=this.Bn(i,s,o),f=this.Ln(i.indexId,a,c,l.inclusive,h,u.inclusive,d);return ef.forEach(f,i=>n.Z(i,t.limit).next(t=>{t.forEach(t=>{let n=Z.fromSegments(t.documentKey);e.has(n)||(e=e.add(n),r.push(n))})}))}).next(()=>r)}return ef.resolve(null)})}xn(e){let t=this.Mn.get(e);return t||(t=0===e.filters.length?[e]:(function(e){if(0===e.getFilters().length)return[];let t=function e(t){if(C(t instanceof n_||t instanceof nT,34018),t instanceof n_)return t;if(1===t.filters.length)return e(t.filters[0]);let n=t.filters.map(t=>e(t)),r=nT.create(n,t.op);return iX(r=i1(r))?r:(C(r instanceof nT,64498),C(nb(r),40251),C(r.filters.length>1,57927),r.filters.reduce((e,t)=>iZ(e,t)))}(function e(t){var n,r;if(C(t instanceof n_||t instanceof nT,20012),t instanceof n_){if(t instanceof nM){let e=(null==(r=null==(n=t.value.arrayValue)?void 0:n.values)?void 0:r.map(e=>n_.create(t.field,"==",e)))||[];return nT.create(e,"or")}return t}let i=t.filters.map(t=>e(t));return nT.create(i,t.op)}(e));return C(iX(t),7391),iY(t)||iJ(t)?[t]:t.getFilters()})(nT.create(e.filters,"and")).map(t=>nP(e.path,e.collectionGroup,e.orderBy,t.getFilters(),e.limit,e.startAt,e.endAt)),this.Mn.set(e,t)),t}Ln(e,t,n,r,i,s,a){let o=(null!=t?t.length:1)*Math.max(n.length,i.length),l=o/(null!=t?t.length:1),u=[];for(let c=0;c<o;++c){let o=t?this.kn(t[c/l]):i3,h=this.qn(e,o,n[c%l],r),d=this.Qn(e,o,i[c%l],s),f=a.map(t=>this.qn(e,o,t,!0));u.push(...this.createRange(h,d,f))}return u}qn(e,t,n,r){let i=new iK(e,Z.empty(),t,n);return r?i:i.Rn()}Qn(e,t,n,r){let i=new iK(e,Z.empty(),t,n);return r?i.Rn():i}On(e,t){let n=new iH(t),r=null!=t.collectionGroup?t.collectionGroup:t.path.lastSegment();return this.getFieldIndexes(e,r).next(e=>{let t=null;for(let r of e)n.wn(r)&&(!t||r.fields.length>t.fields.length)&&(t=r);return t})}getIndexType(e,t){let n=2,r=this.xn(t);return ef.forEach(r,t=>this.On(e,t).next(e=>{e?0!==n&&e.fields.length<function(e){let t=new tM(X.comparator),n=!1;for(let r of e.filters)for(let e of r.getFlattenedFilters())e.field.isKeyField()||("array-contains"===e.op||"array-contains-any"===e.op?n=!0:t=t.add(e.field));for(let n of e.orderBy)n.field.isKeyField()||(t=t.add(n.field));return t.size+ +!!n}(t)&&(n=1):n=0})).next(()=>null!==t.limit&&r.length>1&&2===n?1:n)}$n(e,t){let n=new i$;for(let r of en(e)){let e=t.data.field(r.fieldPath);if(null==e)return null;let i=n.Tn(r.kind);iO.Wt.vt(e,i)}return n.cn()}kn(e){let t=new i$;return iO.Wt.vt(e,t.Tn(0)),t.cn()}Un(e,t){let n=new i$;return iO.Wt.vt(nn(this.databaseId,t),n.Tn(function(e){let t=en(e);return 0===t.length?0:t[t.length-1].kind}(e))),n.cn()}Bn(e,t,n){if(null===n)return[];let r=[];r.push(new i$);let i=0;for(let s of en(e)){let e=n[i++];for(let n of r)if(this.Kn(t,s.fieldPath)&&ni(e))r=this.Wn(r,s,e);else{let t=n.Tn(s.kind);iO.Wt.vt(e,t)}}return this.Gn(r)}Nn(e,t,n){return this.Bn(e,t,n.position)}Gn(e){let t=[];for(let n=0;n<e.length;++n)t[n]=e[n].cn();return t}Wn(e,t,n){let r=[...e],i=[];for(let e of n.arrayValue.values||[])for(let n of r){let r=new i$;r.seed(n.cn()),iO.Wt.vt(e,r.Tn(t.kind)),i.push(r)}return i}Kn(e,t){return!!e.filters.find(e=>e instanceof n_&&e.field.isEqual(t)&&("in"===e.op||"not-in"===e.op))}getFieldIndexes(e,t){let n=tx(e,tn),r=tx(e,ti);return(t?n.J(tr,IDBKeyRange.bound(t,t)):n.J()).next(e=>{let t=[];return ef.forEach(e,e=>r.get([e.indexId,this.uid]).next(n=>{t.push(function(e,t){let n=t?new es(t.sequenceNumber,new el(iC(t.readTime),new Z(eM(t.documentKey)),t.largestBatchId)):es.empty(),r=e.fields.map(([e,t])=>new ei(X.fromServerFormat(e),t));return new ee(e.indexId,e.collectionGroup,r,n)}(e,n))})).next(()=>t)})}getNextCollectionGroupToUpdate(e){return this.getFieldIndexes(e).next(e=>0===e.length?null:(e.sort((e,t)=>{let n=e.indexState.sequenceNumber-t.indexState.sequenceNumber;return 0!==n?n:z(e.collectionGroup,t.collectionGroup)}),e[0].collectionGroup))}updateCollectionGroup(e,t,n){let r=tx(e,tn),i=tx(e,ti);return this.zn(e).next(e=>r.J(tr,IDBKeyRange.bound(t,t)).next(t=>ef.forEach(t,t=>i.put(iF(t.indexId,this.uid,e,n)))))}updateIndexEntries(e,t){let n=new Map;return ef.forEach(t,(t,r)=>{let i=n.get(t.collectionGroup);return(i?ef.resolve(i):this.getFieldIndexes(e,t.collectionGroup)).next(i=>(n.set(t.collectionGroup,i),ef.forEach(i,n=>this.jn(e,t,n).next(t=>{let i=this.Hn(r,n);return t.isEqual(i)?ef.resolve():this.Jn(e,r,n,t,i)}))))})}Yn(e,t,n,r){return tx(e,tl).put(r.Vn(this.uid,this.Un(n,t.key),t.key))}Zn(e,t,n,r){return tx(e,tl).delete(r.mn(this.uid,this.Un(n,t.key),t.key))}jn(e,t,n){let r=tx(e,tl),i=new tM(iG);return r.te({index:tc,range:IDBKeyRange.only([n.indexId,this.uid,ij(this.Un(n,t))])},(e,r)=>{i=i.add(new iK(n.indexId,t,iW(r.arrayValue),iW(r.directionalValue)))}).next(()=>i)}Hn(e,t){let n=new tM(iG),r=this.$n(t,e);if(null==r)return n;let i=et(t);if(null!=i){let s=e.data.field(i.fieldPath);if(ni(s))for(let i of s.arrayValue.values||[])n=n.add(new iK(t.indexId,e.key,this.kn(i),r))}else n=n.add(new iK(t.indexId,e.key,i3,r));return n}Jn(e,t,n,r,i){_(i4,"Updating index entries for document '%s'",t.key);let s=[];return function(e,t,n,r,i){let s=e.getIterator(),a=t.getIterator(),o=tV(s),l=tV(a);for(;o||l;){let e=!1,t=!1;if(o&&l){let r=n(o,l);r<0?t=!0:r>0&&(e=!0)}else null!=o?t=!0:e=!0;e?(r(l),l=tV(a)):t?(i(o),o=tV(s)):(o=tV(s),l=tV(a))}}(r,i,iG,r=>{s.push(this.Yn(e,t,n,r))},r=>{s.push(this.Zn(e,t,n,r))}),ef.waitFor(s)}zn(e){let t=1;return tx(e,ti).te({index:ta,reverse:!0,range:IDBKeyRange.upperBound([this.uid,Number.MAX_SAFE_INTEGER])},(e,n,r)=>{r.done(),t=n.sequenceNumber+1}).next(()=>t)}createRange(e,t,n){n=n.sort((e,t)=>iG(e,t)).filter((e,t,n)=>!t||0!==iG(e,n[t-1]));let r=[];for(let i of(r.push(e),n)){let n=iG(i,e),s=iG(i,t);if(0===n)r[0]=e.Rn();else if(n>0&&s<0)r.push(i),r.push(i.Rn());else if(s>0)break}r.push(t);let i=[];for(let e=0;e<r.length;e+=2){if(this.Xn(r[e],r[e+1]))return[];let t=r[e].mn(this.uid,i3,Z.empty()),n=r[e+1].mn(this.uid,i3,Z.empty());i.push(IDBKeyRange.bound(t,n))}return i}Xn(e,t){return iG(e,t)>0}getMinOffsetFromCollectionGroup(e,t){return this.getFieldIndexes(e,t).next(i8)}getMinOffset(e,t){return ef.mapArray(this.xn(t),t=>this.On(e,t).next(e=>e||x(44426))).next(i8)}}function i8(e){C(0!==e.length,28825);let t=e[0].indexState.offset,n=t.largestBatchId;for(let r=1;r<e.length;r++){let i=e[r].indexState.offset;0>eu(i,t)&&(t=i),n<i.largestBatchId&&(n=i.largestBatchId)}return new el(t.readTime,t.documentKey,n)}let i9={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0};class i7{static withCacheSize(e){return new i7(e,i7.DEFAULT_COLLECTION_PERCENTILE,i7.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)}constructor(e,t,n){this.cacheSizeCollectionThreshold=e,this.percentileToCollect=t,this.maximumSequenceNumbersToCollect=n}}function se(e,t,n){let r=e.store(eO),i=e.store(e$),s=[],a=IDBKeyRange.only(n.batchId),o=0,l=r.te({range:a},(e,t,n)=>(o++,n.delete()));s.push(l.next(()=>{C(1===o,47070,{batchId:n.batchId})}));let u=[];for(let e of n.mutations){var c,h;let r=(c=e.key.path,h=n.batchId,[t,eR(c),h]);s.push(i.delete(r)),u.push(e.key)}return ef.waitFor(s).next(()=>u)}function st(e){let t;if(!e)return 0;if(e.document)t=e.document;else if(e.unknownDocument)t=e.unknownDocument;else{if(!e.noDocument)throw x(14731);t=e.noDocument}return JSON.stringify(t).length}i7.DEFAULT_COLLECTION_PERCENTILE=10,i7.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,i7.DEFAULT=new i7(0x2800000,i7.DEFAULT_COLLECTION_PERCENTILE,i7.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),i7.DISABLED=new i7(-1,0,0);class sn{constructor(e,t,n,r){this.userId=e,this.serializer=t,this.indexManager=n,this.referenceDelegate=r,this.er={}}static bt(e,t,n,r){return C(""!==e.uid,64387),new sn(e.isAuthenticated()?e.uid:"",t,n,r)}checkEmpty(e){let t=!0,n=IDBKeyRange.bound([this.userId,Number.NEGATIVE_INFINITY],[this.userId,Number.POSITIVE_INFINITY]);return si(e).te({index:eU,range:n},(e,n,r)=>{t=!1,r.done()}).next(()=>t)}addMutationBatch(e,t,n,r){let i=tx(e,e$),s=si(e);return s.add({}).next(a=>{C("number"==typeof a,49019);let o=new rF(a,t,n,r),l=function(e,t,n){let r=n.baseMutations.map(t=>id(e.wt,t)),i=n.mutations.map(t=>id(e.wt,t));return{userId:t,batchId:n.batchId,localWriteTimeMs:n.localWriteTime.toMillis(),baseMutations:r,mutations:i}}(this.serializer,this.userId,o),u=[],c=new tM((e,t)=>z(e.canonicalString(),t.canonicalString()));for(let e of r){var h,d;let t=(h=this.userId,d=e.key.path,[h,eR(d),a]);c=c.add(e.key.path.popLast()),u.push(s.put(l)),u.push(i.put(t,ez))}return c.forEach(t=>{u.push(this.indexManager.addToCollectionParentIndex(e,t))}),e.addOnCommittedListener(()=>{this.er[a]=o.keys()}),ef.waitFor(u).next(()=>o)})}lookupMutationBatch(e,t){return si(e).get(t).next(e=>e?(C(e.userId===this.userId,48,"Unexpected user for mutation batch",{userId:e.userId,batchId:t}),iN(this.serializer,e)):null)}tr(e,t){return this.er[t]?ef.resolve(this.er[t]):this.lookupMutationBatch(e,t).next(e=>{if(e){let n=e.keys();return this.er[t]=n,n}return null})}getNextMutationBatchAfterBatchId(e,t){let n=t+1,r=IDBKeyRange.lowerBound([this.userId,n]),i=null;return si(e).te({index:eU,range:r},(e,t,r)=>{t.userId===this.userId&&(C(t.batchId>=n,47524,{nr:n}),i=iN(this.serializer,t)),r.done()}).next(()=>i)}getHighestUnacknowledgedBatchId(e){let t=IDBKeyRange.upperBound([this.userId,Number.POSITIVE_INFINITY]),n=-1;return si(e).te({index:eU,range:t,reverse:!0},(e,t,r)=>{n=t.batchId,r.done()}).next(()=>n)}getAllMutationBatches(e){let t=IDBKeyRange.bound([this.userId,-1],[this.userId,Number.POSITIVE_INFINITY]);return si(e).J(eU,t).next(e=>e.map(e=>iN(this.serializer,e)))}getAllMutationBatchesAffectingDocumentKey(e,t){let n=[this.userId,eR(t.path)],r=IDBKeyRange.lowerBound(n),i=[];return tx(e,e$).te({range:r},(n,r,s)=>{let[a,o,l]=n,u=eM(o);if(a===this.userId&&t.path.isEqual(u))return si(e).get(l).next(e=>{if(!e)throw x(61480,{rr:n,batchId:l});C(e.userId===this.userId,10503,"Unexpected user for mutation batch",{userId:e.userId,batchId:l}),i.push(iN(this.serializer,e))});s.done()}).next(()=>i)}getAllMutationBatchesAffectingDocumentKeys(e,t){let n=new tM(z),r=[];return t.forEach(t=>{let i=[this.userId,eR(t.path)],s=IDBKeyRange.lowerBound(i),a=tx(e,e$).te({range:s},(e,r,i)=>{let[s,a,o]=e,l=eM(a);s===this.userId&&t.path.isEqual(l)?n=n.add(o):i.done()});r.push(a)}),ef.waitFor(r).next(()=>this.ir(e,n))}getAllMutationBatchesAffectingQuery(e,t){let n=t.path,r=n.length+1,i=[this.userId,eR(n)],s=IDBKeyRange.lowerBound(i),a=new tM(z);return tx(e,e$).te({range:s},(e,t,i)=>{let[s,o,l]=e,u=eM(o);s===this.userId&&n.isPrefixOf(u)?u.length===r&&(a=a.add(l)):i.done()}).next(()=>this.ir(e,a))}ir(e,t){let n=[],r=[];return t.forEach(t=>{r.push(si(e).get(t).next(e=>{if(null===e)throw x(35274,{batchId:t});C(e.userId===this.userId,9748,"Unexpected user for mutation batch",{userId:e.userId,batchId:t}),n.push(iN(this.serializer,e))}))}),ef.waitFor(r).next(()=>n)}removeMutationBatch(e,t){return se(e.he,this.userId,t).next(n=>(e.addOnCommittedListener(()=>{this.sr(t.batchId)}),ef.forEach(n,t=>this.referenceDelegate.markPotentiallyOrphaned(e,t))))}sr(e){delete this.er[e]}performConsistencyCheck(e){return this.checkEmpty(e).next(t=>{if(!t)return ef.resolve();let n=IDBKeyRange.lowerBound([this.userId]),r=[];return tx(e,e$).te({range:n},(e,t,n)=>{if(e[0]===this.userId){let t=eM(e[1]);r.push(t)}else n.done()}).next(()=>{C(0===r.length,56720,{_r:r.map(e=>e.canonicalString())})})})}containsKey(e,t){return sr(e,this.userId,t)}ar(e){return tx(e,eP).get(this.userId).next(e=>e||{userId:this.userId,lastAcknowledgedBatchId:-1,lastStreamToken:""})}}function sr(e,t,n){let r=[t,eR(n.path)],i=r[1],s=IDBKeyRange.lowerBound(r),a=!1;return tx(e,e$).te({range:s,ee:!0},(e,n,r)=>{let[s,o,l]=e;s===t&&o===i&&(a=!0),r.done()}).next(()=>a)}function si(e){return tx(e,eO)}class ss{constructor(e){this.ur=e}next(){return this.ur+=2,this.ur}static cr(){return new ss(0)}static lr(){return new ss(-1)}}class sa{constructor(e,t){this.referenceDelegate=e,this.serializer=t}allocateTargetId(e){return this.hr(e).next(t=>{let n=new ss(t.highestTargetId);return t.highestTargetId=n.next(),this.Pr(e,t).next(()=>t.highestTargetId)})}getLastRemoteSnapshotVersion(e){return this.hr(e).next(e=>j.fromTimestamp(new Q(e.lastRemoteSnapshotVersion.seconds,e.lastRemoteSnapshotVersion.nanoseconds)))}getHighestSequenceNumber(e){return this.hr(e).next(e=>e.highestListenSequenceNumber)}setTargetsMetadata(e,t,n){return this.hr(e).next(r=>(r.highestListenSequenceNumber=t,n&&(r.lastRemoteSnapshotVersion=n.toTimestamp()),t>r.highestListenSequenceNumber&&(r.highestListenSequenceNumber=t),this.Pr(e,r)))}addTargetData(e,t){return this.Tr(e,t).next(()=>this.hr(e).next(n=>(n.targetCount+=1,this.Ir(t,n),this.Pr(e,n))))}updateTargetData(e,t){return this.Tr(e,t)}removeTargetData(e,t){return this.removeMatchingKeysForTargetId(e,t.targetId).next(()=>tx(e,eX).delete(t.targetId)).next(()=>this.hr(e)).next(t=>(C(t.targetCount>0,8065),t.targetCount-=1,this.Pr(e,t)))}removeTargets(e,t,n){let r=0,i=[];return tx(e,eX).te((s,a)=>{let o=iD(a);o.sequenceNumber<=t&&null===n.get(o.targetId)&&(r++,i.push(this.removeTargetData(e,o)))}).next(()=>ef.waitFor(i)).next(()=>r)}forEachTarget(e,t){return tx(e,eX).te((e,n)=>{t(iD(n))})}hr(e){return tx(e,e6).get(e3).next(e=>(C(null!==e,2888),e))}Pr(e,t){return tx(e,e6).put(e3,t)}Tr(e,t){return tx(e,eX).put(iA(this.serializer,t))}Ir(e,t){let n=!1;return e.targetId>t.highestTargetId&&(t.highestTargetId=e.targetId,n=!0),e.sequenceNumber>t.highestListenSequenceNumber&&(t.highestListenSequenceNumber=e.sequenceNumber,n=!0),n}getTargetCount(e){return this.hr(e).next(e=>e.targetCount)}getTargetData(e,t){let n=nO(t),r=IDBKeyRange.bound([n,Number.NEGATIVE_INFINITY],[n,Number.POSITIVE_INFINITY]),i=null;return tx(e,eX).te({range:r,index:eZ},(e,n,r)=>{let s=iD(n);nq(t,s.target)&&(i=s,r.done())}).next(()=>i)}addMatchingKeys(e,t,n){let r=[],i=so(e);return t.forEach(t=>{let s=eR(t.path);r.push(i.put({targetId:n,path:s})),r.push(this.referenceDelegate.addReference(e,n,t))}),ef.waitFor(r)}removeMatchingKeys(e,t,n){let r=so(e);return ef.forEach(t,t=>{let i=eR(t.path);return ef.waitFor([r.delete([n,i]),this.referenceDelegate.removeReference(e,n,t)])})}removeMatchingKeysForTargetId(e,t){let n=so(e),r=IDBKeyRange.bound([t],[t+1],!1,!0);return n.delete(r)}getMatchingKeysForTargetId(e,t){let n=IDBKeyRange.bound([t],[t+1],!1,!0),r=so(e),i=ri();return r.te({range:n,ee:!0},(e,t,n)=>{let r=new Z(eM(e[1]));i=i.add(r)}).next(()=>i)}containsKey(e,t){let n=eR(t.path),r=IDBKeyRange.bound([n],[n+"\0"],!1,!0),i=0;return so(e).te({index:e5,ee:!0,range:r},([e,t],n,r)=>{0!==e&&(i++,r.done())}).next(()=>i>0)}Rt(e,t){return tx(e,eX).get(t).next(e=>e?iD(e):null)}}function so(e){return tx(e,e1)}let sl="LruGarbageCollector";function su([e,t],[n,r]){let i=z(e,n);return 0===i?z(t,r):i}class sc{constructor(e){this.Er=e,this.buffer=new tM(su),this.dr=0}Ar(){return++this.dr}Rr(e){let t=[e,this.Ar()];if(this.buffer.size<this.Er)this.buffer=this.buffer.add(t);else{let e=this.buffer.last();0>su(t,e)&&(this.buffer=this.buffer.delete(e).add(t))}}get maxValue(){return this.buffer.last()[0]}}class sh{constructor(e,t,n){this.garbageCollector=e,this.asyncQueue=t,this.localStore=n,this.Vr=null}start(){-1!==this.garbageCollector.params.cacheSizeCollectionThreshold&&this.mr(6e4)}stop(){this.Vr&&(this.Vr.cancel(),this.Vr=null)}get started(){return null!==this.Vr}mr(e){_(sl,`Garbage collection scheduled in ${e}ms`),this.Vr=this.asyncQueue.enqueueAfterDelay("lru_garbage_collection",e,async()=>{this.Vr=null;try{await this.localStore.collectGarbage(this.garbageCollector)}catch(e){eI(e)?_(sl,"Ignoring IndexedDB error during garbage collection: ",e):await ed(e)}await this.mr(3e5)})}}class sd{constructor(e,t){this.gr=e,this.params=t}calculateTargetCount(e,t){return this.gr.pr(e).next(e=>Math.floor(t/100*e))}nthSequenceNumber(e,t){if(0===t)return ef.resolve(eN.le);let n=new sc(t);return this.gr.forEachTarget(e,e=>n.Rr(e.sequenceNumber)).next(()=>this.gr.yr(e,e=>n.Rr(e))).next(()=>n.maxValue)}removeTargets(e,t,n){return this.gr.removeTargets(e,t,n)}removeOrphanedDocuments(e,t){return this.gr.removeOrphanedDocuments(e,t)}collect(e,t){return -1===this.params.cacheSizeCollectionThreshold?(_("LruGarbageCollector","Garbage collection skipped; disabled"),ef.resolve(i9)):this.getCacheSize(e).next(n=>n<this.params.cacheSizeCollectionThreshold?(_("LruGarbageCollector",`Garbage collection skipped; Cache size ${n} is lower than threshold ${this.params.cacheSizeCollectionThreshold}`),i9):this.wr(e,t))}getCacheSize(e){return this.gr.getCacheSize(e)}wr(e,t){let n,r,i,s,a,o,l,u=Date.now();return this.calculateTargetCount(e,this.params.percentileToCollect).next(t=>(t>this.params.maximumSequenceNumbersToCollect?(_("LruGarbageCollector",`Capping sequence numbers to collect down to the maximum of ${this.params.maximumSequenceNumbersToCollect} from ${t}`),r=this.params.maximumSequenceNumbersToCollect):r=t,s=Date.now(),this.nthSequenceNumber(e,r))).next(r=>(n=r,a=Date.now(),this.removeTargets(e,n,t))).next(t=>(i=t,o=Date.now(),this.removeOrphanedDocuments(e,n))).next(e=>(l=Date.now(),I()<=h.LogLevel.DEBUG&&_("LruGarbageCollector",`LRU Garbage Collection
	Counted targets in ${s-u}ms
	Determined least recently used ${r} in `+(a-s)+"ms\n"+`	Removed ${i} targets in `+(o-a)+"ms\n"+`	Removed ${e} documents in `+(l-o)+"ms\n"+`Total Duration: ${l-u}ms`),ef.resolve({didRun:!0,sequenceNumbersCollected:r,targetsRemoved:i,documentsRemoved:e})))}}class sf{constructor(e,t){this.db=e,this.garbageCollector=new sd(this,t)}pr(e){let t=this.br(e);return this.db.getTargetCache().getTargetCount(e).next(e=>t.next(t=>e+t))}br(e){let t=0;return this.yr(e,e=>{t++}).next(()=>t)}forEachTarget(e,t){return this.db.getTargetCache().forEachTarget(e,t)}yr(e,t){return this.Sr(e,(e,n)=>t(n))}addReference(e,t,n){return sm(e,n)}removeReference(e,t,n){return sm(e,n)}removeTargets(e,t,n){return this.db.getTargetCache().removeTargets(e,t,n)}markPotentiallyOrphaned(e,t){return sm(e,t)}Dr(e,t){let n;return n=!1,tx(e,eP).ne(r=>sr(e,r,t).next(e=>(e&&(n=!0),ef.resolve(!e)))).next(()=>n)}removeOrphanedDocuments(e,t){let n=this.db.getRemoteDocumentCache().newChangeBuffer(),r=[],i=0;return this.Sr(e,(s,a)=>{if(a<=t){let t=this.Dr(e,s).next(t=>{if(!t)return i++,n.getEntry(e,s).next(()=>(n.removeEntry(s,j.min()),so(e).delete([0,eR(s.path)])))});r.push(t)}}).next(()=>ef.waitFor(r)).next(()=>n.apply(e)).next(()=>i)}removeTarget(e,t){let n=t.withSequenceNumber(e.currentSequenceNumber);return this.db.getTargetCache().updateTargetData(e,n)}updateLimboDocument(e,t){return sm(e,t)}Sr(e,t){let n=so(e),r,i=eN.le;return n.te({index:e5},([e,n],{path:s,sequenceNumber:a})=>{0===e?(i!==eN.le&&t(new Z(eM(r)),i),i=a,r=s):i=eN.le}).next(()=>{i!==eN.le&&t(new Z(eM(r)),i)})}getCacheSize(e){return this.db.getRemoteDocumentCache().getSize(e)}}function sm(e,t){var n;return so(e).put((n=e.currentSequenceNumber,{targetId:0,path:eR(t.path),sequenceNumber:n}))}class sg{constructor(){this.changes=new n6(e=>e.toString(),(e,t)=>e.isEqual(t)),this.changesApplied=!1}addEntry(e){this.assertNotApplied(),this.changes.set(e.key,e)}removeEntry(e,t){this.assertNotApplied(),this.changes.set(e,ng.newInvalidDocument(e).setReadTime(t))}getEntry(e,t){this.assertNotApplied();let n=this.changes.get(t);return void 0!==n?ef.resolve(n):this.getFromCache(e,t)}getEntries(e,t){return this.getAllFromCache(e,t)}apply(e){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(e)}assertNotApplied(){}}class sp{constructor(e){this.serializer=e}setIndexManager(e){this.indexManager=e}addEntry(e,t,n){return tx(e,eK).put(n)}removeEntry(e,t,n){return tx(e,eK).delete(function(e,t){let n=e.path.toArray();return[n.slice(0,n.length-2),n[n.length-2],ix(t),n[n.length-1]]}(t,n))}updateMetadata(e,t){return this.getMetadata(e).next(n=>(n.byteSize+=t,this.vr(e,n)))}getEntry(e,t){let n=ng.newInvalidDocument(t);return tx(e,eK).te({index:eQ,range:IDBKeyRange.only(sw(t))},(e,r)=>{n=this.Cr(t,r)}).next(()=>n)}Fr(e,t){let n={size:0,document:ng.newInvalidDocument(t)};return tx(e,eK).te({index:eQ,range:IDBKeyRange.only(sw(t))},(e,r)=>{n={document:this.Cr(t,r),size:st(r)}}).next(()=>n)}getEntries(e,t){let n=n8;return this.Mr(e,t,(e,t)=>{let r=this.Cr(e,t);n=n.insert(e,r)}).next(()=>n)}Or(e,t){let n=n8,r=new tA(Z.comparator);return this.Mr(e,t,(e,t)=>{let i=this.Cr(e,t);n=n.insert(e,i),r=r.insert(e,st(t))}).next(()=>({documents:n,Nr:r}))}Mr(e,t,n){if(t.isEmpty())return ef.resolve();let r=new tM(sI);t.forEach(e=>r=r.add(e));let i=IDBKeyRange.bound(sw(r.first()),sw(r.last())),s=r.getIterator(),a=s.getNext();return tx(e,eK).te({index:eQ,range:i},(e,t,r)=>{let i=Z.fromSegments([...t.prefixPath,t.collectionGroup,t.documentId]);for(;a&&0>sI(a,i);)n(a,null),a=s.getNext();a&&a.isEqual(i)&&(n(a,t),a=s.hasNext()?s.getNext():null),a?r.H(sw(a)):r.done()}).next(()=>{for(;a;)n(a,null),a=s.hasNext()?s.getNext():null})}getDocumentsMatchingQuery(e,t,n,r,i){let s=t.path,a=[s.popLast().toArray(),s.lastSegment(),ix(n.readTime),n.documentKey.path.isEmpty()?"":n.documentKey.path.lastSegment()],o=[s.popLast().toArray(),s.lastSegment(),[Number.MAX_SAFE_INTEGER,Number.MAX_SAFE_INTEGER],""];return tx(e,eK).J(IDBKeyRange.bound(a,o,!0)).next(e=>{null==i||i.incrementDocumentReadCount(e.length);let n=n8;for(let i of e){let e=this.Cr(Z.fromSegments(i.prefixPath.concat(i.collectionGroup,i.documentId)),i);e.isFoundDocument()&&(n5(t,e)||r.has(e.key))&&(n=n.insert(e.key,e))}return n})}getAllFromCollectionGroup(e,t,n,r){let i=n8,s=sv(t,n),a=sv(t,el.max());return tx(e,eK).te({index:eW,range:IDBKeyRange.bound(s,a,!0)},(e,t,n)=>{let s=this.Cr(Z.fromSegments(t.prefixPath.concat(t.collectionGroup,t.documentId)),t);(i=i.insert(s.key,s)).size===r&&n.done()}).next(()=>i)}newChangeBuffer(e){return new sy(this,!!e&&e.trackRemovals)}getSize(e){return this.getMetadata(e).next(e=>e.byteSize)}getMetadata(e){return tx(e,eY).get(eJ).next(e=>(C(!!e,20021),e))}vr(e,t){return tx(e,eY).put(eJ,t)}Cr(e,t){if(t){let e=function(e,t){let n;if(t.document)n=ih(e.wt,t.document,!!t.hasCommittedMutations);else if(t.noDocument){let e=Z.fromSegments(t.noDocument.path),r=iC(t.noDocument.readTime);n=ng.newNoDocument(e,r),t.hasCommittedMutations&&n.setHasCommittedMutations()}else{if(!t.unknownDocument)return x(56709);{let e=Z.fromSegments(t.unknownDocument.path),r=iC(t.unknownDocument.version);n=ng.newUnknownDocument(e,r)}}return t.readTime&&n.setReadTime(function(e){let t=new Q(e[0],e[1]);return j.fromTimestamp(t)}(t.readTime)),n}(this.serializer,t);if(!(e.isNoDocument()&&e.version.isEqual(j.min())))return e}return ng.newInvalidDocument(e)}}class sy extends sg{constructor(e,t){super(),this.Br=e,this.trackRemovals=t,this.Lr=new n6(e=>e.toString(),(e,t)=>e.isEqual(t))}applyChanges(e){let t=[],n=0,r=new tM((e,t)=>z(e.canonicalString(),t.canonicalString()));return this.changes.forEach((i,s)=>{let a=this.Lr.get(i);if(t.push(this.Br.removeEntry(e,i,a.readTime)),s.isValidDocument()){let o=iE(this.Br.serializer,s);r=r.add(i.path.popLast());let l=st(o);n+=l-a.size,t.push(this.Br.addEntry(e,i,o))}else if(n-=a.size,this.trackRemovals){let n=iE(this.Br.serializer,s.convertToNoDocument(j.min()));t.push(this.Br.addEntry(e,i,n))}}),r.forEach(n=>{t.push(this.Br.indexManager.addToCollectionParentIndex(e,n))}),t.push(this.Br.updateMetadata(e,n)),ef.waitFor(t)}getFromCache(e,t){return this.Br.Fr(e,t).next(e=>(this.Lr.set(t,{size:e.size,readTime:e.document.readTime}),e.document))}getAllFromCache(e,t){return this.Br.Or(e,t).next(({documents:e,Nr:t})=>(t.forEach((t,n)=>{this.Lr.set(t,{size:n,readTime:e.get(t).readTime})}),e))}}function sw(e){let t=e.path.toArray();return[t.slice(0,t.length-2),t[t.length-2],t[t.length-1]]}function sv(e,t){let n=t.documentKey.path.toArray();return[e,ix(t.readTime),n.slice(0,n.length-2),n.length>0?n[n.length-1]:""]}function sI(e,t){let n=e.path.toArray(),r=t.path.toArray(),i=0;for(let e=0;e<n.length-2&&e<r.length-2;++e)if(i=z(n[e],r[e]))return i;return(i=z(n.length,r.length))||(i=z(n[n.length-2],r[r.length-2]))||z(n[n.length-1],r[r.length-1])}class s_{constructor(e,t){this.overlayedDocument=e,this.mutatedFields=t}}class sT{constructor(e,t,n,r){this.remoteDocumentCache=e,this.mutationQueue=t,this.documentOverlayCache=n,this.indexManager=r}getDocument(e,t){let n=null;return this.documentOverlayCache.getOverlay(e,t).next(r=>(n=r,this.remoteDocumentCache.getEntry(e,t))).next(e=>(null!==n&&rx(n.mutation,e,tL.empty(),Q.now()),e))}getDocuments(e,t){return this.remoteDocumentCache.getEntries(e,t).next(t=>this.getLocalViewOfDocuments(e,t,ri()).next(()=>t))}getLocalViewOfDocuments(e,t,n=ri()){let r=rt();return this.populateOverlays(e,r,t).next(()=>this.computeViews(e,t,r,n).next(e=>{let t=n7();return e.forEach((e,n)=>{t=t.insert(e,n.overlayedDocument)}),t}))}getOverlayedDocuments(e,t){let n=rt();return this.populateOverlays(e,n,t).next(()=>this.computeViews(e,t,n,ri()))}populateOverlays(e,t,n){let r=[];return n.forEach(e=>{t.has(e)||r.push(e)}),this.documentOverlayCache.getOverlays(e,r).next(e=>{e.forEach((e,n)=>{t.set(e,n)})})}computeViews(e,t,n,r){let i=n8,s=rt(),a=rt();return t.forEach((e,t)=>{let a=n.get(t.key);r.has(t.key)&&(void 0===a||a.mutation instanceof rN)?i=i.insert(t.key,t):void 0!==a?(s.set(t.key,a.mutation.getFieldMask()),rx(a.mutation,t,a.mutation.getFieldMask(),Q.now())):s.set(t.key,tL.empty())}),this.recalculateAndSaveOverlays(e,i).next(e=>(e.forEach((e,t)=>s.set(e,t)),t.forEach((e,t)=>{var n;return a.set(e,new s_(t,null!=(n=s.get(e))?n:null))}),a))}recalculateAndSaveOverlays(e,t){let n=rt(),r=new tA((e,t)=>e-t),i=ri();return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(e,t).next(e=>{for(let i of e)i.keys().forEach(e=>{let s=t.get(e);if(null===s)return;let a=n.get(e)||tL.empty();a=i.applyToLocalView(s,a),n.set(e,a);let o=(r.get(i.batchId)||ri()).add(e);r=r.insert(i.batchId,o)})}).next(()=>{let s=[],a=r.getReverseIterator();for(;a.hasNext();){let r=a.getNext(),o=r.key,l=r.value,u=rt();l.forEach(e=>{if(!i.has(e)){let r=rE(t.get(e),n.get(e));null!==r&&u.set(e,r),i=i.add(e)}}),s.push(this.documentOverlayCache.saveOverlays(e,o,u))}return ef.waitFor(s)}).next(()=>n)}recalculateAndSaveOverlaysForDocumentKeys(e,t){return this.remoteDocumentCache.getEntries(e,t).next(t=>this.recalculateAndSaveOverlays(e,t))}getDocumentsMatchingQuery(e,t,n,r){return Z.isDocumentKey(t.path)&&null===t.collectionGroup&&0===t.filters.length?this.getDocumentsMatchingDocumentQuery(e,t.path):nj(t)?this.getDocumentsMatchingCollectionGroupQuery(e,t,n,r):this.getDocumentsMatchingCollectionQuery(e,t,n,r)}getNextDocuments(e,t,n,r){return this.remoteDocumentCache.getAllFromCollectionGroup(e,t,n,r).next(i=>{let s=r-i.size>0?this.documentOverlayCache.getOverlaysForCollectionGroup(e,t,n.largestBatchId,r-i.size):ef.resolve(rt()),a=-1,o=i;return s.next(t=>ef.forEach(t,(t,n)=>(a<n.largestBatchId&&(a=n.largestBatchId),i.get(t)?ef.resolve():this.remoteDocumentCache.getEntry(e,t).next(e=>{o=o.insert(t,e)}))).next(()=>this.populateOverlays(e,t,i)).next(()=>this.computeViews(e,o,t,ri())).next(e=>({batchId:a,changes:re(e)})))})}getDocumentsMatchingDocumentQuery(e,t){return this.getDocument(e,new Z(t)).next(e=>{let t=n7();return e.isFoundDocument()&&(t=t.insert(e.key,e)),t})}getDocumentsMatchingCollectionGroupQuery(e,t,n,r){let i=t.collectionGroup,s=n7();return this.indexManager.getCollectionParents(e,i).next(a=>ef.forEach(a,a=>{let o=new nK(a.child(i),null,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,t.startAt,t.endAt);return this.getDocumentsMatchingCollectionQuery(e,o,n,r).next(e=>{e.forEach((e,t)=>{s=s.insert(e,t)})})}).next(()=>s))}getDocumentsMatchingCollectionQuery(e,t,n,r){let i;return this.documentOverlayCache.getOverlaysForCollection(e,t.path,n.largestBatchId).next(s=>(i=s,this.remoteDocumentCache.getDocumentsMatchingQuery(e,t,n,i,r))).next(e=>{i.forEach((t,n)=>{let r=n.getKey();null===e.get(r)&&(e=e.insert(r,ng.newInvalidDocument(r)))});let n=n7();return e.forEach((e,r)=>{let s=i.get(e);void 0!==s&&rx(s.mutation,r,tL.empty(),Q.now()),n5(t,r)&&(n=n.insert(e,r))}),n})}}class sb{constructor(e){this.serializer=e,this.kr=new Map,this.qr=new Map}getBundleMetadata(e,t){return ef.resolve(this.kr.get(t))}saveBundleMetadata(e,t){return this.kr.set(t.id,{id:t.id,version:t.version,createTime:r7(t.createTime)}),ef.resolve()}getNamedQuery(e,t){return ef.resolve(this.qr.get(t))}saveNamedQuery(e,t){return this.qr.set(t.name,{name:t.name,query:ik(t.bundledQuery),readTime:r7(t.readTime)}),ef.resolve()}}class sE{constructor(){this.overlays=new tA(Z.comparator),this.Qr=new Map}getOverlay(e,t){return ef.resolve(this.overlays.get(t))}getOverlays(e,t){let n=rt();return ef.forEach(t,t=>this.getOverlay(e,t).next(e=>{null!==e&&n.set(t,e)})).next(()=>n)}saveOverlays(e,t,n){return n.forEach((n,r)=>{this.St(e,t,r)}),ef.resolve()}removeOverlaysForBatchId(e,t,n){let r=this.Qr.get(n);return void 0!==r&&(r.forEach(e=>this.overlays=this.overlays.remove(e)),this.Qr.delete(n)),ef.resolve()}getOverlaysForCollection(e,t,n){let r=rt(),i=t.length+1,s=new Z(t.child("")),a=this.overlays.getIteratorFrom(s);for(;a.hasNext();){let e=a.getNext().value,s=e.getKey();if(!t.isPrefixOf(s.path))break;s.path.length===i&&e.largestBatchId>n&&r.set(e.getKey(),e)}return ef.resolve(r)}getOverlaysForCollectionGroup(e,t,n,r){let i=new tA((e,t)=>e-t),s=this.overlays.getIterator();for(;s.hasNext();){let e=s.getNext().value;if(e.getKey().getCollectionGroup()===t&&e.largestBatchId>n){let t=i.get(e.largestBatchId);null===t&&(t=rt(),i=i.insert(e.largestBatchId,t)),t.set(e.getKey(),e)}}let a=rt(),o=i.getIterator();for(;o.hasNext()&&(o.getNext().value.forEach((e,t)=>a.set(e,t)),!(a.size()>=r)););return ef.resolve(a)}St(e,t,n){let r=this.overlays.get(n.key);if(null!==r){let e=this.Qr.get(r.largestBatchId).delete(n.key);this.Qr.set(r.largestBatchId,e)}this.overlays=this.overlays.insert(n.key,new rL(t,n));let i=this.Qr.get(t);void 0===i&&(i=ri(),this.Qr.set(t,i)),this.Qr.set(t,i.add(n.key))}}class sx{constructor(){this.sessionToken=tO.EMPTY_BYTE_STRING}getSessionToken(e){return ef.resolve(this.sessionToken)}setSessionToken(e,t){return this.sessionToken=t,ef.resolve()}}class sS{constructor(){this.$r=new tM(sC.Ur),this.Kr=new tM(sC.Wr)}isEmpty(){return this.$r.isEmpty()}addReference(e,t){let n=new sC(e,t);this.$r=this.$r.add(n),this.Kr=this.Kr.add(n)}Gr(e,t){e.forEach(e=>this.addReference(e,t))}removeReference(e,t){this.zr(new sC(e,t))}jr(e,t){e.forEach(e=>this.removeReference(e,t))}Hr(e){let t=new Z(new Y([])),n=new sC(t,e),r=new sC(t,e+1),i=[];return this.Kr.forEachInRange([n,r],e=>{this.zr(e),i.push(e.key)}),i}Jr(){this.$r.forEach(e=>this.zr(e))}zr(e){this.$r=this.$r.delete(e),this.Kr=this.Kr.delete(e)}Yr(e){let t=new Z(new Y([])),n=new sC(t,e),r=new sC(t,e+1),i=ri();return this.Kr.forEachInRange([n,r],e=>{i=i.add(e.key)}),i}containsKey(e){let t=new sC(e,0),n=this.$r.firstAfterOrEqual(t);return null!==n&&e.isEqual(n.key)}}class sC{constructor(e,t){this.key=e,this.Zr=t}static Ur(e,t){return Z.comparator(e.key,t.key)||z(e.Zr,t.Zr)}static Wr(e,t){return z(e.Zr,t.Zr)||Z.comparator(e.key,t.key)}}class sN{constructor(e,t){this.indexManager=e,this.referenceDelegate=t,this.mutationQueue=[],this.nr=1,this.Xr=new tM(sC.Ur)}checkEmpty(e){return ef.resolve(0===this.mutationQueue.length)}addMutationBatch(e,t,n,r){let i=this.nr;this.nr++,this.mutationQueue.length>0&&this.mutationQueue[this.mutationQueue.length-1];let s=new rF(i,t,n,r);for(let t of(this.mutationQueue.push(s),r))this.Xr=this.Xr.add(new sC(t.key,i)),this.indexManager.addToCollectionParentIndex(e,t.key.path.popLast());return ef.resolve(s)}lookupMutationBatch(e,t){return ef.resolve(this.ei(t))}getNextMutationBatchAfterBatchId(e,t){let n=this.ti(t+1),r=n<0?0:n;return ef.resolve(this.mutationQueue.length>r?this.mutationQueue[r]:null)}getHighestUnacknowledgedBatchId(){return ef.resolve(0===this.mutationQueue.length?-1:this.nr-1)}getAllMutationBatches(e){return ef.resolve(this.mutationQueue.slice())}getAllMutationBatchesAffectingDocumentKey(e,t){let n=new sC(t,0),r=new sC(t,Number.POSITIVE_INFINITY),i=[];return this.Xr.forEachInRange([n,r],e=>{let t=this.ei(e.Zr);i.push(t)}),ef.resolve(i)}getAllMutationBatchesAffectingDocumentKeys(e,t){let n=new tM(z);return t.forEach(e=>{let t=new sC(e,0),r=new sC(e,Number.POSITIVE_INFINITY);this.Xr.forEachInRange([t,r],e=>{n=n.add(e.Zr)})}),ef.resolve(this.ni(n))}getAllMutationBatchesAffectingQuery(e,t){let n=t.path,r=n.length+1,i=n;Z.isDocumentKey(i)||(i=i.child(""));let s=new sC(new Z(i),0),a=new tM(z);return this.Xr.forEachWhile(e=>{let t=e.key.path;return!!n.isPrefixOf(t)&&(t.length===r&&(a=a.add(e.Zr)),!0)},s),ef.resolve(this.ni(a))}ni(e){let t=[];return e.forEach(e=>{let n=this.ei(e);null!==n&&t.push(n)}),t}removeMutationBatch(e,t){C(0===this.ri(t.batchId,"removed"),55003),this.mutationQueue.shift();let n=this.Xr;return ef.forEach(t.mutations,r=>{let i=new sC(r.key,t.batchId);return n=n.delete(i),this.referenceDelegate.markPotentiallyOrphaned(e,r.key)}).next(()=>{this.Xr=n})}sr(e){}containsKey(e,t){let n=new sC(t,0),r=this.Xr.firstAfterOrEqual(n);return ef.resolve(t.isEqual(r&&r.key))}performConsistencyCheck(e){return this.mutationQueue.length,ef.resolve()}ri(e,t){return this.ti(e)}ti(e){return 0===this.mutationQueue.length?0:e-this.mutationQueue[0].batchId}ei(e){let t=this.ti(e);return t<0||t>=this.mutationQueue.length?null:this.mutationQueue[t]}}class sD{constructor(e){this.ii=e,this.docs=new tA(Z.comparator),this.size=0}setIndexManager(e){this.indexManager=e}addEntry(e,t){let n=t.key,r=this.docs.get(n),i=r?r.size:0,s=this.ii(t);return this.docs=this.docs.insert(n,{document:t.mutableCopy(),size:s}),this.size+=s-i,this.indexManager.addToCollectionParentIndex(e,n.path.popLast())}removeEntry(e){let t=this.docs.get(e);t&&(this.docs=this.docs.remove(e),this.size-=t.size)}getEntry(e,t){let n=this.docs.get(t);return ef.resolve(n?n.document.mutableCopy():ng.newInvalidDocument(t))}getEntries(e,t){let n=n8;return t.forEach(e=>{let t=this.docs.get(e);n=n.insert(e,t?t.document.mutableCopy():ng.newInvalidDocument(e))}),ef.resolve(n)}getDocumentsMatchingQuery(e,t,n,r){let i=n8,s=t.path,a=new Z(s.child("__id-9223372036854775808__")),o=this.docs.getIteratorFrom(a);for(;o.hasNext();){let{key:e,value:{document:a}}=o.getNext();if(!s.isPrefixOf(e.path))break;e.path.length>s.length+1||0>=eu(eo(a),n)||(r.has(a.key)||n5(t,a))&&(i=i.insert(a.key,a.mutableCopy()))}return ef.resolve(i)}getAllFromCollectionGroup(e,t,n,r){x(9500)}si(e,t){return ef.forEach(this.docs,e=>t(e))}newChangeBuffer(e){return new sA(this)}getSize(e){return ef.resolve(this.size)}}class sA extends sg{constructor(e){super(),this.Br=e}applyChanges(e){let t=[];return this.changes.forEach((n,r)=>{r.isValidDocument()?t.push(this.Br.addEntry(e,r)):this.Br.removeEntry(n)}),ef.waitFor(t)}getFromCache(e,t){return this.Br.getEntry(e,t)}getAllFromCache(e,t){return this.Br.getEntries(e,t)}}class sk{constructor(e){this.persistence=e,this.oi=new n6(e=>nO(e),nq),this.lastRemoteSnapshotVersion=j.min(),this.highestTargetId=0,this._i=0,this.ai=new sS,this.targetCount=0,this.ui=ss.cr()}forEachTarget(e,t){return this.oi.forEach((e,n)=>t(n)),ef.resolve()}getLastRemoteSnapshotVersion(e){return ef.resolve(this.lastRemoteSnapshotVersion)}getHighestSequenceNumber(e){return ef.resolve(this._i)}allocateTargetId(e){return this.highestTargetId=this.ui.next(),ef.resolve(this.highestTargetId)}setTargetsMetadata(e,t,n){return n&&(this.lastRemoteSnapshotVersion=n),t>this._i&&(this._i=t),ef.resolve()}Tr(e){this.oi.set(e.target,e);let t=e.targetId;t>this.highestTargetId&&(this.ui=new ss(t),this.highestTargetId=t),e.sequenceNumber>this._i&&(this._i=e.sequenceNumber)}addTargetData(e,t){return this.Tr(t),this.targetCount+=1,ef.resolve()}updateTargetData(e,t){return this.Tr(t),ef.resolve()}removeTargetData(e,t){return this.oi.delete(t.target),this.ai.Hr(t.targetId),this.targetCount-=1,ef.resolve()}removeTargets(e,t,n){let r=0,i=[];return this.oi.forEach((s,a)=>{a.sequenceNumber<=t&&null===n.get(a.targetId)&&(this.oi.delete(s),i.push(this.removeMatchingKeysForTargetId(e,a.targetId)),r++)}),ef.waitFor(i).next(()=>r)}getTargetCount(e){return ef.resolve(this.targetCount)}getTargetData(e,t){let n=this.oi.get(t)||null;return ef.resolve(n)}addMatchingKeys(e,t,n){return this.ai.Gr(t,n),ef.resolve()}removeMatchingKeys(e,t,n){this.ai.jr(t,n);let r=this.persistence.referenceDelegate,i=[];return r&&t.forEach(t=>{i.push(r.markPotentiallyOrphaned(e,t))}),ef.waitFor(i)}removeMatchingKeysForTargetId(e,t){return this.ai.Hr(t),ef.resolve()}getMatchingKeysForTargetId(e,t){let n=this.ai.Yr(t);return ef.resolve(n)}containsKey(e,t){return ef.resolve(this.ai.containsKey(t))}}class sR{constructor(e,t){this.ci={},this.overlays={},this.li=new eN(0),this.hi=!1,this.hi=!0,this.Pi=new sx,this.referenceDelegate=e(this),this.Ti=new sk(this),this.indexManager=new i2,this.remoteDocumentCache=new sD(e=>this.referenceDelegate.Ii(e)),this.serializer=new ib(t),this.Ei=new sb(this.serializer)}start(){return Promise.resolve()}shutdown(){return this.hi=!1,Promise.resolve()}get started(){return this.hi}setDatabaseDeletedListener(){}setNetworkEnabled(){}getIndexManager(e){return this.indexManager}getDocumentOverlayCache(e){let t=this.overlays[e.toKey()];return t||(t=new sE,this.overlays[e.toKey()]=t),t}getMutationQueue(e,t){let n=this.ci[e.toKey()];return n||(n=new sN(t,this.referenceDelegate),this.ci[e.toKey()]=n),n}getGlobalsCache(){return this.Pi}getTargetCache(){return this.Ti}getRemoteDocumentCache(){return this.remoteDocumentCache}getBundleCache(){return this.Ei}runTransaction(e,t,n){_("MemoryPersistence","Starting transaction:",e);let r=new sM(this.li.next());return this.referenceDelegate.di(),n(r).next(e=>this.referenceDelegate.Ai(r).next(()=>e)).toPromise().then(e=>(r.raiseOnCommittedEvent(),e))}Ri(e,t){return ef.or(Object.values(this.ci).map(n=>()=>n.containsKey(e,t)))}}class sM extends eh{constructor(e){super(),this.currentSequenceNumber=e}}class sF{constructor(e){this.persistence=e,this.Vi=new sS,this.mi=null}static fi(e){return new sF(e)}get gi(){if(this.mi)return this.mi;throw x(60996)}addReference(e,t,n){return this.Vi.addReference(n,t),this.gi.delete(n.toString()),ef.resolve()}removeReference(e,t,n){return this.Vi.removeReference(n,t),this.gi.add(n.toString()),ef.resolve()}markPotentiallyOrphaned(e,t){return this.gi.add(t.toString()),ef.resolve()}removeTarget(e,t){this.Vi.Hr(t.targetId).forEach(e=>this.gi.add(e.toString()));let n=this.persistence.getTargetCache();return n.getMatchingKeysForTargetId(e,t.targetId).next(e=>{e.forEach(e=>this.gi.add(e.toString()))}).next(()=>n.removeTargetData(e,t))}di(){this.mi=new Set}Ai(e){let t=this.persistence.getRemoteDocumentCache().newChangeBuffer();return ef.forEach(this.gi,n=>{let r=Z.fromPath(n);return this.pi(e,r).next(e=>{e||t.removeEntry(r,j.min())})}).next(()=>(this.mi=null,t.apply(e)))}updateLimboDocument(e,t){return this.pi(e,t).next(e=>{e?this.gi.delete(t.toString()):this.gi.add(t.toString())})}Ii(e){return 0}pi(e,t){return ef.or([()=>ef.resolve(this.Vi.containsKey(t)),()=>this.persistence.getTargetCache().containsKey(e,t),()=>this.persistence.Ri(e,t)])}}class sV{constructor(e,t){this.persistence=e,this.yi=new n6(e=>eR(e.path),(e,t)=>e.isEqual(t)),this.garbageCollector=new sd(this,t)}static fi(e,t){return new sV(e,t)}di(){}Ai(e){return ef.resolve()}forEachTarget(e,t){return this.persistence.getTargetCache().forEachTarget(e,t)}pr(e){let t=this.br(e);return this.persistence.getTargetCache().getTargetCount(e).next(e=>t.next(t=>e+t))}br(e){let t=0;return this.yr(e,e=>{t++}).next(()=>t)}yr(e,t){return ef.forEach(this.yi,(n,r)=>this.Dr(e,n,r).next(e=>e?ef.resolve():t(r)))}removeTargets(e,t,n){return this.persistence.getTargetCache().removeTargets(e,t,n)}removeOrphanedDocuments(e,t){let n=0,r=this.persistence.getRemoteDocumentCache(),i=r.newChangeBuffer();return r.si(e,r=>this.Dr(e,r,t).next(e=>{e||(n++,i.removeEntry(r,j.min()))})).next(()=>i.apply(e)).next(()=>n)}markPotentiallyOrphaned(e,t){return this.yi.set(t,e.currentSequenceNumber),ef.resolve()}removeTarget(e,t){let n=t.withSequenceNumber(e.currentSequenceNumber);return this.persistence.getTargetCache().updateTargetData(e,n)}addReference(e,t,n){return this.yi.set(n,e.currentSequenceNumber),ef.resolve()}removeReference(e,t,n){return this.yi.set(n,e.currentSequenceNumber),ef.resolve()}updateLimboDocument(e,t){return this.yi.set(t,e.currentSequenceNumber),ef.resolve()}Ii(e){let t=e.key.toString().length;return e.isFoundDocument()&&(t+=function e(t){switch(t3(t)){case 0:case 1:return 4;case 2:return 8;case 3:case 8:return 16;case 4:let n=tW(t);return n?16+e(n):16;case 5:return 2*t.stringValue.length;case 6:return tz(t.bytesValue).approximateByteSize();case 7:return t.referenceValue.length;case 9:return(t.arrayValue.values||[]).reduce((t,n)=>t+e(n),0);case 10:case 11:var r;let i;return r=t.mapValue,i=0,tC(r.fields,(t,n)=>{i+=t.length+e(n)}),i;default:throw x(13486,{value:t})}}(e.data.value)),t}Dr(e,t,n){return ef.or([()=>this.persistence.Ri(e,t),()=>this.persistence.getTargetCache().containsKey(e,t),()=>{let e=this.yi.get(t);return ef.resolve(void 0!==e&&e>n)}])}getCacheSize(e){return this.persistence.getRemoteDocumentCache().getSize(e)}}class sL{constructor(e){this.serializer=e}q(e,t,n,r){let i=new eg("createOrUpgrade",t);n<1&&r>=1&&(e.createObjectStore(eV),e.createObjectStore(eP,{keyPath:"userId"}),e.createObjectStore(eO,{keyPath:eq,autoIncrement:!0}).createIndex(eU,eB,{unique:!0}),e.createObjectStore(e$),sP(e),e.createObjectStore(eF));let s=ef.resolve();return n<3&&r>=3&&(0!==n&&(e.deleteObjectStore(e1),e.deleteObjectStore(eX),e.deleteObjectStore(e6),sP(e)),s=s.next(()=>(function(e){let t=e.store(e6),n={highestTargetId:0,highestListenSequenceNumber:0,lastRemoteSnapshotVersion:j.min().toTimestamp(),targetCount:0};return t.put(e3,n)})(i))),n<4&&r>=4&&(0!==n&&(s=s.next(()=>i.store(eO).J().next(t=>{e.deleteObjectStore(eO),e.createObjectStore(eO,{keyPath:eq,autoIncrement:!0}).createIndex(eU,eB,{unique:!0});let n=i.store(eO),r=t.map(e=>n.put(e));return ef.waitFor(r)}))),s=s.next(()=>{e.createObjectStore(e7,{keyPath:"clientId"})})),n<5&&r>=5&&(s=s.next(()=>this.wi(i))),n<6&&r>=6&&(s=s.next(()=>(e.createObjectStore(eY),this.bi(i)))),n<7&&r>=7&&(s=s.next(()=>this.Si(i))),n<8&&r>=8&&(s=s.next(()=>this.Di(e,i))),n<9&&r>=9&&(s=s.next(()=>{e.objectStoreNames.contains("remoteDocumentChanges")&&e.deleteObjectStore("remoteDocumentChanges")})),n<10&&r>=10&&(s=s.next(()=>this.Ci(i))),n<11&&r>=11&&(s=s.next(()=>{e.createObjectStore(te,{keyPath:"bundleId"}),e.createObjectStore(tt,{keyPath:"name"})})),n<12&&r>=12&&(s=s.next(()=>{let t=e.createObjectStore(td,{keyPath:tf});t.createIndex(tm,tg,{unique:!1}),t.createIndex(tp,ty,{unique:!1})})),n<13&&r>=13&&(s=s.next(()=>(function(e){let t=e.createObjectStore(eK,{keyPath:eG});t.createIndex(eQ,ej),t.createIndex(eW,eH)})(e)).next(()=>this.Fi(e,i)).next(()=>e.deleteObjectStore(eF))),n<14&&r>=14&&(s=s.next(()=>this.Mi(e,i))),n<15&&r>=15&&(s=s.next(()=>{e.createObjectStore(tn,{keyPath:"indexId",autoIncrement:!0}).createIndex(tr,"collectionGroup",{unique:!1}),e.createObjectStore(ti,{keyPath:ts}).createIndex(ta,to,{unique:!1}),e.createObjectStore(tl,{keyPath:tu}).createIndex(tc,th,{unique:!1})})),n<16&&r>=16&&(s=s.next(()=>{t.objectStore(ti).clear()}).next(()=>{t.objectStore(tl).clear()})),n<17&&r>=17&&(s=s.next(()=>{e.createObjectStore(tw,{keyPath:"name"})})),n<18&&r>=18&&d.isSafariOrWebkit()&&(s=s.next(()=>{t.objectStore(ti).clear()}).next(()=>{t.objectStore(tl).clear()})),s}bi(e){let t=0;return e.store(eF).te((e,n)=>{t+=st(n)}).next(()=>{let n={byteSize:t};return e.store(eY).put(eJ,n)})}wi(e){let t=e.store(eP),n=e.store(eO);return t.J().next(t=>ef.forEach(t,t=>{let r=IDBKeyRange.bound([t.userId,-1],[t.userId,t.lastAcknowledgedBatchId]);return n.J(eU,r).next(n=>ef.forEach(n,n=>{C(n.userId===t.userId,18650,"Cannot process batch from unexpected user",{batchId:n.batchId});let r=iN(this.serializer,n);return se(e,t.userId,r).next(()=>{})}))}))}Si(e){let t=e.store(e1),n=e.store(eF);return e.store(e6).get(e3).next(e=>{let r=[];return n.te((n,i)=>{let s=new Y(n),a=[0,eR(s)];r.push(t.get(a).next(n=>n?ef.resolve():t.put({targetId:0,path:eR(s),sequenceNumber:e.highestListenSequenceNumber})))}).next(()=>ef.waitFor(r))})}Di(e,t){e.createObjectStore(e8,{keyPath:e9});let n=t.store(e8),r=new i5,i=e=>{if(r.add(e)){let t=e.lastSegment(),r=e.popLast();return n.put({collectionId:t,parent:eR(r)})}};return t.store(eF).te({ee:!0},(e,t)=>i(new Y(e).popLast())).next(()=>t.store(e$).te({ee:!0},([e,t,n],r)=>i(eM(t).popLast())))}Ci(e){let t=e.store(eX);return t.te((e,n)=>{let r=iD(n),i=iA(this.serializer,r);return t.put(i)})}Fi(e,t){let n=t.store(eF),r=[];return n.te((e,n)=>{let i=t.store(eK),s=(n.document?new Z(Y.fromString(n.document.name).popFirst(5)):n.noDocument?Z.fromSegments(n.noDocument.path):n.unknownDocument?Z.fromSegments(n.unknownDocument.path):x(36783)).path.toArray(),a={prefixPath:s.slice(0,s.length-2),collectionGroup:s[s.length-2],documentId:s[s.length-1],readTime:n.readTime||[0,0],unknownDocument:n.unknownDocument,noDocument:n.noDocument,document:n.document,hasCommittedMutations:!!n.hasCommittedMutations};r.push(i.put(a))}).next(()=>ef.waitFor(r))}Mi(e,t){let n=t.store(eO),r=new sp(this.serializer),i=new sR(sF.fi,this.serializer.wt);return n.J().next(e=>{let n=new Map;return e.forEach(e=>{var t;let r=null!=(t=n.get(e.userId))?t:ri();iN(this.serializer,e).keys().forEach(e=>r=r.add(e)),n.set(e.userId,r)}),ef.forEach(n,(e,n)=>{let s=new y(n),a=iL.bt(this.serializer,s),o=i.getIndexManager(s);return new sT(r,sn.bt(s,this.serializer,o,i.referenceDelegate),a,o).recalculateAndSaveOverlaysForDocumentKeys(new tE(t,eN.le),e).next()})})}}function sP(e){e.createObjectStore(e1,{keyPath:e2}).createIndex(e5,e4,{unique:!0}),e.createObjectStore(eX,{keyPath:"targetId"}).createIndex(eZ,e0,{unique:!0}),e.createObjectStore(e6)}let sO="IndexedDbPersistence",sq="Failed to obtain exclusive access to the persistence layer. To allow shared access, multi-tab synchronization has to be enabled in all tabs. If you are using `experimentalForceOwningTab:true`, make sure that only one tab has persistence enabled at any given time.",sU="main";class sB{constructor(e,t,n,r,i,s,a,o,l,u,c=18){if(this.allowTabSynchronization=e,this.persistenceKey=t,this.clientId=n,this.xi=i,this.window=s,this.document=a,this.Oi=l,this.Ni=u,this.Bi=c,this.li=null,this.hi=!1,this.isPrimary=!1,this.networkEnabled=!0,this.Li=null,this.inForeground=!1,this.ki=null,this.qi=null,this.Qi=Number.NEGATIVE_INFINITY,this.$i=e=>Promise.resolve(),!sB.C())throw new D(N.UNIMPLEMENTED,"This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.");this.referenceDelegate=new sf(this,r),this.Ui=t+sU,this.serializer=new ib(o),this.Ki=new ep(this.Ui,this.Bi,new sL(this.serializer)),this.Pi=new iP,this.Ti=new sa(this.referenceDelegate,this.serializer),this.remoteDocumentCache=new sp(this.serializer),this.Ei=new iV,this.window&&this.window.localStorage?this.Wi=this.window.localStorage:(this.Wi=null,!1===u&&T(sO,"LocalStorage is unavailable. As a result, persistence may not work reliably. In particular enablePersistence() could fail immediately after refreshing the page."))}start(){return this.Gi().then(()=>{if(!this.isPrimary&&!this.allowTabSynchronization)throw new D(N.FAILED_PRECONDITION,sq);return this.zi(),this.ji(),this.Hi(),this.runTransaction("getHighestListenSequenceNumber","readonly",e=>this.Ti.getHighestSequenceNumber(e))}).then(e=>{this.li=new eN(e,this.Oi)}).then(()=>{this.hi=!0}).catch(e=>(this.Ki&&this.Ki.close(),Promise.reject(e)))}Ji(e){return this.$i=async t=>{if(this.started)return e(t)},e(this.isPrimary)}setDatabaseDeletedListener(e){this.Ki.U(async t=>{null===t.newVersion&&await e()})}setNetworkEnabled(e){this.networkEnabled!==e&&(this.networkEnabled=e,this.xi.enqueueAndForget(async()=>{this.started&&await this.Gi()}))}Gi(){return this.runTransaction("updateClientMetadataAndTryBecomePrimary","readwrite",e=>tx(e,e7).put({clientId:this.clientId,updateTimeMs:Date.now(),networkEnabled:this.networkEnabled,inForeground:this.inForeground}).next(()=>{if(this.isPrimary)return this.Yi(e).next(e=>{e||(this.isPrimary=!1,this.xi.enqueueRetryable(()=>this.$i(!1)))})}).next(()=>this.Zi(e)).next(t=>this.isPrimary&&!t?this.Xi(e).next(()=>!1):!!t&&this.es(e).next(()=>!0))).catch(e=>{if(eI(e))return _(sO,"Failed to extend owner lease: ",e),this.isPrimary;if(!this.allowTabSynchronization)throw e;return _(sO,"Releasing owner lease after error during lease refresh",e),!1}).then(e=>{this.isPrimary!==e&&this.xi.enqueueRetryable(()=>this.$i(e)),this.isPrimary=e})}Yi(e){return tx(e,eV).get(eL).next(e=>ef.resolve(this.ts(e)))}ns(e){return tx(e,e7).delete(this.clientId)}async rs(){if(this.isPrimary&&!this.ss(this.Qi,18e5)){this.Qi=Date.now();let e=await this.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary",e=>{let t=tx(e,e7);return t.J().next(e=>{let n=this._s(e,18e5),r=e.filter(e=>-1===n.indexOf(e));return ef.forEach(r,e=>t.delete(e.clientId)).next(()=>r)})}).catch(()=>[]);if(this.Wi)for(let t of e)this.Wi.removeItem(this.us(t.clientId))}}Hi(){this.qi=this.xi.enqueueAfterDelay("client_metadata_refresh",4e3,()=>this.Gi().then(()=>this.rs()).then(()=>this.Hi()))}ts(e){return!!e&&e.ownerId===this.clientId}Zi(e){return this.Ni?ef.resolve(!0):tx(e,eV).get(eL).next(t=>{if(null!==t&&this.ss(t.leaseTimestampMs,5e3)&&!this.cs(t.ownerId)){if(this.ts(t)&&this.networkEnabled)return!0;if(!this.ts(t)){if(!t.allowTabSynchronization)throw new D(N.FAILED_PRECONDITION,sq);return!1}}return!(!this.networkEnabled||!this.inForeground)||tx(e,e7).J().next(e=>void 0===this._s(e,5e3).find(e=>{if(this.clientId!==e.clientId){let t=!this.networkEnabled&&e.networkEnabled,n=!this.inForeground&&e.inForeground,r=this.networkEnabled===e.networkEnabled;if(t||n&&r)return!0}return!1}))}).next(e=>(this.isPrimary!==e&&_(sO,`Client ${e?"is":"is not"} eligible for a primary lease.`),e))}async shutdown(){this.hi=!1,this.ls(),this.qi&&(this.qi.cancel(),this.qi=null),this.hs(),this.Ps(),await this.Ki.runTransaction("shutdown","readwrite",[eV,e7],e=>{let t=new tE(e,eN.le);return this.Xi(t).next(()=>this.ns(t))}),this.Ki.close(),this.Ts()}_s(e,t){return e.filter(e=>this.ss(e.updateTimeMs,t)&&!this.cs(e.clientId))}Is(){return this.runTransaction("getActiveClients","readonly",e=>tx(e,e7).J().next(e=>this._s(e,18e5).map(e=>e.clientId)))}get started(){return this.hi}getGlobalsCache(){return this.Pi}getMutationQueue(e,t){return sn.bt(e,this.serializer,t,this.referenceDelegate)}getTargetCache(){return this.Ti}getRemoteDocumentCache(){return this.remoteDocumentCache}getIndexManager(e){return new i6(e,this.serializer.wt.databaseId)}getDocumentOverlayCache(e){return iL.bt(this.serializer,e)}getBundleCache(){return this.Ei}runTransaction(e,t,n){var r;let i;_(sO,"Starting transaction:",e);let s=18===(r=this.Bi)||17===r?tb:16===r||15===r?tT:14===r||13===r?t_:12===r?tI:11===r?tv:void x(60245);return this.Ki.runTransaction(e,"readonly"===t?"readonly":"readwrite",s,r=>(i=new tE(r,this.li?this.li.next():eN.le),"readwrite-primary"===t?this.Yi(i).next(e=>!!e||this.Zi(i)).next(t=>{if(!t)throw T(`Failed to obtain primary lease for action '${e}'.`),this.isPrimary=!1,this.xi.enqueueRetryable(()=>this.$i(!1)),new D(N.FAILED_PRECONDITION,ec);return n(i)}).next(e=>this.es(i).next(()=>e)):this.Es(i).next(()=>n(i)))).then(e=>(i.raiseOnCommittedEvent(),e))}Es(e){return tx(e,eV).get(eL).next(e=>{if(null!==e&&this.ss(e.leaseTimestampMs,5e3)&&!this.cs(e.ownerId)&&!this.ts(e)&&!(this.Ni||this.allowTabSynchronization&&e.allowTabSynchronization))throw new D(N.FAILED_PRECONDITION,sq)})}es(e){let t={ownerId:this.clientId,allowTabSynchronization:this.allowTabSynchronization,leaseTimestampMs:Date.now()};return tx(e,eV).put(eL,t)}static C(){return ep.C()}Xi(e){let t=tx(e,eV);return t.get(eL).next(e=>this.ts(e)?(_(sO,"Releasing primary lease."),t.delete(eL)):ef.resolve())}ss(e,t){let n=Date.now();return!(e<n-t)&&(!(e>n)||(T(`Detected an update time that is in the future: ${e} > ${n}`),!1))}zi(){null!==this.document&&"function"==typeof this.document.addEventListener&&(this.ki=()=>{this.xi.enqueueAndForget(()=>(this.inForeground="visible"===this.document.visibilityState,this.Gi()))},this.document.addEventListener("visibilitychange",this.ki),this.inForeground="visible"===this.document.visibilityState)}hs(){this.ki&&(this.document.removeEventListener("visibilitychange",this.ki),this.ki=null)}ji(){var e;"function"==typeof(null==(e=this.window)?void 0:e.addEventListener)&&(this.Li=()=>{this.ls();let e=/(?:Version|Mobile)\/1[456]/;d.isSafari()&&(navigator.appVersion.match(e)||navigator.userAgent.match(e))&&this.xi.enterRestrictedMode(!0),this.xi.enqueueAndForget(()=>this.shutdown())},this.window.addEventListener("pagehide",this.Li))}Ps(){this.Li&&(this.window.removeEventListener("pagehide",this.Li),this.Li=null)}cs(e){var t;try{let n=null!==(null==(t=this.Wi)?void 0:t.getItem(this.us(e)));return _(sO,`Client '${e}' ${n?"is":"is not"} zombied in LocalStorage`),n}catch(e){return T(sO,"Failed to get zombied client id.",e),!1}}ls(){if(this.Wi)try{this.Wi.setItem(this.us(this.clientId),String(Date.now()))}catch(e){T("Failed to set zombie client id.",e)}}Ts(){if(this.Wi)try{this.Wi.removeItem(this.us(this.clientId))}catch(e){}}us(e){return`firestore_zombie_${this.persistenceKey}_${e}`}}function sz(e,t){let n=e.projectId;return e.isDefaultDatabase||(n+="."+e.database),"firestore/"+t+"/"+n+"/"}class s${constructor(e,t,n,r){this.targetId=e,this.fromCache=t,this.ds=n,this.As=r}static Rs(e,t){let n=ri(),r=ri();for(let e of t.docChanges)switch(e.type){case 0:n=n.add(e.doc.key);break;case 1:r=r.add(e.doc.key)}return new s$(e,t.fromCache,n,r)}}class sK{constructor(){this._documentReadCount=0}get documentReadCount(){return this._documentReadCount}incrementDocumentReadCount(e){this._documentReadCount+=e}}class sG{constructor(){this.Vs=!1,this.fs=!1,this.gs=100,this.ps=d.isSafari()?8:ey(d.getUA())>0?6:4}initialize(e,t){this.ys=e,this.indexManager=t,this.Vs=!0}getDocumentsMatchingQuery(e,t,n,r){let i={result:null};return this.ws(e,t).next(e=>{i.result=e}).next(()=>{if(!i.result)return this.bs(e,t,r,n).next(e=>{i.result=e})}).next(()=>{if(i.result)return;let n=new sK;return this.Ss(e,t,n).next(r=>{if(i.result=r,this.fs)return this.Ds(e,t,n,r.size)})}).next(()=>i.result)}Ds(e,t,n,r){return n.documentReadCount<this.gs?(I()<=h.LogLevel.DEBUG&&_("QueryEngine","SDK will not create cache indexes for query:",n2(t),"since it only creates cache indexes for collection contains","more than or equal to",this.gs,"documents"),ef.resolve()):(I()<=h.LogLevel.DEBUG&&_("QueryEngine","Query:",n2(t),"scans",n.documentReadCount,"local documents and returns",r,"documents as results."),n.documentReadCount>this.ps*r?(I()<=h.LogLevel.DEBUG&&_("QueryEngine","The SDK decides to create cache indexes for query:",n2(t),"as using cache indexes may help improve performance."),this.indexManager.createTargetIndexes(e,nH(t))):ef.resolve())}ws(e,t){if(nQ(t))return ef.resolve(null);let n=nH(t);return this.indexManager.getIndexType(e,n).next(r=>0===r?null:(null!==t.limit&&1===r&&(n=nH(t=nZ(t,null,"F"))),this.indexManager.getDocumentsMatchingTarget(e,n).next(r=>{let i=ri(...r);return this.ys.getDocuments(e,i).next(r=>this.indexManager.getMinOffset(e,n).next(n=>{let s=this.vs(t,r);return this.Cs(t,s,i,n.readTime)?this.ws(e,nZ(t,null,"F")):this.Fs(e,s,t,n)}))})))}bs(e,t,n,r){return nQ(t)||r.isEqual(j.min())?ef.resolve(null):this.ys.getDocuments(e,n).next(i=>{let s=this.vs(t,i);return this.Cs(t,s,n,r)?ef.resolve(null):(I()<=h.LogLevel.DEBUG&&_("QueryEngine","Re-using previous result from %s to execute query: %s",r.toString(),n2(t)),this.Fs(e,s,t,ea(r,-1)).next(e=>e))})}vs(e,t){let n=new tM(n3(e));return t.forEach((t,r)=>{n5(e,r)&&(n=n.add(r))}),n}Cs(e,t,n,r){if(null===e.limit)return!1;if(n.size!==t.size)return!0;let i="F"===e.limitType?t.last():t.first();return!!i&&(i.hasPendingWrites||i.version.compareTo(r)>0)}Ss(e,t,n){return I()<=h.LogLevel.DEBUG&&_("QueryEngine","Using full collection scan to execute query:",n2(t)),this.ys.getDocumentsMatchingQuery(e,t,el.min(),n)}Fs(e,t,n,r){return this.ys.getDocumentsMatchingQuery(e,n,r).next(e=>(t.forEach(t=>{e=e.insert(t.key,t)}),e))}}let sQ="LocalStore";class sj{constructor(e,t,n,r){this.persistence=e,this.Ms=t,this.serializer=r,this.xs=new tA(z),this.Os=new n6(e=>nO(e),nq),this.Ns=new Map,this.Bs=e.getRemoteDocumentCache(),this.Ti=e.getTargetCache(),this.Ei=e.getBundleCache(),this.Ls(n)}Ls(e){this.documentOverlayCache=this.persistence.getDocumentOverlayCache(e),this.indexManager=this.persistence.getIndexManager(e),this.mutationQueue=this.persistence.getMutationQueue(e,this.indexManager),this.localDocuments=new sT(this.Bs,this.mutationQueue,this.documentOverlayCache,this.indexManager),this.Bs.setIndexManager(this.indexManager),this.Ms.initialize(this.localDocuments,this.indexManager)}collectGarbage(e){return this.persistence.runTransaction("Collect garbage","readwrite-primary",t=>e.collect(t,this.xs))}}async function sW(e,t){return await e.persistence.runTransaction("Handle user change","readonly",n=>{let r;return e.mutationQueue.getAllMutationBatches(n).next(i=>(r=i,e.Ls(t),e.mutationQueue.getAllMutationBatches(n))).next(t=>{let i=[],s=[],a=ri();for(let e of r)for(let t of(i.push(e.batchId),e.mutations))a=a.add(t.key);for(let e of t)for(let t of(s.push(e.batchId),e.mutations))a=a.add(t.key);return e.localDocuments.getDocuments(n,a).next(e=>({ks:e,removedBatchIds:i,addedBatchIds:s}))})})}function sH(e){return e.persistence.runTransaction("Get last remote snapshot version","readonly",t=>e.Ti.getLastRemoteSnapshotVersion(t))}function sY(e,t,n){let r=ri(),i=ri();return n.forEach(e=>r=r.add(e)),t.getEntries(e,r).next(e=>{let r=n8;return n.forEach((n,s)=>{let a=e.get(n);s.isFoundDocument()!==a.isFoundDocument()&&(i=i.add(n)),s.isNoDocument()&&s.version.isEqual(j.min())?(t.removeEntry(n,s.readTime),r=r.insert(n,s)):!a.isValidDocument()||s.version.compareTo(a.version)>0||0===s.version.compareTo(a.version)&&a.hasPendingWrites?(t.addEntry(s),r=r.insert(n,s)):_(sQ,"Ignoring outdated watch update for ",n,". Current version:",a.version," Watch version:",s.version)}),{qs:r,Qs:i}})}function sJ(e,t){return e.persistence.runTransaction("Allocate target","readwrite",n=>{let r;return e.Ti.getTargetData(n,t).next(i=>i?(r=i,ef.resolve(r)):e.Ti.allocateTargetId(n).next(i=>(r=new iT(t,i,"TargetPurposeListen",n.currentSequenceNumber),e.Ti.addTargetData(n,r).next(()=>r))))}).then(n=>{let r=e.xs.get(n.targetId);return(null===r||n.snapshotVersion.compareTo(r.snapshotVersion)>0)&&(e.xs=e.xs.insert(n.targetId,n),e.Os.set(t,n.targetId)),n})}async function sX(e,t,n){let r=e.xs.get(t);try{n||await e.persistence.runTransaction("Release target",n?"readwrite":"readwrite-primary",t=>e.persistence.referenceDelegate.removeTarget(t,r))}catch(e){if(!eI(e))throw e;_(sQ,`Failed to update sequence numbers for target ${t}: ${e}`)}e.xs=e.xs.remove(t),e.Os.delete(r.target)}function sZ(e,t,n){let r=j.min(),i=ri();return e.persistence.runTransaction("Execute query","readwrite",s=>(function(e,t,n){let r=e.Os.get(n);return void 0!==r?ef.resolve(e.xs.get(r)):e.Ti.getTargetData(t,n)})(e,s,nH(t)).next(t=>{if(t)return r=t.lastLimboFreeSnapshotVersion,e.Ti.getMatchingKeysForTargetId(s,t.targetId).next(e=>{i=e})}).next(()=>e.Ms.getDocumentsMatchingQuery(s,t,n?r:j.min(),n?i:ri())).next(n=>(s2(e,n4(t),n),{documents:n,$s:i})))}function s0(e,t){let n=e.Ti,r=e.xs.get(t);return r?Promise.resolve(r.target):e.persistence.runTransaction("Get target data","readonly",e=>n.Rt(e,t).next(e=>e?e.target:null))}function s1(e,t){let n=e.Ns.get(t)||j.min();return e.persistence.runTransaction("Get new document changes","readonly",r=>e.Bs.getAllFromCollectionGroup(r,t,ea(n,-1),Number.MAX_SAFE_INTEGER)).then(n=>(s2(e,t,n),n))}function s2(e,t,n){let r=e.Ns.get(t)||j.min();n.forEach((e,t)=>{t.readTime.compareTo(r)>0&&(r=t.readTime)}),e.Ns.set(t,r)}async function s5(e,t,n,r){let i=ri(),s=n8;for(let e of n){let n=t.Us(e.metadata.name);e.document&&(i=i.add(n));let r=t.Ks(e);r.setReadTime(t.Ws(e.metadata.readTime)),s=s.insert(n,r)}let a=e.Bs.newChangeBuffer({trackRemovals:!0}),o=await sJ(e,nH(nG(Y.fromString(`__bundle__/docs/${r}`))));return e.persistence.runTransaction("Apply bundle documents","readwrite",t=>sY(t,a,s).next(e=>(a.apply(t),e)).next(n=>e.Ti.removeMatchingKeysForTargetId(t,o.targetId).next(()=>e.Ti.addMatchingKeys(t,i,o.targetId)).next(()=>e.localDocuments.getLocalViewOfDocuments(t,n.qs,n.Qs)).next(()=>n.qs)))}async function s4(e,t,n=ri()){let r=await sJ(e,nH(ik(t.bundledQuery)));return e.persistence.runTransaction("Save named query","readwrite",i=>{let s=r7(t.readTime);if(r.snapshotVersion.compareTo(s)>=0)return e.Ei.saveNamedQuery(i,t);let a=r.withResumeToken(tO.EMPTY_BYTE_STRING,s);return e.xs=e.xs.insert(a.targetId,a),e.Ti.updateTargetData(i,a).next(()=>e.Ti.removeMatchingKeysForTargetId(i,r.targetId)).next(()=>e.Ti.addMatchingKeys(i,n,r.targetId)).next(()=>e.Ei.saveNamedQuery(i,t))})}let s3="firestore_clients";function s6(e,t){return`${s3}_${e}_${t}`}let s8="firestore_mutations";function s9(e,t,n){let r=`${s8}_${e}_${n}`;return t.isAuthenticated()&&(r+=`_${t.uid}`),r}let s7="firestore_targets";function ae(e,t){return`${s7}_${e}_${t}`}let at="SharedClientState";class an{constructor(e,t,n,r){this.user=e,this.batchId=t,this.state=n,this.error=r}static Gs(e,t,n){let r=JSON.parse(n),i,s="object"==typeof r&&-1!==["pending","acknowledged","rejected"].indexOf(r.state)&&(void 0===r.error||"object"==typeof r.error);return s&&r.error&&(s="string"==typeof r.error.message&&"string"==typeof r.error.code)&&(i=new D(r.error.code,r.error.message)),s?new an(e,t,r.state,i):(T(at,`Failed to parse mutation state for ID '${t}': ${n}`),null)}zs(){let e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}}class ar{constructor(e,t,n){this.targetId=e,this.state=t,this.error=n}static Gs(e,t){let n=JSON.parse(t),r,i="object"==typeof n&&-1!==["not-current","current","rejected"].indexOf(n.state)&&(void 0===n.error||"object"==typeof n.error);return i&&n.error&&(i="string"==typeof n.error.message&&"string"==typeof n.error.code)&&(r=new D(n.error.code,n.error.message)),i?new ar(e,n.state,r):(T(at,`Failed to parse target state for ID '${e}': ${t}`),null)}zs(){let e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}}class ai{constructor(e,t){this.clientId=e,this.activeTargetIds=t}static Gs(e,t){let n=JSON.parse(t),r="object"==typeof n&&n.activeTargetIds instanceof Array,i=rs;for(let e=0;r&&e<n.activeTargetIds.length;++e)r=ek(n.activeTargetIds[e]),i=i.add(n.activeTargetIds[e]);return r?new ai(e,i):(T(at,`Failed to parse client data for instance '${e}': ${t}`),null)}}class as{constructor(e,t){this.clientId=e,this.onlineState=t}static Gs(e){let t=JSON.parse(e);return"object"==typeof t&&-1!==["Unknown","Online","Offline"].indexOf(t.onlineState)&&"string"==typeof t.clientId?new as(t.clientId,t.onlineState):(T(at,`Failed to parse online state: ${e}`),null)}}class aa{constructor(){this.activeTargetIds=rs}js(e){this.activeTargetIds=this.activeTargetIds.add(e)}Hs(e){this.activeTargetIds=this.activeTargetIds.delete(e)}zs(){return JSON.stringify({activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()})}}class ao{constructor(e,t,n,r,i){var s,a,o;this.window=e,this.xi=t,this.persistenceKey=n,this.Js=r,this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null,this.Ys=this.Zs.bind(this),this.Xs=new tA(z),this.started=!1,this.eo=[];let l=n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");this.storage=this.window.localStorage,this.currentUser=i,this.no=s6(this.persistenceKey,this.Js),this.ro=(s=this.persistenceKey,`firestore_sequence_number_${s}`),this.Xs=this.Xs.insert(this.Js,new aa),this.io=RegExp(`^${s3}_${l}_([^_]*)$`),this.so=RegExp(`^${s8}_${l}_(\\d+)(?:_(.*))?$`),this.oo=RegExp(`^${s7}_${l}_(\\d+)$`),this._o=(a=this.persistenceKey,`firestore_online_state_${a}`),this.ao=(o=this.persistenceKey,`firestore_bundle_loaded_v2_${o}`),this.window.addEventListener("storage",this.Ys)}static C(e){return!(!e||!e.localStorage)}async start(){for(let e of(await this.syncEngine.Is())){if(e===this.Js)continue;let t=this.getItem(s6(this.persistenceKey,e));if(t){let n=ai.Gs(e,t);n&&(this.Xs=this.Xs.insert(n.clientId,n))}}this.uo();let e=this.storage.getItem(this._o);if(e){let t=this.co(e);t&&this.lo(t)}for(let e of this.eo)this.Zs(e);this.eo=[],this.window.addEventListener("pagehide",()=>this.shutdown()),this.started=!0}writeSequenceNumber(e){this.setItem(this.ro,JSON.stringify(e))}getAllActiveQueryTargets(){return this.ho(this.Xs)}isActiveQueryTarget(e){let t=!1;return this.Xs.forEach((n,r)=>{r.activeTargetIds.has(e)&&(t=!0)}),t}addPendingMutation(e){this.Po(e,"pending")}updateMutationState(e,t,n){this.Po(e,t,n),this.To(e)}addLocalQueryTarget(e,t=!0){let n="not-current";if(this.isActiveQueryTarget(e)){let t=this.storage.getItem(ae(this.persistenceKey,e));if(t){let r=ar.Gs(e,t);r&&(n=r.state)}}return t&&this.Io.js(e),this.uo(),n}removeLocalQueryTarget(e){this.Io.Hs(e),this.uo()}isLocalQueryTarget(e){return this.Io.activeTargetIds.has(e)}clearQueryState(e){this.removeItem(ae(this.persistenceKey,e))}updateQueryState(e,t,n){this.Eo(e,t,n)}handleUserChange(e,t,n){t.forEach(e=>{this.To(e)}),this.currentUser=e,n.forEach(e=>{this.addPendingMutation(e)})}setOnlineState(e){this.Ao(e)}notifyBundleLoaded(e){this.Ro(e)}shutdown(){this.started&&(this.window.removeEventListener("storage",this.Ys),this.removeItem(this.no),this.started=!1)}getItem(e){let t=this.storage.getItem(e);return _(at,"READ",e,t),t}setItem(e,t){_(at,"SET",e,t),this.storage.setItem(e,t)}removeItem(e){_(at,"REMOVE",e),this.storage.removeItem(e)}Zs(e){if(e.storageArea===this.storage){if(_(at,"EVENT",e.key,e.newValue),e.key===this.no)return void T("Received WebStorage notification for local change. Another client might have garbage-collected our state");this.xi.enqueueRetryable(async()=>{if(this.started){if(null!==e.key){if(this.io.test(e.key)){if(null==e.newValue){let t=this.Vo(e.key);return this.mo(t,null)}{let t=this.fo(e.key,e.newValue);if(t)return this.mo(t.clientId,t)}}else if(this.so.test(e.key)){if(null!==e.newValue){let t=this.po(e.key,e.newValue);if(t)return this.yo(t)}}else if(this.oo.test(e.key)){if(null!==e.newValue){let t=this.wo(e.key,e.newValue);if(t)return this.bo(t)}}else if(e.key===this._o){if(null!==e.newValue){let t=this.co(e.newValue);if(t)return this.lo(t)}}else if(e.key===this.ro){let t=function(e){let t=eN.le;if(null!=e)try{let n=JSON.parse(e);C("number"==typeof n,30636,{So:e}),t=n}catch(e){T(at,"Failed to read sequence number from WebStorage",e)}return t}(e.newValue);t!==eN.le&&this.sequenceNumberHandler(t)}else if(e.key===this.ao){let t=this.Do(e.newValue);await Promise.all(t.map(e=>this.syncEngine.vo(e)))}}}else this.eo.push(e)})}}get Io(){return this.Xs.get(this.Js)}uo(){this.setItem(this.no,this.Io.zs())}Po(e,t,n){let r=new an(this.currentUser,e,t,n),i=s9(this.persistenceKey,this.currentUser,e);this.setItem(i,r.zs())}To(e){let t=s9(this.persistenceKey,this.currentUser,e);this.removeItem(t)}Ao(e){let t={clientId:this.Js,onlineState:e};this.storage.setItem(this._o,JSON.stringify(t))}Eo(e,t,n){let r=ae(this.persistenceKey,e),i=new ar(e,t,n);this.setItem(r,i.zs())}Ro(e){let t=JSON.stringify(Array.from(e));this.setItem(this.ao,t)}Vo(e){let t=this.io.exec(e);return t?t[1]:null}fo(e,t){let n=this.Vo(e);return ai.Gs(n,t)}po(e,t){let n=this.so.exec(e),r=Number(n[1]),i=void 0!==n[2]?n[2]:null;return an.Gs(new y(i),r,t)}wo(e,t){let n=Number(this.oo.exec(e)[1]);return ar.Gs(n,t)}co(e){return as.Gs(e)}Do(e){return JSON.parse(e)}async yo(e){if(e.user.uid===this.currentUser.uid)return this.syncEngine.Co(e.batchId,e.state,e.error);_(at,`Ignoring mutation for non-active user ${e.user.uid}`)}bo(e){return this.syncEngine.Fo(e.targetId,e.state,e.error)}mo(e,t){let n=t?this.Xs.insert(e,t):this.Xs.remove(e),r=this.ho(this.Xs),i=this.ho(n),s=[],a=[];return i.forEach(e=>{r.has(e)||s.push(e)}),r.forEach(e=>{i.has(e)||a.push(e)}),this.syncEngine.Mo(s,a).then(()=>{this.Xs=n})}lo(e){this.Xs.get(e.clientId)&&this.onlineStateHandler(e.onlineState)}ho(e){let t=rs;return e.forEach((e,n)=>{t=t.unionWith(n.activeTargetIds)}),t}}class al{constructor(){this.xo=new aa,this.Oo={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}addPendingMutation(e){}updateMutationState(e,t,n){}addLocalQueryTarget(e,t=!0){return t&&this.xo.js(e),this.Oo[e]||"not-current"}updateQueryState(e,t,n){this.Oo[e]=t}removeLocalQueryTarget(e){this.xo.Hs(e)}isLocalQueryTarget(e){return this.xo.activeTargetIds.has(e)}clearQueryState(e){delete this.Oo[e]}getAllActiveQueryTargets(){return this.xo.activeTargetIds}isActiveQueryTarget(e){return this.xo.activeTargetIds.has(e)}start(){return this.xo=new aa,Promise.resolve()}handleUserChange(e,t,n){}setOnlineState(e){}shutdown(){}writeSequenceNumber(e){}notifyBundleLoaded(e){}}class au{No(e){}shutdown(){}}let ac="ConnectivityMonitor";class ah{constructor(){this.Bo=()=>this.Lo(),this.ko=()=>this.qo(),this.Qo=[],this.$o()}No(e){this.Qo.push(e)}shutdown(){window.removeEventListener("online",this.Bo),window.removeEventListener("offline",this.ko)}$o(){window.addEventListener("online",this.Bo),window.addEventListener("offline",this.ko)}Lo(){for(let e of(_(ac,"Network connectivity changed: AVAILABLE"),this.Qo))e(0)}qo(){for(let e of(_(ac,"Network connectivity changed: UNAVAILABLE"),this.Qo))e(1)}static C(){return"undefined"!=typeof window&&void 0!==window.addEventListener&&void 0!==window.removeEventListener}}let ad=null;function af(){return null===ad?ad=0x10000000+Math.round(0x80000000*Math.random()):ad++,"0x"+ad.toString(16)}let am="RestConnection",ag={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery",RunAggregationQuery:"runAggregationQuery"};class ap{get Uo(){return!1}constructor(e){this.databaseInfo=e,this.databaseId=e.databaseId;let t=e.ssl?"https":"http",n=encodeURIComponent(this.databaseId.projectId),r=encodeURIComponent(this.databaseId.database);this.Ko=t+"://"+e.host,this.Wo=`projects/${n}/databases/${r}`,this.Go=this.databaseId.database===tJ?`project_id=${n}`:`project_id=${n}&database_id=${r}`}zo(e,t,n,r,i){let s=af(),a=this.jo(e,t.toUriEncodedString());_(am,`Sending RPC '${e}' ${s}:`,a,n);let o={"google-cloud-resource-prefix":this.Wo,"x-goog-request-params":this.Go};this.Ho(o,r,i);let{host:l}=new URL(a),u=d.isCloudWorkstation(l);return this.Jo(e,a,o,n,u).then(t=>(_(am,`Received RPC '${e}' ${s}: `,t),t),t=>{throw b(am,`RPC '${e}' ${s} failed with error: `,t,"url: ",a,"request:",n),t})}Yo(e,t,n,r,i,s){return this.zo(e,t,n,r,i)}Ho(e,t,n){e["X-Goog-Api-Client"]="gl-js/ fire/"+w,e["Content-Type"]="text/plain",this.databaseInfo.appId&&(e["X-Firebase-GMPID"]=this.databaseInfo.appId),t&&t.headers.forEach((t,n)=>e[n]=t),n&&n.headers.forEach((t,n)=>e[n]=t)}jo(e,t){let n=ag[e];return`${this.Ko}/v1/${t}:${n}`}terminate(){}}class ay{constructor(e){this.Zo=e.Zo,this.Xo=e.Xo}e_(e){this.t_=e}n_(e){this.r_=e}i_(e){this.s_=e}onMessage(e){this.o_=e}close(){this.Xo()}send(e){this.Zo(e)}__(){this.t_()}a_(){this.r_()}u_(e){this.s_(e)}c_(e){this.o_(e)}}let aw="WebChannelConnection";class av extends ap{constructor(e){super(e),this.l_=[],this.forceLongPolling=e.forceLongPolling,this.autoDetectLongPolling=e.autoDetectLongPolling,this.useFetchStreams=e.useFetchStreams,this.longPollingOptions=e.longPollingOptions}Jo(e,t,n,r,i){let s=af();return new Promise((i,a)=>{let o=new m.XhrIo;o.setWithCredentials(!0),o.listenOnce(m.EventType.COMPLETE,()=>{try{switch(o.getLastErrorCode()){case m.ErrorCode.NO_ERROR:let t=o.getResponseJson();_(aw,`XHR for RPC '${e}' ${s} received:`,JSON.stringify(t)),i(t);break;case m.ErrorCode.TIMEOUT:_(aw,`RPC '${e}' ${s} timed out`),a(new D(N.DEADLINE_EXCEEDED,"Request time out"));break;case m.ErrorCode.HTTP_ERROR:let n=o.getStatus();if(_(aw,`RPC '${e}' ${s} failed with status:`,n,"response text:",o.getResponseText()),n>0){let e=o.getResponseJson();Array.isArray(e)&&(e=e[0]);let t=null==e?void 0:e.error;if(t&&t.status&&t.message){let e=function(e){let t=e.toLowerCase().replace(/_/g,"-");return Object.values(N).indexOf(t)>=0?t:N.UNKNOWN}(t.status);a(new D(e,t.message))}else a(new D(N.UNKNOWN,"Server responded with status "+o.getStatus()))}else a(new D(N.UNAVAILABLE,"Connection failed."));break;default:x(9055,{h_:e,streamId:s,P_:o.getLastErrorCode(),T_:o.getLastError()})}}finally{_(aw,`RPC '${e}' ${s} completed.`)}});let l=JSON.stringify(r);_(aw,`RPC '${e}' ${s} sending request:`,r),o.send(t,"POST",l,n,15)})}I_(e,t,n){let i=af(),s=[this.Ko,"/","google.firestore.v1.Firestore","/",e,"/channel"],a=m.createWebChannelTransport(),o=m.getStatEventTarget(),l={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:`projects/${this.databaseId.projectId}/databases/${this.databaseId.database}`},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling},u=this.longPollingOptions.timeoutSeconds;void 0!==u&&(l.longPollingTimeout=Math.round(1e3*u)),this.useFetchStreams&&(l.useFetchStreams=!0),this.Ho(l.initMessageHeaders,t,n),l.encodeInitMessageHeaders=!0;let c=s.join("");_(aw,`Creating RPC '${e}' stream ${i}: ${c}`,l);let h=a.createWebChannel(c,l);this.E_(h);let d=!1,f=!1,g=new ay({Zo:t=>{f?_(aw,`Not sending because RPC '${e}' stream ${i} is closed:`,t):(d||(_(aw,`Opening RPC '${e}' stream ${i} transport.`),h.open(),d=!0),_(aw,`RPC '${e}' stream ${i} sending:`,t),h.send(t))},Xo:()=>h.close()}),p=(e,t,n)=>{e.listen(t,e=>{try{n(e)}catch(e){setTimeout(()=>{throw e},0)}})};return p(h,m.WebChannel.EventType.OPEN,()=>{f||(_(aw,`RPC '${e}' stream ${i} transport opened.`),g.__())}),p(h,m.WebChannel.EventType.CLOSE,()=>{f||(f=!0,_(aw,`RPC '${e}' stream ${i} transport closed`),g.u_(),this.d_(h))}),p(h,m.WebChannel.EventType.ERROR,t=>{f||(f=!0,b(aw,`RPC '${e}' stream ${i} transport errored. Name:`,t.name,"Message:",t.message),g.u_(new D(N.UNAVAILABLE,"The operation could not be completed")))}),p(h,m.WebChannel.EventType.MESSAGE,t=>{var n;if(!f){let s=t.data[0];C(!!s,16349);let a=(null==s?void 0:s.error)||(null==(n=s[0])?void 0:n.error);if(a){_(aw,`RPC '${e}' stream ${i} received error:`,a);let t=a.status,n=function(e){let t=r[e];if(void 0!==t)return rU(t)}(t),s=a.message;void 0===n&&(n=N.INTERNAL,s="Unknown error status: "+t+" with message "+a.message),f=!0,g.u_(new D(n,s)),h.close()}else _(aw,`RPC '${e}' stream ${i} received:`,s),g.c_(s)}}),p(o,m.Event.STAT_EVENT,t=>{t.stat===m.Stat.PROXY?_(aw,`RPC '${e}' stream ${i} detected buffering proxy`):t.stat===m.Stat.NOPROXY&&_(aw,`RPC '${e}' stream ${i} detected no buffering proxy`)}),setTimeout(()=>{g.a_()},0),g}terminate(){this.l_.forEach(e=>e.close()),this.l_=[]}E_(e){this.l_.push(e)}d_(e){this.l_=this.l_.filter(t=>t===e)}}function aI(){return"undefined"!=typeof window?window:null}function a_(){return"undefined"!=typeof document?document:null}function aT(e){return new r3(e,!0)}class ab{constructor(e,t,n=1e3,r=1.5,i=6e4){this.xi=e,this.timerId=t,this.A_=n,this.R_=r,this.V_=i,this.m_=0,this.f_=null,this.g_=Date.now(),this.reset()}reset(){this.m_=0}p_(){this.m_=this.V_}y_(e){this.cancel();let t=Math.floor(this.m_+this.w_()),n=Math.max(0,Date.now()-this.g_),r=Math.max(0,t-n);r>0&&_("ExponentialBackoff",`Backing off for ${r} ms (base delay: ${this.m_} ms, delay with jitter: ${t} ms, last attempt: ${n} ms ago)`),this.f_=this.xi.enqueueAfterDelay(this.timerId,r,()=>(this.g_=Date.now(),e())),this.m_*=this.R_,this.m_<this.A_&&(this.m_=this.A_),this.m_>this.V_&&(this.m_=this.V_)}b_(){null!==this.f_&&(this.f_.skipDelay(),this.f_=null)}cancel(){null!==this.f_&&(this.f_.cancel(),this.f_=null)}w_(){return(Math.random()-.5)*this.m_}}let aE="PersistentStream";class ax{constructor(e,t,n,r,i,s,a,o){this.xi=e,this.S_=n,this.D_=r,this.connection=i,this.authCredentialsProvider=s,this.appCheckCredentialsProvider=a,this.listener=o,this.state=0,this.v_=0,this.C_=null,this.F_=null,this.stream=null,this.M_=0,this.x_=new ab(e,t)}O_(){return 1===this.state||5===this.state||this.N_()}N_(){return 2===this.state||3===this.state}start(){this.M_=0,4!==this.state?this.auth():this.B_()}async stop(){this.O_()&&await this.close(0)}L_(){this.state=0,this.x_.reset()}k_(){this.N_()&&null===this.C_&&(this.C_=this.xi.enqueueAfterDelay(this.S_,6e4,()=>this.q_()))}Q_(e){this.U_(),this.stream.send(e)}async q_(){if(this.N_())return this.close(0)}U_(){this.C_&&(this.C_.cancel(),this.C_=null)}K_(){this.F_&&(this.F_.cancel(),this.F_=null)}async close(e,t){this.U_(),this.K_(),this.x_.cancel(),this.v_++,4!==e?this.x_.reset():t&&t.code===N.RESOURCE_EXHAUSTED?(T(t.toString()),T("Using maximum backoff delay to prevent overloading the backend."),this.x_.p_()):t&&t.code===N.UNAUTHENTICATED&&3!==this.state&&(this.authCredentialsProvider.invalidateToken(),this.appCheckCredentialsProvider.invalidateToken()),null!==this.stream&&(this.W_(),this.stream.close(),this.stream=null),this.state=e,await this.listener.i_(t)}W_(){}auth(){this.state=1;let e=this.G_(this.v_),t=this.v_;Promise.all([this.authCredentialsProvider.getToken(),this.appCheckCredentialsProvider.getToken()]).then(([e,n])=>{this.v_===t&&this.z_(e,n)},t=>{e(()=>{let e=new D(N.UNKNOWN,"Fetching auth token failed: "+t.message);return this.j_(e)})})}z_(e,t){let n=this.G_(this.v_);this.stream=this.H_(e,t),this.stream.e_(()=>{n(()=>this.listener.e_())}),this.stream.n_(()=>{n(()=>(this.state=2,this.F_=this.xi.enqueueAfterDelay(this.D_,1e4,()=>(this.N_()&&(this.state=3),Promise.resolve())),this.listener.n_()))}),this.stream.i_(e=>{n(()=>this.j_(e))}),this.stream.onMessage(e=>{n(()=>1==++this.M_?this.J_(e):this.onNext(e))})}B_(){this.state=5,this.x_.y_(async()=>{this.state=0,this.start()})}j_(e){return _(aE,`close with error: ${e}`),this.stream=null,this.close(4,e)}G_(e){return t=>{this.xi.enqueueAndForget(()=>this.v_===e?t():(_(aE,"stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve()))}}}class aS extends ax{constructor(e,t,n,r,i,s){super(e,"listen_stream_connection_backoff","listen_stream_idle","health_check_timeout",t,n,r,s),this.serializer=i}H_(e,t){return this.connection.I_("Listen",e,t)}J_(e){return this.onNext(e)}onNext(e){this.x_.reset();let t=function(e,t){let n;if("targetChange"in t){var r,i;t.targetChange;let s="NO_CHANGE"===(r=t.targetChange.targetChangeType||"NO_CHANGE")?0:"ADD"===r?1:"REMOVE"===r?2:"CURRENT"===r?3:"RESET"===r?4:x(39313,{state:r}),a=t.targetChange.targetIds||[],o=(i=t.targetChange.resumeToken,e.useProto3Json?(C(void 0===i||"string"==typeof i,58123),tO.fromBase64String(i||"")):(C(void 0===i||i instanceof l||i instanceof Uint8Array,16193),tO.fromUint8Array(i||new Uint8Array))),u=t.targetChange.cause;n=new rJ(s,a,o,u&&new D(void 0===u.code?N.UNKNOWN:rU(u.code),u.message||"")||null)}else if("documentChange"in t){t.documentChange;let r=t.documentChange;r.document,r.document.name,r.document.updateTime;let i=is(e,r.document.name),s=r7(r.document.updateTime),a=r.document.createTime?r7(r.document.createTime):j.min(),o=new nm({mapValue:{fields:r.document.fields}}),l=ng.newFoundDocument(i,s,a,o);n=new rH(r.targetIds||[],r.removedTargetIds||[],l.key,l)}else if("documentDelete"in t){t.documentDelete;let r=t.documentDelete;r.document;let i=is(e,r.document),s=r.readTime?r7(r.readTime):j.min(),a=ng.newNoDocument(i,s);n=new rH([],r.removedTargetIds||[],a.key,a)}else if("documentRemove"in t){t.documentRemove;let r=t.documentRemove;r.document;let i=is(e,r.document);n=new rH([],r.removedTargetIds||[],i,null)}else{if(!("filter"in t))return x(11601,{Vt:t});{t.filter;let e=t.filter;e.targetId;let{count:r=0,unchangedNames:i}=e,s=new rO(r,i);n=new rY(e.targetId,s)}}return n}(this.serializer,e),n=function(e){if(!("targetChange"in e))return j.min();let t=e.targetChange;return t.targetIds&&t.targetIds.length?j.min():t.readTime?r7(t.readTime):j.min()}(e);return this.listener.Y_(t,n)}Z_(e){let t={};t.database=il(this.serializer),t.addTarget=function(e,t){let n,r=t.target;if((n=nU(r)?{documents:ig(e,r)}:{query:ip(e,r).gt}).targetId=t.targetId,t.resumeToken.approximateByteSize()>0){n.resumeToken=r9(e,t.resumeToken);let r=r6(e,t.expectedCount);null!==r&&(n.expectedCount=r)}else if(t.snapshotVersion.compareTo(j.min())>0){n.readTime=r8(e,t.snapshotVersion.toTimestamp());let r=r6(e,t.expectedCount);null!==r&&(n.expectedCount=r)}return n}(this.serializer,e);let n=function(e,t){let n=function(e){switch(e){case"TargetPurposeListen":return null;case"TargetPurposeExistenceFilterMismatch":return"existence-filter-mismatch";case"TargetPurposeExistenceFilterMismatchBloom":return"existence-filter-mismatch-bloom";case"TargetPurposeLimboResolution":return"limbo-document";default:return x(28987,{purpose:e})}}(t.purpose);return null==n?null:{"goog-listen-tags":n}}(this.serializer,e);n&&(t.labels=n),this.Q_(t)}X_(e){let t={};t.database=il(this.serializer),t.removeTarget=e,this.Q_(t)}}class aC extends ax{constructor(e,t,n,r,i,s){super(e,"write_stream_connection_backoff","write_stream_idle","health_check_timeout",t,n,r,s),this.serializer=i}get ea(){return this.M_>0}start(){this.lastStreamToken=void 0,super.start()}W_(){this.ea&&this.ta([])}H_(e,t){return this.connection.I_("Write",e,t)}J_(e){return C(!!e.streamToken,31322),this.lastStreamToken=e.streamToken,C(!e.writeResults||0===e.writeResults.length,55816),this.listener.na()}onNext(e){var t,n;C(!!e.streamToken,12678),this.lastStreamToken=e.streamToken,this.x_.reset();let r=(t=e.writeResults,n=e.commitTime,t&&t.length>0?(C(void 0!==n,14353),t.map(e=>{let t;return(t=e.updateTime?r7(e.updateTime):r7(n)).isEqual(j.min())&&(t=r7(n)),new rI(t,e.transformResults||[])})):[]),i=r7(e.commitTime);return this.listener.ra(i,r)}ia(){let e={};e.database=il(this.serializer),this.Q_(e)}ta(e){let t={streamToken:this.lastStreamToken,writes:e.map(e=>id(this.serializer,e))};this.Q_(t)}}class aN{}class aD extends aN{constructor(e,t,n,r){super(),this.authCredentials=e,this.appCheckCredentials=t,this.connection=n,this.serializer=r,this.sa=!1}oa(){if(this.sa)throw new D(N.FAILED_PRECONDITION,"The client has already been terminated.")}zo(e,t,n,r){return this.oa(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([i,s])=>this.connection.zo(e,it(t,n),r,i,s)).catch(e=>{throw"FirebaseError"===e.name?(e.code===N.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),e):new D(N.UNKNOWN,e.toString())})}Yo(e,t,n,r,i){return this.oa(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([s,a])=>this.connection.Yo(e,it(t,n),r,s,a,i)).catch(e=>{throw"FirebaseError"===e.name?(e.code===N.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),e):new D(N.UNKNOWN,e.toString())})}terminate(){this.sa=!0,this.connection.terminate()}}class aA{constructor(e,t){this.asyncQueue=e,this.onlineStateHandler=t,this.state="Unknown",this._a=0,this.aa=null,this.ua=!0}ca(){0===this._a&&(this.la("Unknown"),this.aa=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,()=>(this.aa=null,this.ha("Backend didn't respond within 10 seconds."),this.la("Offline"),Promise.resolve())))}Pa(e){"Online"===this.state?this.la("Unknown"):(this._a++,this._a>=1&&(this.Ta(),this.ha(`Connection failed 1 times. Most recent error: ${e.toString()}`),this.la("Offline")))}set(e){this.Ta(),this._a=0,"Online"===e&&(this.ua=!1),this.la(e)}la(e){e!==this.state&&(this.state=e,this.onlineStateHandler(e))}ha(e){let t=`Could not reach Cloud Firestore backend. ${e}
This typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.`;this.ua?(T(t),this.ua=!1):_("OnlineStateTracker",t)}Ta(){null!==this.aa&&(this.aa.cancel(),this.aa=null)}}let ak="RemoteStore";class aR{constructor(e,t,n,r,i){this.localStore=e,this.datastore=t,this.asyncQueue=n,this.remoteSyncer={},this.Ia=[],this.Ea=new Map,this.da=new Set,this.Aa=[],this.Ra=i,this.Ra.No(e=>{n.enqueueAndForget(async()=>{aB(this)&&(_(ak,"Restarting streams for network reachability change."),await async function(e){e.da.add(4),await aF(e),e.Va.set("Unknown"),e.da.delete(4),await aM(e)}(this))})}),this.Va=new aA(n,r)}}async function aM(e){if(aB(e))for(let t of e.Aa)await t(!0)}async function aF(e){for(let t of e.Aa)await t(!1)}function aV(e,t){e.Ea.has(t.targetId)||(e.Ea.set(t.targetId,t),aU(e)?aq(e):a5(e).N_()&&aP(e,t))}function aL(e,t){let n=a5(e);e.Ea.delete(t),n.N_()&&aO(e,t),0===e.Ea.size&&(n.N_()?n.k_():aB(e)&&e.Va.set("Unknown"))}function aP(e,t){if(e.ma.Ke(t.targetId),t.resumeToken.approximateByteSize()>0||t.snapshotVersion.compareTo(j.min())>0){let n=e.remoteSyncer.getRemoteKeysForTarget(t.targetId).size;t=t.withExpectedCount(n)}a5(e).Z_(t)}function aO(e,t){e.ma.Ke(t),a5(e).X_(t)}function aq(e){e.ma=new rZ({getRemoteKeysForTarget:t=>e.remoteSyncer.getRemoteKeysForTarget(t),Rt:t=>e.Ea.get(t)||null,Pt:()=>e.datastore.serializer.databaseId}),a5(e).start(),e.Va.ca()}function aU(e){return aB(e)&&!a5(e).O_()&&e.Ea.size>0}function aB(e){return 0===e.da.size}async function az(e){e.Va.set("Online")}async function a$(e){e.Ea.forEach((t,n)=>{aP(e,t)})}async function aK(e,t){e.ma=void 0,aU(e)?(e.Va.Pa(t),aq(e)):e.Va.set("Unknown")}async function aG(e,t,n){if(e.Va.set("Online"),t instanceof rJ&&2===t.state&&t.cause)try{await async function(e,t){let n=t.cause;for(let r of t.targetIds)e.Ea.has(r)&&(await e.remoteSyncer.rejectListen(r,n),e.Ea.delete(r),e.ma.removeTarget(r))}(e,t)}catch(n){_(ak,"Failed to remove targets %s: %s ",t.targetIds.join(","),n),await aQ(e,n)}else if(t instanceof rH?e.ma.Xe(t):t instanceof rY?e.ma.ot(t):e.ma.nt(t),!n.isEqual(j.min()))try{let t=await sH(e.localStore);n.compareTo(t)>=0&&await function(e,t){let n=e.ma.It(t);return n.targetChanges.forEach((n,r)=>{if(n.resumeToken.approximateByteSize()>0){let i=e.Ea.get(r);i&&e.Ea.set(r,i.withResumeToken(n.resumeToken,t))}}),n.targetMismatches.forEach((t,n)=>{let r=e.Ea.get(t);if(!r)return;e.Ea.set(t,r.withResumeToken(tO.EMPTY_BYTE_STRING,r.snapshotVersion)),aO(e,t);let i=new iT(r.target,t,n,r.sequenceNumber);aP(e,i)}),e.remoteSyncer.applyRemoteEvent(n)}(e,n)}catch(t){_(ak,"Failed to raise snapshot:",t),await aQ(e,t)}}async function aQ(e,t,n){if(!eI(t))throw t;e.da.add(1),await aF(e),e.Va.set("Offline"),n||(n=()=>sH(e.localStore)),e.asyncQueue.enqueueRetryable(async()=>{_(ak,"Retrying IndexedDB access"),await n(),e.da.delete(1),await aM(e)})}function aj(e,t){return t().catch(n=>aQ(e,n,t))}async function aW(e){var t;let n=a4(e),r=e.Ia.length>0?e.Ia[e.Ia.length-1].batchId:-1;for(;aB(t=e)&&t.Ia.length<10;)try{let t=await function(e,t){return e.persistence.runTransaction("Get next mutation batch","readonly",n=>(void 0===t&&(t=-1),e.mutationQueue.getNextMutationBatchAfterBatchId(n,t)))}(e.localStore,r);if(null===t){0===e.Ia.length&&n.k_();break}r=t.batchId,function(e,t){e.Ia.push(t);let n=a4(e);n.N_()&&n.ea&&n.ta(t.mutations)}(e,t)}catch(t){await aQ(e,t)}aH(e)&&aY(e)}function aH(e){return aB(e)&&!a4(e).O_()&&e.Ia.length>0}function aY(e){a4(e).start()}async function aJ(e){a4(e).ia()}async function aX(e){let t=a4(e);for(let n of e.Ia)t.ta(n.mutations)}async function aZ(e,t,n){let r=e.Ia.shift(),i=rV.from(r,t,n);await aj(e,()=>e.remoteSyncer.applySuccessfulWrite(i)),await aW(e)}async function a0(e,t){t&&a4(e).ea&&await async function(e,t){var n;if(rq(n=t.code)&&n!==N.ABORTED){let n=e.Ia.shift();a4(e).L_(),await aj(e,()=>e.remoteSyncer.rejectFailedWrite(n.batchId,t)),await aW(e)}}(e,t),aH(e)&&aY(e)}async function a1(e,t){e.asyncQueue.verifyOperationInProgress(),_(ak,"RemoteStore received new credentials");let n=aB(e);e.da.add(3),await aF(e),n&&e.Va.set("Unknown"),await e.remoteSyncer.handleCredentialChange(t),e.da.delete(3),await aM(e)}async function a2(e,t){t?(e.da.delete(2),await aM(e)):t||(e.da.add(2),await aF(e),e.Va.set("Unknown"))}function a5(e){var t,n,r;return e.fa||(t=e.datastore,n=e.asyncQueue,r={e_:az.bind(null,e),n_:a$.bind(null,e),i_:aK.bind(null,e),Y_:aG.bind(null,e)},t.oa(),e.fa=new aS(n,t.connection,t.authCredentials,t.appCheckCredentials,t.serializer,r),e.Aa.push(async t=>{t?(e.fa.L_(),aU(e)?aq(e):e.Va.set("Unknown")):(await e.fa.stop(),e.ma=void 0)})),e.fa}function a4(e){var t,n,r;return e.ga||(t=e.datastore,n=e.asyncQueue,r={e_:()=>Promise.resolve(),n_:aJ.bind(null,e),i_:a0.bind(null,e),na:aX.bind(null,e),ra:aZ.bind(null,e)},t.oa(),e.ga=new aC(n,t.connection,t.authCredentials,t.appCheckCredentials,t.serializer,r),e.Aa.push(async t=>{t?(e.ga.L_(),await aW(e)):(await e.ga.stop(),e.Ia.length>0&&(_(ak,`Stopping write stream with ${e.Ia.length} pending writes`),e.Ia=[]))})),e.ga}class a3{constructor(e,t,n,r,i){this.asyncQueue=e,this.timerId=t,this.targetTimeMs=n,this.op=r,this.removalCallback=i,this.deferred=new A,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch(e=>{})}get promise(){return this.deferred.promise}static createAndSchedule(e,t,n,r,i){let s=new a3(e,t,Date.now()+n,r,i);return s.start(n),s}start(e){this.timerHandle=setTimeout(()=>this.handleDelayElapsed(),e)}skipDelay(){return this.handleDelayElapsed()}cancel(e){null!==this.timerHandle&&(this.clearTimeout(),this.deferred.reject(new D(N.CANCELLED,"Operation cancelled"+(e?": "+e:""))))}handleDelayElapsed(){this.asyncQueue.enqueueAndForget(()=>null!==this.timerHandle?(this.clearTimeout(),this.op().then(e=>this.deferred.resolve(e))):Promise.resolve())}clearTimeout(){null!==this.timerHandle&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}}function a6(e,t){if(T("AsyncQueue",`${t}: ${e}`),eI(e))return new D(N.UNAVAILABLE,`${t}: ${e}`);throw e}class a8{static emptySet(e){return new a8(e.comparator)}constructor(e){this.comparator=e?(t,n)=>e(t,n)||Z.comparator(t.key,n.key):(e,t)=>Z.comparator(e.key,t.key),this.keyedMap=n7(),this.sortedSet=new tA(this.comparator)}has(e){return null!=this.keyedMap.get(e)}get(e){return this.keyedMap.get(e)}first(){return this.sortedSet.minKey()}last(){return this.sortedSet.maxKey()}isEmpty(){return this.sortedSet.isEmpty()}indexOf(e){let t=this.keyedMap.get(e);return t?this.sortedSet.indexOf(t):-1}get size(){return this.sortedSet.size}forEach(e){this.sortedSet.inorderTraversal((t,n)=>(e(t),!1))}add(e){let t=this.delete(e.key);return t.copy(t.keyedMap.insert(e.key,e),t.sortedSet.insert(e,null))}delete(e){let t=this.get(e);return t?this.copy(this.keyedMap.remove(e),this.sortedSet.remove(t)):this}isEqual(e){if(!(e instanceof a8)||this.size!==e.size)return!1;let t=this.sortedSet.getIterator(),n=e.sortedSet.getIterator();for(;t.hasNext();){let e=t.getNext().key,r=n.getNext().key;if(!e.isEqual(r))return!1}return!0}toString(){let e=[];return this.forEach(t=>{e.push(t.toString())}),0===e.length?"DocumentSet ()":"DocumentSet (\n  "+e.join("  \n")+"\n)"}copy(e,t){let n=new a8;return n.comparator=this.comparator,n.keyedMap=e,n.sortedSet=t,n}}class a9{constructor(){this.pa=new tA(Z.comparator)}track(e){let t=e.doc.key,n=this.pa.get(t);n?0!==e.type&&3===n.type?this.pa=this.pa.insert(t,e):3===e.type&&1!==n.type?this.pa=this.pa.insert(t,{type:n.type,doc:e.doc}):2===e.type&&2===n.type?this.pa=this.pa.insert(t,{type:2,doc:e.doc}):2===e.type&&0===n.type?this.pa=this.pa.insert(t,{type:0,doc:e.doc}):1===e.type&&0===n.type?this.pa=this.pa.remove(t):1===e.type&&2===n.type?this.pa=this.pa.insert(t,{type:1,doc:n.doc}):0===e.type&&1===n.type?this.pa=this.pa.insert(t,{type:2,doc:e.doc}):x(63341,{Vt:e,ya:n}):this.pa=this.pa.insert(t,e)}wa(){let e=[];return this.pa.inorderTraversal((t,n)=>{e.push(n)}),e}}class a7{constructor(e,t,n,r,i,s,a,o,l){this.query=e,this.docs=t,this.oldDocs=n,this.docChanges=r,this.mutatedKeys=i,this.fromCache=s,this.syncStateChanged=a,this.excludesMetadataChanges=o,this.hasCachedResults=l}static fromInitialDocuments(e,t,n,r,i){let s=[];return t.forEach(e=>{s.push({type:0,doc:e})}),new a7(e,t,a8.emptySet(t),s,n,r,!0,!1,i)}get hasPendingWrites(){return!this.mutatedKeys.isEmpty()}isEqual(e){if(!(this.fromCache===e.fromCache&&this.hasCachedResults===e.hasCachedResults&&this.syncStateChanged===e.syncStateChanged&&this.mutatedKeys.isEqual(e.mutatedKeys)&&n0(this.query,e.query)&&this.docs.isEqual(e.docs)&&this.oldDocs.isEqual(e.oldDocs)))return!1;let t=this.docChanges,n=e.docChanges;if(t.length!==n.length)return!1;for(let e=0;e<t.length;e++)if(t[e].type!==n[e].type||!t[e].doc.isEqual(n[e].doc))return!1;return!0}}class oe{constructor(){this.ba=void 0,this.Sa=[]}Da(){return this.Sa.some(e=>e.va())}}class ot{constructor(){this.queries=on(),this.onlineState="Unknown",this.Ca=new Set}terminate(){!function(e,t){let n=e.queries;e.queries=on(),n.forEach((e,n)=>{for(let e of n.Sa)e.onError(t)})}(this,new D(N.ABORTED,"Firestore shutting down"))}}function on(){return new n6(e=>n1(e),n0)}async function or(e,t){let n=3,r=t.query,i=e.queries.get(r);i?!i.Da()&&t.va()&&(n=2):(i=new oe,n=+!t.va());try{switch(n){case 0:i.ba=await e.onListen(r,!0);break;case 1:i.ba=await e.onListen(r,!1);break;case 2:await e.onFirstRemoteStoreListen(r)}}catch(n){let e=a6(n,`Initialization of query '${n2(t.query)}' failed`);return void t.onError(e)}e.queries.set(r,i),i.Sa.push(t),t.Fa(e.onlineState),i.ba&&t.Ma(i.ba)&&oo(e)}async function oi(e,t){let n=t.query,r=3,i=e.queries.get(n);if(i){let e=i.Sa.indexOf(t);e>=0&&(i.Sa.splice(e,1),0===i.Sa.length?r=+!t.va():!i.Da()&&t.va()&&(r=2))}switch(r){case 0:return e.queries.delete(n),e.onUnlisten(n,!0);case 1:return e.queries.delete(n),e.onUnlisten(n,!1);case 2:return e.onLastRemoteStoreUnlisten(n);default:return}}function os(e,t){let n=!1;for(let r of t){let t=r.query,i=e.queries.get(t);if(i){for(let e of i.Sa)e.Ma(r)&&(n=!0);i.ba=r}}n&&oo(e)}function oa(e,t,n){let r=e.queries.get(t);if(r)for(let e of r.Sa)e.onError(n);e.queries.delete(t)}function oo(e){e.Ca.forEach(e=>{e.next()})}(a=s||(s={})).xa="default",a.Cache="cache";class ol{constructor(e,t,n){this.query=e,this.Oa=t,this.Na=!1,this.Ba=null,this.onlineState="Unknown",this.options=n||{}}Ma(e){if(!this.options.includeMetadataChanges){let t=[];for(let n of e.docChanges)3!==n.type&&t.push(n);e=new a7(e.query,e.docs,e.oldDocs,t,e.mutatedKeys,e.fromCache,e.syncStateChanged,!0,e.hasCachedResults)}let t=!1;return this.Na?this.La(e)&&(this.Oa.next(e),t=!0):this.ka(e,this.onlineState)&&(this.qa(e),t=!0),this.Ba=e,t}onError(e){this.Oa.error(e)}Fa(e){this.onlineState=e;let t=!1;return this.Ba&&!this.Na&&this.ka(this.Ba,e)&&(this.qa(this.Ba),t=!0),t}ka(e,t){return!(e.fromCache&&this.va())||(!this.options.Qa||"Offline"===t)&&(!e.docs.isEmpty()||e.hasCachedResults||"Offline"===t)}La(e){if(e.docChanges.length>0)return!0;let t=this.Ba&&this.Ba.hasPendingWrites!==e.hasPendingWrites;return!(!e.syncStateChanged&&!t)&&!0===this.options.includeMetadataChanges}qa(e){e=a7.fromInitialDocuments(e.query,e.docs,e.mutatedKeys,e.fromCache,e.hasCachedResults),this.Na=!0,this.Oa.next(e)}va(){return this.options.source!==s.Cache}}class ou{constructor(e,t){this.$a=e,this.byteLength=t}Ua(){return"metadata"in this.$a}}class oc{constructor(e){this.serializer=e}Us(e){return is(this.serializer,e)}Ks(e){return e.metadata.exists?ih(this.serializer,e.document,!1):ng.newNoDocument(this.Us(e.metadata.name),this.Ws(e.metadata.readTime))}Ws(e){return r7(e)}}class oh{constructor(e,t,n){this.Ka=e,this.localStore=t,this.serializer=n,this.queries=[],this.documents=[],this.collectionGroups=new Set,this.progress=od(e)}Wa(e){this.progress.bytesLoaded+=e.byteLength;let t=this.progress.documentsLoaded;if(e.$a.namedQuery)this.queries.push(e.$a.namedQuery);else if(e.$a.documentMetadata){this.documents.push({metadata:e.$a.documentMetadata}),e.$a.documentMetadata.exists||++t;let n=Y.fromString(e.$a.documentMetadata.name);this.collectionGroups.add(n.get(n.length-2))}else e.$a.document&&(this.documents[this.documents.length-1].document=e.$a.document,++t);return t!==this.progress.documentsLoaded?(this.progress.documentsLoaded=t,Object.assign({},this.progress)):null}Ga(e){let t=new Map,n=new oc(this.serializer);for(let r of e)if(r.metadata.queries){let e=n.Us(r.metadata.name);for(let n of r.metadata.queries){let r=(t.get(n)||ri()).add(e);t.set(n,r)}}return t}async complete(){let e=await s5(this.localStore,new oc(this.serializer),this.documents,this.Ka.id),t=this.Ga(this.documents);for(let e of this.queries)await s4(this.localStore,e,t.get(e.name));return this.progress.taskState="Success",{progress:this.progress,za:this.collectionGroups,ja:e}}}function od(e){return{taskState:"Running",documentsLoaded:0,bytesLoaded:0,totalDocuments:e.totalDocuments,totalBytes:e.totalBytes}}class of{constructor(e){this.key=e}}class om{constructor(e){this.key=e}}class og{constructor(e,t){this.query=e,this.Ha=t,this.Ja=null,this.hasCachedResults=!1,this.current=!1,this.Ya=ri(),this.mutatedKeys=ri(),this.Za=n3(e),this.Xa=new a8(this.Za)}get eu(){return this.Ha}tu(e,t){let n=t?t.nu:new a9,r=t?t.Xa:this.Xa,i=t?t.mutatedKeys:this.mutatedKeys,s=r,a=!1,o="F"===this.query.limitType&&r.size===this.query.limit?r.last():null,l="L"===this.query.limitType&&r.size===this.query.limit?r.first():null;if(e.inorderTraversal((e,t)=>{let u=r.get(e),c=n5(this.query,t)?t:null,h=!!u&&this.mutatedKeys.has(u.key),d=!!c&&(c.hasLocalMutations||this.mutatedKeys.has(c.key)&&c.hasCommittedMutations),f=!1;u&&c?u.data.isEqual(c.data)?h!==d&&(n.track({type:3,doc:c}),f=!0):this.ru(u,c)||(n.track({type:2,doc:c}),f=!0,(o&&this.Za(c,o)>0||l&&0>this.Za(c,l))&&(a=!0)):!u&&c?(n.track({type:0,doc:c}),f=!0):u&&!c&&(n.track({type:1,doc:u}),f=!0,(o||l)&&(a=!0)),f&&(c?(s=s.add(c),i=d?i.add(e):i.delete(e)):(s=s.delete(e),i=i.delete(e)))}),null!==this.query.limit)for(;s.size>this.query.limit;){let e="F"===this.query.limitType?s.last():s.first();s=s.delete(e.key),i=i.delete(e.key),n.track({type:1,doc:e})}return{Xa:s,nu:n,Cs:a,mutatedKeys:i}}ru(e,t){return e.hasLocalMutations&&t.hasCommittedMutations&&!t.hasLocalMutations}applyChanges(e,t,n,r){let i=this.Xa;this.Xa=e.Xa,this.mutatedKeys=e.mutatedKeys;let s=e.nu.wa();s.sort((e,t)=>(function(e,t){let n=e=>{switch(e){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return x(20277,{Vt:e})}};return n(e)-n(t)})(e.type,t.type)||this.Za(e.doc,t.doc)),this.iu(n),r=null!=r&&r;let a=t&&!r?this.su():[],o=0===this.Ya.size&&this.current&&!r?1:0,l=o!==this.Ja;return(this.Ja=o,0!==s.length||l)?{snapshot:new a7(this.query,e.Xa,i,s,e.mutatedKeys,0===o,l,!1,!!n&&n.resumeToken.approximateByteSize()>0),ou:a}:{ou:a}}Fa(e){return this.current&&"Offline"===e?(this.current=!1,this.applyChanges({Xa:this.Xa,nu:new a9,mutatedKeys:this.mutatedKeys,Cs:!1},!1)):{ou:[]}}_u(e){return!this.Ha.has(e)&&!!this.Xa.has(e)&&!this.Xa.get(e).hasLocalMutations}iu(e){e&&(e.addedDocuments.forEach(e=>this.Ha=this.Ha.add(e)),e.modifiedDocuments.forEach(e=>{}),e.removedDocuments.forEach(e=>this.Ha=this.Ha.delete(e)),this.current=e.current)}su(){if(!this.current)return[];let e=this.Ya;this.Ya=ri(),this.Xa.forEach(e=>{this._u(e.key)&&(this.Ya=this.Ya.add(e.key))});let t=[];return e.forEach(e=>{this.Ya.has(e)||t.push(new om(e))}),this.Ya.forEach(n=>{e.has(n)||t.push(new of(n))}),t}au(e){this.Ha=e.$s,this.Ya=ri();let t=this.tu(e.documents);return this.applyChanges(t,!0)}uu(){return a7.fromInitialDocuments(this.query,this.Xa,this.mutatedKeys,0===this.Ja,this.hasCachedResults)}}let op="SyncEngine";class oy{constructor(e,t,n){this.query=e,this.targetId=t,this.view=n}}class ow{constructor(e){this.key=e,this.cu=!1}}class ov{constructor(e,t,n,r,i,s){this.localStore=e,this.remoteStore=t,this.eventManager=n,this.sharedClientState=r,this.currentUser=i,this.maxConcurrentLimboResolutions=s,this.lu={},this.hu=new n6(e=>n1(e),n0),this.Pu=new Map,this.Tu=new Set,this.Iu=new tA(Z.comparator),this.Eu=new Map,this.du=new sS,this.Au={},this.Ru=new Map,this.Vu=ss.lr(),this.onlineState="Unknown",this.mu=void 0}get isPrimaryClient(){return!0===this.mu}}async function oI(e,t,n=!0){let r,i=oJ(e),s=i.hu.get(t);return s?(i.sharedClientState.addLocalQueryTarget(s.targetId),r=s.view.uu()):r=await oT(i,t,n,!0),r}async function o_(e,t){let n=oJ(e);await oT(n,t,!0,!1)}async function oT(e,t,n,r){let i,s=await sJ(e.localStore,nH(t)),a=s.targetId,o=e.sharedClientState.addLocalQueryTarget(a,n);return r&&(i=await ob(e,t,a,"current"===o,s.resumeToken)),e.isPrimaryClient&&n&&aV(e.remoteStore,s),i}async function ob(e,t,n,r,i){e.fu=(t,n,r)=>(async function(e,t,n,r){let i=t.view.tu(n);i.Cs&&(i=await sZ(e.localStore,t.query,!1).then(({documents:e})=>t.view.tu(e,i)));let s=r&&r.targetChanges.get(t.targetId),a=r&&null!=r.targetMismatches.get(t.targetId),o=t.view.applyChanges(i,e.isPrimaryClient,s,a);return oP(e,t.targetId,o.ou),o.snapshot})(e,t,n,r);let s=await sZ(e.localStore,t,!0),a=new og(t,s.$s),o=a.tu(s.documents),l=rW.createSynthesizedTargetChangeForCurrentChange(n,r&&"Offline"!==e.onlineState,i),u=a.applyChanges(o,e.isPrimaryClient,l);oP(e,n,u.ou);let c=new oy(t,n,a);return e.hu.set(t,c),e.Pu.has(n)?e.Pu.get(n).push(t):e.Pu.set(n,[t]),u.snapshot}async function oE(e,t,n){let r=e.hu.get(t),i=e.Pu.get(r.targetId);if(i.length>1)return e.Pu.set(r.targetId,i.filter(e=>!n0(e,t))),void e.hu.delete(t);e.isPrimaryClient?(e.sharedClientState.removeLocalQueryTarget(r.targetId),e.sharedClientState.isActiveQueryTarget(r.targetId)||await sX(e.localStore,r.targetId,!1).then(()=>{e.sharedClientState.clearQueryState(r.targetId),n&&aL(e.remoteStore,r.targetId),oV(e,r.targetId)}).catch(ed)):(oV(e,r.targetId),await sX(e.localStore,r.targetId,!0))}async function ox(e,t){let n=e.hu.get(t),r=e.Pu.get(n.targetId);e.isPrimaryClient&&1===r.length&&(e.sharedClientState.removeLocalQueryTarget(n.targetId),aL(e.remoteStore,n.targetId))}async function oS(e,t,n){let r=oX(e);try{var i;let e,s=await function(e,t){let n,r,i=Q.now(),s=t.reduce((e,t)=>e.add(t.key),ri());return e.persistence.runTransaction("Locally write mutations","readwrite",a=>{let o=n8,l=ri();return e.Bs.getEntries(a,s).next(e=>{(o=e).forEach((e,t)=>{t.isValidDocument()||(l=l.add(e))})}).next(()=>e.localDocuments.getOverlayedDocuments(a,o)).next(r=>{n=r;let s=[];for(let e of t){let t=function(e,t){let n=null;for(let r of e.fieldTransforms){let e=t.data.field(r.field),i=rc(r.transform,e||null);null!=i&&(null===n&&(n=nm.empty()),n.set(r.field,i))}return n||null}(e,n.get(e.key).overlayedDocument);null!=t&&s.push(new rN(e.key,t,function e(t){let n=[];return tC(t.fields,(t,r)=>{let i=new X([t]);if(no(r)){let t=e(r.mapValue).fields;if(0===t.length)n.push(i);else for(let e of t)n.push(i.child(e))}else n.push(i)}),new tL(n)}(t.value.mapValue),r_.exists(!0)))}return e.mutationQueue.addMutationBatch(a,i,s,t)}).next(t=>{r=t;let i=t.applyToLocalDocumentSet(n,l);return e.documentOverlayCache.saveOverlays(a,t.batchId,i)})}).then(()=>({batchId:r.batchId,changes:re(n)}))}(r.localStore,t);r.sharedClientState.addPendingMutation(s.batchId),i=s.batchId,(e=r.Au[r.currentUser.toKey()])||(e=new tA(z)),e=e.insert(i,n),r.Au[r.currentUser.toKey()]=e,await oq(r,s.changes),await aW(r.remoteStore)}catch(t){let e=a6(t,"Failed to persist write");n.reject(e)}}async function oC(e,t){try{let n=await function(e,t){let n=t.snapshotVersion,r=e.xs;return e.persistence.runTransaction("Apply remote event","readwrite-primary",i=>{let s=e.Bs.newChangeBuffer({trackRemovals:!0});r=e.xs;let a=[];t.targetChanges.forEach((s,o)=>{var l;let u=r.get(o);if(!u)return;a.push(e.Ti.removeMatchingKeys(i,s.removedDocuments,o).next(()=>e.Ti.addMatchingKeys(i,s.addedDocuments,o)));let c=u.withSequenceNumber(i.currentSequenceNumber);null!==t.targetMismatches.get(o)?c=c.withResumeToken(tO.EMPTY_BYTE_STRING,j.min()).withLastLimboFreeSnapshotVersion(j.min()):s.resumeToken.approximateByteSize()>0&&(c=c.withResumeToken(s.resumeToken,n)),r=r.insert(o,c),l=c,(0===u.resumeToken.approximateByteSize()||l.snapshotVersion.toMicroseconds()-u.snapshotVersion.toMicroseconds()>=3e8||s.addedDocuments.size+s.modifiedDocuments.size+s.removedDocuments.size>0)&&a.push(e.Ti.updateTargetData(i,c))});let o=n8,l=ri();if(t.documentUpdates.forEach(n=>{t.resolvedLimboDocuments.has(n)&&a.push(e.persistence.referenceDelegate.updateLimboDocument(i,n))}),a.push(sY(i,s,t.documentUpdates).next(e=>{o=e.qs,l=e.Qs})),!n.isEqual(j.min())){let t=e.Ti.getLastRemoteSnapshotVersion(i).next(t=>e.Ti.setTargetsMetadata(i,i.currentSequenceNumber,n));a.push(t)}return ef.waitFor(a).next(()=>s.apply(i)).next(()=>e.localDocuments.getLocalViewOfDocuments(i,o,l)).next(()=>o)}).then(t=>(e.xs=r,t))}(e.localStore,t);t.targetChanges.forEach((t,n)=>{let r=e.Eu.get(n);r&&(C(t.addedDocuments.size+t.modifiedDocuments.size+t.removedDocuments.size<=1,22616),t.addedDocuments.size>0?r.cu=!0:t.modifiedDocuments.size>0?C(r.cu,14607):t.removedDocuments.size>0&&(C(r.cu,42227),r.cu=!1))}),await oq(e,n,t)}catch(e){await ed(e)}}function oN(e,t,n){var r;if(e.isPrimaryClient&&0===n||!e.isPrimaryClient&&1===n){let n,i=[];e.hu.forEach((e,n)=>{let r=n.view.Fa(t);r.snapshot&&i.push(r.snapshot)}),(r=e.eventManager).onlineState=t,n=!1,r.queries.forEach((e,r)=>{for(let e of r.Sa)e.Fa(t)&&(n=!0)}),n&&oo(r),i.length&&e.lu.Y_(i),e.onlineState=t,e.isPrimaryClient&&e.sharedClientState.setOnlineState(t)}}async function oD(e,t,n){e.sharedClientState.updateQueryState(t,"rejected",n);let r=e.Eu.get(t),i=r&&r.key;if(i){let n=new tA(Z.comparator);n=n.insert(i,ng.newNoDocument(i,j.min()));let r=ri().add(i),s=new rj(j.min(),new Map,new tA(z),n,r);await oC(e,s),e.Iu=e.Iu.remove(i),e.Eu.delete(t),oO(e)}else await sX(e.localStore,t,!1).then(()=>oV(e,t,n)).catch(ed)}async function oA(e,t){var n;let r=t.batch.batchId;try{let i=await (n=e.localStore,n.persistence.runTransaction("Acknowledge batch","readwrite-primary",e=>{let r=t.batch.keys(),i=n.Bs.newChangeBuffer({trackRemovals:!0});return(function(e,t,n,r){let i=n.batch,s=i.keys(),a=ef.resolve();return s.forEach(e=>{a=a.next(()=>r.getEntry(t,e)).next(t=>{let s=n.docVersions.get(e);C(null!==s,48541),0>t.version.compareTo(s)&&(i.applyToRemoteDocument(t,n),t.isValidDocument()&&(t.setReadTime(n.commitVersion),r.addEntry(t)))})}),a.next(()=>e.mutationQueue.removeMutationBatch(t,i))})(n,e,t,i).next(()=>i.apply(e)).next(()=>n.mutationQueue.performConsistencyCheck(e)).next(()=>n.documentOverlayCache.removeOverlaysForBatchId(e,r,t.batch.batchId)).next(()=>n.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(e,function(e){let t=ri();for(let n=0;n<e.mutationResults.length;++n)e.mutationResults[n].transformResults.length>0&&(t=t.add(e.batch.mutations[n].key));return t}(t))).next(()=>n.localDocuments.getDocuments(e,r))}));oF(e,r,null),oM(e,r),e.sharedClientState.updateMutationState(r,"acknowledged"),await oq(e,i)}catch(e){await ed(e)}}async function ok(e,t,n){var r;try{let i=await (r=e.localStore,r.persistence.runTransaction("Reject batch","readwrite-primary",e=>{let n;return r.mutationQueue.lookupMutationBatch(e,t).next(t=>(C(null!==t,37113),n=t.keys(),r.mutationQueue.removeMutationBatch(e,t))).next(()=>r.mutationQueue.performConsistencyCheck(e)).next(()=>r.documentOverlayCache.removeOverlaysForBatchId(e,n,t)).next(()=>r.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(e,n)).next(()=>r.localDocuments.getDocuments(e,n))}));oF(e,t,n),oM(e,t),e.sharedClientState.updateMutationState(t,"rejected",n),await oq(e,i)}catch(e){await ed(e)}}async function oR(e,t){var n;aB(e.remoteStore)||_(op,"The network is disabled. The task returned by 'awaitPendingWrites()' will not complete until the network is enabled.");try{let r=await (n=e.localStore).persistence.runTransaction("Get highest unacknowledged batch id","readonly",e=>n.mutationQueue.getHighestUnacknowledgedBatchId(e));if(-1===r)return void t.resolve();let i=e.Ru.get(r)||[];i.push(t),e.Ru.set(r,i)}catch(n){let e=a6(n,"Initialization of waitForPendingWrites() operation failed");t.reject(e)}}function oM(e,t){(e.Ru.get(t)||[]).forEach(e=>{e.resolve()}),e.Ru.delete(t)}function oF(e,t,n){let r=e.Au[e.currentUser.toKey()];if(r){let i=r.get(t);i&&(n?i.reject(n):i.resolve(),r=r.remove(t)),e.Au[e.currentUser.toKey()]=r}}function oV(e,t,n=null){for(let r of(e.sharedClientState.removeLocalQueryTarget(t),e.Pu.get(t)))e.hu.delete(r),n&&e.lu.gu(r,n);e.Pu.delete(t),e.isPrimaryClient&&e.du.Hr(t).forEach(t=>{e.du.containsKey(t)||oL(e,t)})}function oL(e,t){e.Tu.delete(t.path.canonicalString());let n=e.Iu.get(t);null!==n&&(aL(e.remoteStore,n),e.Iu=e.Iu.remove(t),e.Eu.delete(n),oO(e))}function oP(e,t,n){for(let r of n)r instanceof of?(e.du.addReference(r.key,t),function(e,t){let n=t.key,r=n.path.canonicalString();e.Iu.get(n)||e.Tu.has(r)||(_(op,"New document in limbo: "+n),e.Tu.add(r),oO(e))}(e,r)):r instanceof om?(_(op,"Document no longer in limbo: "+r.key),e.du.removeReference(r.key,t),e.du.containsKey(r.key)||oL(e,r.key)):x(19791,{pu:r})}function oO(e){for(;e.Tu.size>0&&e.Iu.size<e.maxConcurrentLimboResolutions;){let t=e.Tu.values().next().value;e.Tu.delete(t);let n=new Z(Y.fromString(t)),r=e.Vu.next();e.Eu.set(r,new ow(n)),e.Iu=e.Iu.insert(n,r),aV(e.remoteStore,new iT(nH(nG(n.path)),r,"TargetPurposeLimboResolution",eN.le))}}async function oq(e,t,n){let r=[],i=[],s=[];e.hu.isEmpty()||(e.hu.forEach((a,o)=>{s.push(e.fu(o,t,n).then(t=>{var s;if((t||n)&&e.isPrimaryClient){let r=t?!t.fromCache:null==(s=null==n?void 0:n.targetChanges.get(o.targetId))?void 0:s.current;e.sharedClientState.updateQueryState(o.targetId,r?"current":"not-current")}if(t){r.push(t);let e=s$.Rs(o.targetId,t);i.push(e)}}))}),await Promise.all(s),e.lu.Y_(r),await async function(e,t){try{await e.persistence.runTransaction("notifyLocalViewChanges","readwrite",n=>ef.forEach(t,t=>ef.forEach(t.ds,r=>e.persistence.referenceDelegate.addReference(n,t.targetId,r)).next(()=>ef.forEach(t.As,r=>e.persistence.referenceDelegate.removeReference(n,t.targetId,r)))))}catch(e){if(!eI(e))throw e;_(sQ,"Failed to update sequence numbers: "+e)}for(let n of t){let t=n.targetId;if(!n.fromCache){let n=e.xs.get(t),r=n.snapshotVersion,i=n.withLastLimboFreeSnapshotVersion(r);e.xs=e.xs.insert(t,i)}}}(e.localStore,i))}async function oU(e,t){if(!e.currentUser.isEqual(t)){_(op,"User change. New user:",t.toKey());let n=await sW(e.localStore,t);e.currentUser=t,e.Ru.forEach(e=>{e.forEach(e=>{e.reject(new D(N.CANCELLED,"'waitForPendingWrites' promise is rejected due to a user change."))})}),e.Ru.clear(),e.sharedClientState.handleUserChange(t,n.removedBatchIds,n.addedBatchIds),await oq(e,n.ks)}}function oB(e,t){let n=e.Eu.get(t);if(n&&n.cu)return ri().add(n.key);{let n=ri(),r=e.Pu.get(t);if(!r)return n;for(let t of r){let r=e.hu.get(t);n=n.unionWith(r.view.eu)}return n}}async function oz(e,t){let n=await sZ(e.localStore,t.query,!0),r=t.view.au(n);return e.isPrimaryClient&&oP(e,t.targetId,r.ou),r}async function o$(e,t){return s1(e.localStore,t).then(t=>oq(e,t))}async function oK(e,t,n,r){var i;let s=await function(e,t){let n=e.mutationQueue;return e.persistence.runTransaction("Lookup mutation documents","readonly",r=>n.tr(r,t).next(t=>t?e.localDocuments.getDocuments(r,t):ef.resolve(null)))}(e.localStore,t);null!==s?("pending"===n?await aW(e.remoteStore):"acknowledged"===n||"rejected"===n?(oF(e,t,r||null),oM(e,t),i=e.localStore,i.mutationQueue.sr(t)):x(6720,"Unknown batchState",{yu:n}),await oq(e,s)):_(op,"Cannot apply mutation batch with id: "+t)}async function oG(e,t){if(oJ(e),oX(e),!0===t&&!0!==e.mu){let t=e.sharedClientState.getAllActiveQueryTargets(),n=await oQ(e,t.toArray());for(let t of(e.mu=!0,await a2(e.remoteStore,!0),n))aV(e.remoteStore,t)}else if(!1===t&&!1!==e.mu){let t=[],n=Promise.resolve();e.Pu.forEach((r,i)=>{e.sharedClientState.isLocalQueryTarget(i)?t.push(i):n=n.then(()=>(oV(e,i),sX(e.localStore,i,!0))),aL(e.remoteStore,i)}),await n,await oQ(e,t),e.Eu.forEach((t,n)=>{aL(e.remoteStore,n)}),e.du.Jr(),e.Eu=new Map,e.Iu=new tA(Z.comparator),e.mu=!1,await a2(e.remoteStore,!1)}}async function oQ(e,t,n){let r=[],i=[];for(let n of t){let t,s=e.Pu.get(n);if(s&&0!==s.length)for(let n of(t=await sJ(e.localStore,nH(s[0])),s)){let t=e.hu.get(n),r=await oz(e,t);r.snapshot&&i.push(r.snapshot)}else{let r=await s0(e.localStore,n);t=await sJ(e.localStore,r),await ob(e,oj(r),n,!1,t.resumeToken)}r.push(t)}return e.lu.Y_(i),r}function oj(e){var t,n,r,i,s;return t=e.path,n=e.collectionGroup,r=e.orderBy,i=e.filters,s=e.limit,new nK(t,n,r,i,s,"F",e.startAt,e.endAt)}function oW(e){return e.localStore.persistence.Is()}async function oH(e,t,n,r){if(e.mu)return void _(op,"Ignoring unexpected query state notification.");let i=e.Pu.get(t);if(i&&i.length>0)switch(n){case"current":case"not-current":{let r=await s1(e.localStore,n4(i[0])),s=rj.createSynthesizedRemoteEventForCurrentChange(t,"current"===n,tO.EMPTY_BYTE_STRING);await oq(e,r,s);break}case"rejected":await sX(e.localStore,t,!0),oV(e,t,r);break;default:x(64155,n)}}async function oY(e,t,n){let r=oJ(e);if(r.mu){for(let e of t){if(r.Pu.has(e)&&r.sharedClientState.isActiveQueryTarget(e)){_(op,"Adding an already active target "+e);continue}let t=await s0(r.localStore,e),n=await sJ(r.localStore,t);await ob(r,oj(t),n.targetId,!1,n.resumeToken),aV(r.remoteStore,n)}for(let e of n)r.Pu.has(e)&&await sX(r.localStore,e,!1).then(()=>{aL(r.remoteStore,e),oV(r,e)}).catch(ed)}}function oJ(e){return e.remoteStore.remoteSyncer.applyRemoteEvent=oC.bind(null,e),e.remoteStore.remoteSyncer.getRemoteKeysForTarget=oB.bind(null,e),e.remoteStore.remoteSyncer.rejectListen=oD.bind(null,e),e.lu.Y_=os.bind(null,e.eventManager),e.lu.gu=oa.bind(null,e.eventManager),e}function oX(e){return e.remoteStore.remoteSyncer.applySuccessfulWrite=oA.bind(null,e),e.remoteStore.remoteSyncer.rejectFailedWrite=ok.bind(null,e),e}class oZ{constructor(){this.kind="memory",this.synchronizeTabs=!1}async initialize(e){this.serializer=aT(e.databaseInfo.databaseId),this.sharedClientState=this.bu(e),this.persistence=this.Su(e),await this.persistence.start(),this.localStore=this.Du(e),this.gcScheduler=this.vu(e,this.localStore),this.indexBackfillerScheduler=this.Cu(e,this.localStore)}vu(e,t){return null}Cu(e,t){return null}Du(e){var t,n;return t=this.persistence,n=new sG,new sj(t,n,e.initialUser,this.serializer)}Su(e){return new sR(sF.fi,this.serializer)}bu(e){return new al}async terminate(){var e,t;null==(e=this.gcScheduler)||e.stop(),null==(t=this.indexBackfillerScheduler)||t.stop(),this.sharedClientState.shutdown(),await this.persistence.shutdown()}}oZ.provider={build:()=>new oZ};class o0 extends oZ{constructor(e){super(),this.cacheSizeBytes=e}vu(e,t){return C(this.persistence.referenceDelegate instanceof sV,46915),new sh(this.persistence.referenceDelegate.garbageCollector,e.asyncQueue,t)}Su(e){let t=void 0!==this.cacheSizeBytes?i7.withCacheSize(this.cacheSizeBytes):i7.DEFAULT;return new sR(e=>sV.fi(e,t),this.serializer)}}class o1 extends oZ{constructor(e,t,n){super(),this.Fu=e,this.cacheSizeBytes=t,this.forceOwnership=n,this.kind="persistent",this.synchronizeTabs=!1}async initialize(e){await super.initialize(e),await this.Fu.initialize(this,e),await oX(this.Fu.syncEngine),await aW(this.Fu.remoteStore),await this.persistence.Ji(()=>(this.gcScheduler&&!this.gcScheduler.started&&this.gcScheduler.start(),this.indexBackfillerScheduler&&!this.indexBackfillerScheduler.started&&this.indexBackfillerScheduler.start(),Promise.resolve()))}Du(e){var t,n;return t=this.persistence,n=new sG,new sj(t,n,e.initialUser,this.serializer)}vu(e,t){return new sh(this.persistence.referenceDelegate.garbageCollector,e.asyncQueue,t)}Cu(e,t){let n=new eC(t,this.persistence);return new eS(e.asyncQueue,n)}Su(e){let t=sz(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey),n=void 0!==this.cacheSizeBytes?i7.withCacheSize(this.cacheSizeBytes):i7.DEFAULT;return new sB(this.synchronizeTabs,t,e.clientId,n,e.asyncQueue,aI(),a_(),this.serializer,this.sharedClientState,!!this.forceOwnership)}bu(e){return new al}}class o2 extends o1{constructor(e,t){super(e,t,!1),this.Fu=e,this.cacheSizeBytes=t,this.synchronizeTabs=!0}async initialize(e){await super.initialize(e);let t=this.Fu.syncEngine;this.sharedClientState instanceof ao&&(this.sharedClientState.syncEngine={Co:oK.bind(null,t),Fo:oH.bind(null,t),Mo:oY.bind(null,t),Is:oW.bind(null,t),vo:o$.bind(null,t)},await this.sharedClientState.start()),await this.persistence.Ji(async e=>{await oG(this.Fu.syncEngine,e),this.gcScheduler&&(e&&!this.gcScheduler.started?this.gcScheduler.start():e||this.gcScheduler.stop()),this.indexBackfillerScheduler&&(e&&!this.indexBackfillerScheduler.started?this.indexBackfillerScheduler.start():e||this.indexBackfillerScheduler.stop())})}bu(e){let t=aI();if(!ao.C(t))throw new D(N.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");let n=sz(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey);return new ao(t,e.asyncQueue,n,e.clientId,e.initialUser)}}class o5{async initialize(e,t){this.localStore||(this.localStore=e.localStore,this.sharedClientState=e.sharedClientState,this.datastore=this.createDatastore(t),this.remoteStore=this.createRemoteStore(t),this.eventManager=this.createEventManager(t),this.syncEngine=this.createSyncEngine(t,!e.synchronizeTabs),this.sharedClientState.onlineStateHandler=e=>oN(this.syncEngine,e,1),this.remoteStore.remoteSyncer.handleCredentialChange=oU.bind(null,this.syncEngine),await a2(this.remoteStore,this.syncEngine.isPrimaryClient))}createEventManager(e){return new ot}createDatastore(e){var t;let n=aT(e.databaseInfo.databaseId),r=new av(e.databaseInfo);return t=e.authCredentials,new aD(t,e.appCheckCredentials,r,n)}createRemoteStore(e){var t,n;return t=this.localStore,n=this.datastore,new aR(t,n,e.asyncQueue,e=>oN(this.syncEngine,e,0),ah.C()?new ah:new au)}createSyncEngine(e,t){return function(e,t,n,r,i,s,a){let o=new ov(e,t,n,r,i,s);return a&&(o.mu=!0),o}(this.localStore,this.remoteStore,this.eventManager,this.sharedClientState,e.initialUser,e.maxConcurrentLimboResolutions,t)}async terminate(){var e,t;await async function(e){_(ak,"RemoteStore shutting down."),e.da.add(5),await aF(e),e.Ra.shutdown(),e.Va.set("Unknown")}(this.remoteStore),null==(e=this.datastore)||e.terminate(),null==(t=this.eventManager)||t.terminate()}}function o4(e,t=10240){let n=0;return{async read(){if(n<e.byteLength){let r={value:e.slice(n,n+t),done:!1};return n+=t,r}return{done:!0}},async cancel(){},releaseLock(){},closed:Promise.resolve()}}o5.provider={build:()=>new o5};class o3{constructor(e){this.observer=e,this.muted=!1}next(e){this.muted||this.observer.next&&this.Mu(this.observer.next,e)}error(e){this.muted||(this.observer.error?this.Mu(this.observer.error,e):T("Uncaught Error in snapshot listener:",e.toString()))}xu(){this.muted=!0}Mu(e,t){setTimeout(()=>{this.muted||e(t)},0)}}class o6{constructor(e,t){this.Ou=e,this.serializer=t,this.metadata=new A,this.buffer=new Uint8Array,this.Nu=new TextDecoder("utf-8"),this.Bu().then(e=>{e&&e.Ua()?this.metadata.resolve(e.$a.metadata):this.metadata.reject(Error(`The first element of the bundle is not a metadata, it is
             ${JSON.stringify(null==e?void 0:e.$a)}`))},e=>this.metadata.reject(e))}close(){return this.Ou.cancel()}async getMetadata(){return this.metadata.promise}async wu(){return await this.getMetadata(),this.Bu()}async Bu(){let e=await this.Lu();if(null===e)return null;let t=this.Nu.decode(e),n=Number(t);return isNaN(n)&&this.ku(`length string (${t}) is not valid number`),new ou(JSON.parse(await this.qu(n)),e.length+n)}Qu(){return this.buffer.findIndex(e=>123===e)}async Lu(){for(;0>this.Qu()&&!await this.$u(););if(0===this.buffer.length)return null;let e=this.Qu();e<0&&this.ku("Reached the end of bundle when a length string is expected.");let t=this.buffer.slice(0,e);return this.buffer=this.buffer.slice(e),t}async qu(e){for(;this.buffer.length<e;)await this.$u()&&this.ku("Reached the end of bundle when more is expected.");let t=this.Nu.decode(this.buffer.slice(0,e));return this.buffer=this.buffer.slice(e),t}ku(e){throw this.Ou.cancel(),Error(`Invalid bundle format: ${e}`)}async $u(){let e=await this.Ou.read();if(!e.done){let t=new Uint8Array(this.buffer.length+e.value.length);t.set(this.buffer),t.set(e.value,this.buffer.length),this.buffer=t}return e.done}}class o8{constructor(e){this.datastore=e,this.readVersions=new Map,this.mutations=[],this.committed=!1,this.lastTransactionError=null,this.writtenDocs=new Set}async lookup(e){if(this.ensureCommitNotCalled(),this.mutations.length>0)throw this.lastTransactionError=new D(N.INVALID_ARGUMENT,"Firestore transactions require all reads to be executed before all writes."),this.lastTransactionError;let t=await async function(e,t){let n={documents:t.map(t=>ii(e.serializer,t))},r=await e.Yo("BatchGetDocuments",e.serializer.databaseId,Y.emptyPath(),n,t.length),i=new Map;r.forEach(t=>{var n;let r=(n=e.serializer,"found"in t?function(e,t){C(!!t.found,43571),t.found.name,t.found.updateTime;let n=is(e,t.found.name),r=r7(t.found.updateTime),i=t.found.createTime?r7(t.found.createTime):j.min(),s=new nm({mapValue:{fields:t.found.fields}});return ng.newFoundDocument(n,r,i,s)}(n,t):"missing"in t?function(e,t){C(!!t.missing,3894),C(!!t.readTime,22933);let n=is(e,t.missing),r=r7(t.readTime);return ng.newNoDocument(n,r)}(n,t):x(7234,{result:t}));i.set(r.key.toString(),r)});let s=[];return t.forEach(e=>{let t=i.get(e.toString());C(!!t,55234,{key:e}),s.push(t)}),s}(this.datastore,e);return t.forEach(e=>this.recordVersion(e)),t}set(e,t){this.write(t.toMutation(e,this.precondition(e))),this.writtenDocs.add(e.toString())}update(e,t){try{this.write(t.toMutation(e,this.preconditionForUpdate(e)))}catch(e){this.lastTransactionError=e}this.writtenDocs.add(e.toString())}delete(e){this.write(new rR(e,this.precondition(e))),this.writtenDocs.add(e.toString())}async commit(){if(this.ensureCommitNotCalled(),this.lastTransactionError)throw this.lastTransactionError;let e=this.readVersions;this.mutations.forEach(t=>{e.delete(t.key.toString())}),e.forEach((e,t)=>{let n=Z.fromPath(t);this.mutations.push(new rM(n,this.precondition(n)))}),await async function(e,t){let n={writes:t.map(t=>id(e.serializer,t))};await e.zo("Commit",e.serializer.databaseId,Y.emptyPath(),n)}(this.datastore,this.mutations),this.committed=!0}recordVersion(e){let t;if(e.isFoundDocument())t=e.version;else{if(!e.isNoDocument())throw x(50498,{Uu:e.constructor.name});t=j.min()}let n=this.readVersions.get(e.key.toString());if(n){if(!t.isEqual(n))throw new D(N.ABORTED,"Document version changed between two reads.")}else this.readVersions.set(e.key.toString(),t)}precondition(e){let t=this.readVersions.get(e.toString());return!this.writtenDocs.has(e.toString())&&t?t.isEqual(j.min())?r_.exists(!1):r_.updateTime(t):r_.none()}preconditionForUpdate(e){let t=this.readVersions.get(e.toString());if(!this.writtenDocs.has(e.toString())&&t){if(t.isEqual(j.min()))throw new D(N.INVALID_ARGUMENT,"Can't update a document that doesn't exist.");return r_.updateTime(t)}return r_.exists(!0)}write(e){this.ensureCommitNotCalled(),this.mutations.push(e)}ensureCommitNotCalled(){}}class o9{constructor(e,t,n,r,i){this.asyncQueue=e,this.datastore=t,this.options=n,this.updateFunction=r,this.deferred=i,this.Ku=n.maxAttempts,this.x_=new ab(this.asyncQueue,"transaction_retry")}Wu(){this.Ku-=1,this.Gu()}Gu(){this.x_.y_(async()=>{let e=new o8(this.datastore),t=this.zu(e);t&&t.then(t=>{this.asyncQueue.enqueueAndForget(()=>e.commit().then(()=>{this.deferred.resolve(t)}).catch(e=>{this.ju(e)}))}).catch(e=>{this.ju(e)})})}zu(e){try{let t=this.updateFunction(e);return!eD(t)&&t.catch&&t.then?t:(this.deferred.reject(Error("Transaction callback must return a Promise")),null)}catch(e){return this.deferred.reject(e),null}}ju(e){this.Ku>0&&this.Hu(e)?(this.Ku-=1,this.asyncQueue.enqueueAndForget(()=>(this.Gu(),Promise.resolve()))):this.deferred.reject(e)}Hu(e){if("FirebaseError"===e.name){let t=e.code;return"aborted"===t||"failed-precondition"===t||"already-exists"===t||!rq(t)}return!1}}let o7="FirestoreClient";class le{constructor(e,t,n,r,i){this.authCredentials=e,this.appCheckCredentials=t,this.asyncQueue=n,this.databaseInfo=r,this.user=y.UNAUTHENTICATED,this.clientId=B.newId(),this.authCredentialListener=()=>Promise.resolve(),this.appCheckCredentialListener=()=>Promise.resolve(),this._uninitializedComponentsProvider=i,this.authCredentials.start(n,async e=>{_(o7,"Received user=",e.uid),await this.authCredentialListener(e),this.user=e}),this.appCheckCredentials.start(n,e=>(_(o7,"Received new app check token=",e),this.appCheckCredentialListener(e,this.user)))}get configuration(){return{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,authCredentials:this.authCredentials,appCheckCredentials:this.appCheckCredentials,initialUser:this.user,maxConcurrentLimboResolutions:100}}setCredentialChangeListener(e){this.authCredentialListener=e}setAppCheckTokenChangeListener(e){this.appCheckCredentialListener=e}terminate(){this.asyncQueue.enterRestrictedMode();let e=new A;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted(async()=>{try{this._onlineComponents&&await this._onlineComponents.terminate(),this._offlineComponents&&await this._offlineComponents.terminate(),this.authCredentials.shutdown(),this.appCheckCredentials.shutdown(),e.resolve()}catch(n){let t=a6(n,"Failed to shutdown persistence");e.reject(t)}}),e.promise}}async function lt(e,t){e.asyncQueue.verifyOperationInProgress(),_(o7,"Initializing OfflineComponentProvider");let n=e.configuration;await t.initialize(n);let r=n.initialUser;e.setCredentialChangeListener(async e=>{r.isEqual(e)||(await sW(t.localStore,e),r=e)}),t.persistence.setDatabaseDeletedListener(()=>e.terminate()),e._offlineComponents=t}async function ln(e,t){e.asyncQueue.verifyOperationInProgress();let n=await lr(e);_(o7,"Initializing OnlineComponentProvider"),await t.initialize(n,e.configuration),e.setCredentialChangeListener(e=>a1(t.remoteStore,e)),e.setAppCheckTokenChangeListener((e,n)=>a1(t.remoteStore,n)),e._onlineComponents=t}async function lr(e){if(!e._offlineComponents)if(e._uninitializedComponentsProvider){_(o7,"Using user provided OfflineComponentProvider");try{await lt(e,e._uninitializedComponentsProvider._offline)}catch(t){if(!("FirebaseError"===t.name?t.code===N.FAILED_PRECONDITION||t.code===N.UNIMPLEMENTED:!("undefined"!=typeof DOMException&&t instanceof DOMException)||22===t.code||20===t.code||11===t.code))throw t;b("Error using user provided cache. Falling back to memory cache: "+t),await lt(e,new oZ)}}else _(o7,"Using default OfflineComponentProvider"),await lt(e,new o0(void 0));return e._offlineComponents}async function li(e){return e._onlineComponents||(e._uninitializedComponentsProvider?(_(o7,"Using user provided OnlineComponentProvider"),await ln(e,e._uninitializedComponentsProvider._online)):(_(o7,"Using default OnlineComponentProvider"),await ln(e,new o5))),e._onlineComponents}function ls(e){return lr(e).then(e=>e.persistence)}function la(e){return lr(e).then(e=>e.localStore)}function lo(e){return li(e).then(e=>e.remoteStore)}function ll(e){return li(e).then(e=>e.syncEngine)}function lu(e){return li(e).then(e=>e.datastore)}async function lc(e){let t=await li(e),n=t.eventManager;return n.onListen=oI.bind(null,t.syncEngine),n.onUnlisten=oE.bind(null,t.syncEngine),n.onFirstRemoteStoreListen=o_.bind(null,t.syncEngine),n.onLastRemoteStoreUnlisten=ox.bind(null,t.syncEngine),n}function lh(e,t,n={}){let r=new A;return e.asyncQueue.enqueueAndForget(async()=>(function(e,t,n,r,i){let s=new o3({next:o=>{s.xu(),t.enqueueAndForget(()=>oi(e,a));let l=o.docs.has(n);!l&&o.fromCache?i.reject(new D(N.UNAVAILABLE,"Failed to get document because the client is offline.")):l&&o.fromCache&&r&&"server"===r.source?i.reject(new D(N.UNAVAILABLE,'Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to "server" to retrieve the cached document.)')):i.resolve(o)},error:e=>i.reject(e)}),a=new ol(nG(n.path),s,{includeMetadataChanges:!0,Qa:!0});return or(e,a)})(await lc(e),e.asyncQueue,t,n,r)),r.promise}function ld(e,t,n={}){let r=new A;return e.asyncQueue.enqueueAndForget(async()=>(function(e,t,n,r,i){let s=new o3({next:n=>{s.xu(),t.enqueueAndForget(()=>oi(e,a)),n.fromCache&&"server"===r.source?i.reject(new D(N.UNAVAILABLE,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):i.resolve(n)},error:e=>i.reject(e)}),a=new ol(n,s,{includeMetadataChanges:!0,Qa:!0});return or(e,a)})(await lc(e),e.asyncQueue,t,n,r)),r.promise}function lf(e){let t={};return void 0!==e.timeoutSeconds&&(t.timeoutSeconds=e.timeoutSeconds),t}let lm=new Map;function lg(e,t,n){if(!n)throw new D(N.INVALID_ARGUMENT,`Function ${e}() cannot be called with an empty ${t}.`)}function lp(e,t,n,r){if(!0===t&&!0===r)throw new D(N.INVALID_ARGUMENT,`${e} and ${n} cannot be used together.`)}function ly(e){if(!Z.isDocumentKey(e))throw new D(N.INVALID_ARGUMENT,`Invalid document reference. Document references must have an even number of segments, but ${e} has ${e.length}.`)}function lw(e){if(Z.isDocumentKey(e))throw new D(N.INVALID_ARGUMENT,`Invalid collection reference. Collection references must have an odd number of segments, but ${e} has ${e.length}.`)}function lv(e){if(void 0===e)return"undefined";if(null===e)return"null";if("string"==typeof e)return e.length>20&&(e=`${e.substring(0,20)}...`),JSON.stringify(e);if("number"==typeof e||"boolean"==typeof e)return""+e;if("object"==typeof e){if(e instanceof Array)return"an array";{var t;let n=(t=e).constructor?t.constructor.name:null;return n?`a custom ${n} object`:"an object"}}return"function"==typeof e?"a function":x(12329,{type:typeof e})}function lI(e,t){if("_delegate"in e&&(e=e._delegate),!(e instanceof t)){if(t.name===e.constructor.name)throw new D(N.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");{let n=lv(e);throw new D(N.INVALID_ARGUMENT,`Expected type '${t.name}', but it was: ${n}`)}}return e}function l_(e,t){if(t<=0)throw new D(N.INVALID_ARGUMENT,`Function ${e}() requires a positive number, but it was: ${t}.`)}let lT="firestore.googleapis.com";class lb{constructor(e){var t,n;if(void 0===e.host){if(void 0!==e.ssl)throw new D(N.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host=lT,this.ssl=!0}else this.host=e.host,this.ssl=null==(t=e.ssl)||t;if(this.isUsingEmulator=void 0!==e.emulatorOptions,this.credentials=e.credentials,this.ignoreUndefinedProperties=!!e.ignoreUndefinedProperties,this.localCache=e.localCache,void 0===e.cacheSizeBytes)this.cacheSizeBytes=0x2800000;else{if(-1!==e.cacheSizeBytes&&e.cacheSizeBytes<1048576)throw new D(N.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=e.cacheSizeBytes}lp("experimentalForceLongPolling",e.experimentalForceLongPolling,"experimentalAutoDetectLongPolling",e.experimentalAutoDetectLongPolling),this.experimentalForceLongPolling=!!e.experimentalForceLongPolling,this.experimentalForceLongPolling?this.experimentalAutoDetectLongPolling=!1:void 0===e.experimentalAutoDetectLongPolling?this.experimentalAutoDetectLongPolling=!0:this.experimentalAutoDetectLongPolling=!!e.experimentalAutoDetectLongPolling,this.experimentalLongPollingOptions=lf(null!=(n=e.experimentalLongPollingOptions)?n:{}),function(e){if(void 0!==e.timeoutSeconds){if(isNaN(e.timeoutSeconds))throw new D(N.INVALID_ARGUMENT,`invalid long polling timeout: ${e.timeoutSeconds} (must not be NaN)`);if(e.timeoutSeconds<5)throw new D(N.INVALID_ARGUMENT,`invalid long polling timeout: ${e.timeoutSeconds} (minimum allowed value is 5)`);if(e.timeoutSeconds>30)throw new D(N.INVALID_ARGUMENT,`invalid long polling timeout: ${e.timeoutSeconds} (maximum allowed value is 30)`)}}(this.experimentalLongPollingOptions),this.useFetchStreams=!!e.useFetchStreams}isEqual(e){var t,n;return this.host===e.host&&this.ssl===e.ssl&&this.credentials===e.credentials&&this.cacheSizeBytes===e.cacheSizeBytes&&this.experimentalForceLongPolling===e.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===e.experimentalAutoDetectLongPolling&&(t=this.experimentalLongPollingOptions,n=e.experimentalLongPollingOptions,t.timeoutSeconds===n.timeoutSeconds)&&this.ignoreUndefinedProperties===e.ignoreUndefinedProperties&&this.useFetchStreams===e.useFetchStreams}}class lE{constructor(e,t,n,r){this._authCredentials=e,this._appCheckCredentials=t,this._databaseId=n,this._app=r,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new lb({}),this._settingsFrozen=!1,this._emulatorOptions={},this._terminateTask="notTerminated"}get app(){if(!this._app)throw new D(N.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._app}get _initialized(){return this._settingsFrozen}get _terminated(){return"notTerminated"!==this._terminateTask}_setSettings(e){if(this._settingsFrozen)throw new D(N.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new lb(e),this._emulatorOptions=e.emulatorOptions||{},void 0!==e.credentials&&(this._authCredentials=function(e){if(!e)return new R;switch(e.type){case"firstParty":return new L(e.sessionIndex||"0",e.iamToken||null,e.authTokenFactory||null);case"provider":return e.client;default:throw new D(N.INVALID_ARGUMENT,"makeAuthCredentialsProvider failed due to invalid credential type")}}(e.credentials))}_getSettings(){return this._settings}_getEmulatorOptions(){return this._emulatorOptions}_freezeSettings(){return this._settingsFrozen=!0,this._settings}_delete(){return"notTerminated"===this._terminateTask&&(this._terminateTask=this._terminate()),this._terminateTask}async _restart(){"notTerminated"===this._terminateTask?await this._terminate():this._terminateTask="notTerminated"}toJSON(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}_terminate(){return function(e){let t=lm.get(e);t&&(_("ComponentProvider","Removing Datastore"),lm.delete(e),t.terminate())}(this),Promise.resolve()}}function lx(e,t,n,r={}){var i;e=lI(e,lE);let s=d.isCloudWorkstation(t),a=e._getSettings(),o=Object.assign(Object.assign({},a),{emulatorOptions:e._getEmulatorOptions()}),l=`${t}:${n}`;s&&(d.pingServer(`https://${l}`),d.updateEmulatorBanner("Firestore",!0)),a.host!==lT&&a.host!==l&&b("Host has been set in both settings() and connectFirestoreEmulator(), emulator host will be used.");let u=Object.assign(Object.assign({},a),{host:l,ssl:s,emulatorOptions:r});if(!d.deepEqual(u,o)&&(e._setSettings(u),r.mockUserToken)){let t,n;if("string"==typeof r.mockUserToken)t=r.mockUserToken,n=y.MOCK_USER;else{t=d.createMockUserToken(r.mockUserToken,null==(i=e._app)?void 0:i.options.projectId);let s=r.mockUserToken.sub||r.mockUserToken.user_id;if(!s)throw new D(N.INVALID_ARGUMENT,"mockUserToken must contain 'sub' or 'user_id' field!");n=new y(s)}e._authCredentials=new M(new k(t,n))}}class lS{constructor(e,t,n){this.converter=t,this._query=n,this.type="query",this.firestore=e}withConverter(e){return new lS(this.firestore,e,this._query)}}class lC{constructor(e,t,n){this.converter=t,this._key=n,this.type="document",this.firestore=e}get _path(){return this._key.path}get id(){return this._key.path.lastSegment()}get path(){return this._key.path.canonicalString()}get parent(){return new lN(this.firestore,this.converter,this._key.path.popLast())}withConverter(e){return new lC(this.firestore,e,this._key)}}class lN extends lS{constructor(e,t,n){super(e,t,nG(n)),this._path=n,this.type="collection"}get id(){return this._query.path.lastSegment()}get path(){return this._query.path.canonicalString()}get parent(){let e=this._path.popLast();return e.isEmpty()?null:new lC(this.firestore,null,new Z(e))}withConverter(e){return new lN(this.firestore,e,this._path)}}function lD(e,t,...n){if(e=d.getModularInstance(e),1==arguments.length&&(t=B.newId()),lg("doc","path",t),e instanceof lE){let r=Y.fromString(t,...n);return ly(r),new lC(e,null,new Z(r))}{if(!(e instanceof lC||e instanceof lN))throw new D(N.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");let r=e._path.child(Y.fromString(t,...n));return ly(r),new lC(e.firestore,e instanceof lN?e.converter:null,new Z(r))}}function lA(e,t){return e=d.getModularInstance(e),t=d.getModularInstance(t),e instanceof lS&&t instanceof lS&&e.firestore===t.firestore&&n0(e._query,t._query)&&e.converter===t.converter}let lk="AsyncQueue";class lR{constructor(e=Promise.resolve()){this.Ju=[],this.Yu=!1,this.Zu=[],this.Xu=null,this.ec=!1,this.tc=!1,this.nc=[],this.x_=new ab(this,"async_queue_retry"),this.rc=()=>{let e=a_();e&&_(lk,"Visibility state changed to "+e.visibilityState),this.x_.b_()},this.sc=e;let t=a_();t&&"function"==typeof t.addEventListener&&t.addEventListener("visibilitychange",this.rc)}get isShuttingDown(){return this.Yu}enqueueAndForget(e){this.enqueue(e)}enqueueAndForgetEvenWhileRestricted(e){this.oc(),this._c(e)}enterRestrictedMode(e){if(!this.Yu){this.Yu=!0,this.tc=e||!1;let t=a_();t&&"function"==typeof t.removeEventListener&&t.removeEventListener("visibilitychange",this.rc)}}enqueue(e){if(this.oc(),this.Yu)return new Promise(()=>{});let t=new A;return this._c(()=>this.Yu&&this.tc?Promise.resolve():(e().then(t.resolve,t.reject),t.promise)).then(()=>t.promise)}enqueueRetryable(e){this.enqueueAndForget(()=>(this.Ju.push(e),this.ac()))}async ac(){if(0!==this.Ju.length){try{await this.Ju[0](),this.Ju.shift(),this.x_.reset()}catch(e){if(!eI(e))throw e;_(lk,"Operation failed with retryable error: "+e)}this.Ju.length>0&&this.x_.y_(()=>this.ac())}}_c(e){let t=this.sc.then(()=>(this.ec=!0,e().catch(e=>{throw this.Xu=e,this.ec=!1,T("INTERNAL UNHANDLED ERROR: ",lM(e)),e}).then(e=>(this.ec=!1,e))));return this.sc=t,t}enqueueAfterDelay(e,t,n){this.oc(),this.nc.indexOf(e)>-1&&(t=0);let r=a3.createAndSchedule(this,e,t,n,e=>this.uc(e));return this.Zu.push(r),r}oc(){this.Xu&&x(47125,{cc:lM(this.Xu)})}verifyOperationInProgress(){}async lc(){let e;do e=this.sc,await e;while(e!==this.sc)}hc(e){for(let t of this.Zu)if(t.timerId===e)return!0;return!1}Pc(e){return this.lc().then(()=>{for(let t of(this.Zu.sort((e,t)=>e.targetTimeMs-t.targetTimeMs),this.Zu))if(t.skipDelay(),"all"!==e&&t.timerId===e)break;return this.lc()})}Tc(e){this.nc.push(e)}uc(e){let t=this.Zu.indexOf(e);this.Zu.splice(t,1)}}function lM(e){let t=e.message||"";return e.stack&&(t=e.stack.includes(e.message)?e.stack:e.message+"\n"+e.stack),t}function lF(e){if("object"!=typeof e||null===e)return!1;for(let t of["next","error","complete"])if(t in e&&"function"==typeof e[t])return!0;return!1}class lV{constructor(){this._progressObserver={},this._taskCompletionResolver=new A,this._lastProgress={taskState:"Running",totalBytes:0,totalDocuments:0,bytesLoaded:0,documentsLoaded:0}}onProgress(e,t,n){this._progressObserver={next:e,error:t,complete:n}}catch(e){return this._taskCompletionResolver.promise.catch(e)}then(e,t){return this._taskCompletionResolver.promise.then(e,t)}_completeWith(e){this._updateProgress(e),this._progressObserver.complete&&this._progressObserver.complete(),this._taskCompletionResolver.resolve(e)}_failWith(e){this._lastProgress.taskState="Error",this._progressObserver.next&&this._progressObserver.next(this._lastProgress),this._progressObserver.error&&this._progressObserver.error(e),this._taskCompletionResolver.reject(e)}_updateProgress(e){this._lastProgress=e,this._progressObserver.next&&this._progressObserver.next(e)}}class lL extends lE{constructor(e,t,n,r){super(e,t,n,r),this.type="firestore",this._queue=new lR,this._persistenceKey=(null==r?void 0:r.name)||"[DEFAULT]"}async _terminate(){if(this._firestoreClient){let e=this._firestoreClient.terminate();this._queue=new lR(e),this._firestoreClient=void 0,await e}}}function lP(e){if(e._terminated)throw new D(N.FAILED_PRECONDITION,"The client has already been terminated.");return e._firestoreClient||lO(e),e._firestoreClient}function lO(e){var t,n,r,i,s;let a=e._freezeSettings(),o=(i=e._databaseId,s=(null==(t=e._app)?void 0:t.options.appId)||"",new tY(i,s,e._persistenceKey,a.host,a.ssl,a.experimentalForceLongPolling,a.experimentalAutoDetectLongPolling,lf(a.experimentalLongPollingOptions),a.useFetchStreams,a.isUsingEmulator));e._componentsProvider||(null==(n=a.localCache)?void 0:n._offlineComponentProvider)&&(null==(r=a.localCache)?void 0:r._onlineComponentProvider)&&(e._componentsProvider={_offline:a.localCache._offlineComponentProvider,_online:a.localCache._onlineComponentProvider}),e._firestoreClient=new le(e._authCredentials,e._appCheckCredentials,e._queue,o,e._componentsProvider&&function(e){let t=null==e?void 0:e._online.build();return{_offline:null==e?void 0:e._offline.build(t),_online:t}}(e._componentsProvider))}async function lq(e){b("enableMultiTabIndexedDbPersistence() will be deprecated in the future, you can use `FirestoreSettings.cache` instead.");let t=e._freezeSettings();lU(e,o5.provider,{build:e=>new o2(e,t.cacheSizeBytes)})}function lU(e,t,n){if((e=lI(e,lL))._firestoreClient||e._terminated)throw new D(N.FAILED_PRECONDITION,"Firestore has already been started and persistence can no longer be enabled. You can only enable persistence before calling any other methods on a Firestore object.");if(e._componentsProvider||e._getSettings().localCache)throw new D(N.FAILED_PRECONDITION,"SDK cache is already specified.");e._componentsProvider={_online:t,_offline:n},lO(e)}class lB{constructor(e="count",t){this._internalFieldPath=t,this.type="AggregateField",this.aggregateType=e}}class lz{constructor(e,t,n){this._userDataWriter=t,this._data=n,this.type="AggregateQuerySnapshot",this.query=e}data(){return this._userDataWriter.convertObjectMap(this._data)}}class l${constructor(e){this._byteString=e}static fromBase64String(e){try{return new l$(tO.fromBase64String(e))}catch(e){throw new D(N.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+e)}}static fromUint8Array(e){return new l$(tO.fromUint8Array(e))}toBase64(){return this._byteString.toBase64()}toUint8Array(){return this._byteString.toUint8Array()}toString(){return"Bytes(base64: "+this.toBase64()+")"}isEqual(e){return this._byteString.isEqual(e._byteString)}}class lK{constructor(...e){for(let t=0;t<e.length;++t)if(0===e[t].length)throw new D(N.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new X(e)}isEqual(e){return this._internalPath.isEqual(e._internalPath)}}class lG{constructor(e){this._methodName=e}}class lQ{constructor(e,t){if(!isFinite(e)||e<-90||e>90)throw new D(N.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+e);if(!isFinite(t)||t<-180||t>180)throw new D(N.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+t);this._lat=e,this._long=t}get latitude(){return this._lat}get longitude(){return this._long}isEqual(e){return this._lat===e._lat&&this._long===e._long}toJSON(){return{latitude:this._lat,longitude:this._long}}_compareTo(e){return z(this._lat,e._lat)||z(this._long,e._long)}}class lj{constructor(e){this._values=(e||[]).map(e=>e)}toArray(){return this._values.map(e=>e)}isEqual(e){return function(e,t){if(e.length!==t.length)return!1;for(let n=0;n<e.length;++n)if(e[n]!==t[n])return!1;return!0}(this._values,e._values)}}let lW=/^__.*__$/;class lH{constructor(e,t,n){this.data=e,this.fieldMask=t,this.fieldTransforms=n}toMutation(e,t){return null!==this.fieldMask?new rN(e,this.data,this.fieldMask,t,this.fieldTransforms):new rC(e,this.data,t,this.fieldTransforms)}}class lY{constructor(e,t,n){this.data=e,this.fieldMask=t,this.fieldTransforms=n}toMutation(e,t){return new rN(e,this.data,this.fieldMask,t,this.fieldTransforms)}}function lJ(e){switch(e){case 0:case 2:case 1:return!0;case 3:case 4:return!1;default:throw x(40011,{Ic:e})}}class lX{constructor(e,t,n,r,i,s){this.settings=e,this.databaseId=t,this.serializer=n,this.ignoreUndefinedProperties=r,void 0===i&&this.Ec(),this.fieldTransforms=i||[],this.fieldMask=s||[]}get path(){return this.settings.path}get Ic(){return this.settings.Ic}dc(e){return new lX(Object.assign(Object.assign({},this.settings),e),this.databaseId,this.serializer,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)}Ac(e){var t;let n=null==(t=this.path)?void 0:t.child(e),r=this.dc({path:n,Rc:!1});return r.Vc(e),r}mc(e){var t;let n=null==(t=this.path)?void 0:t.child(e),r=this.dc({path:n,Rc:!1});return r.Ec(),r}fc(e){return this.dc({path:void 0,Rc:!0})}gc(e){return ul(e,this.settings.methodName,this.settings.yc||!1,this.path,this.settings.wc)}contains(e){return void 0!==this.fieldMask.find(t=>e.isPrefixOf(t))||void 0!==this.fieldTransforms.find(t=>e.isPrefixOf(t.field))}Ec(){if(this.path)for(let e=0;e<this.path.length;e++)this.Vc(this.path.get(e))}Vc(e){if(0===e.length)throw this.gc("Document fields must not be empty");if(lJ(this.Ic)&&lW.test(e))throw this.gc('Document fields cannot begin and end with "__"')}}class lZ{constructor(e,t,n){this.databaseId=e,this.ignoreUndefinedProperties=t,this.serializer=n||aT(e)}bc(e,t,n,r=!1){return new lX({Ic:e,methodName:t,wc:n,path:X.emptyPath(),Rc:!1,yc:r},this.databaseId,this.serializer,this.ignoreUndefinedProperties)}}function l0(e){let t=e._freezeSettings(),n=aT(e._databaseId);return new lZ(e._databaseId,!!t.ignoreUndefinedProperties,n)}function l1(e,t,n,r,i,s={}){let a,o,l=e.bc(s.merge||s.mergeFields?2:0,t,n,i);ui("Data must be an object, but it was:",l,r);let u=un(r,l);if(s.merge)a=new tL(l.fieldMask),o=l.fieldTransforms;else if(s.mergeFields){let e=[];for(let r of s.mergeFields){let i=us(t,r,n);if(!l.contains(i))throw new D(N.INVALID_ARGUMENT,`Field '${i}' is specified in your field mask but missing from your input data.`);uu(e,i)||e.push(i)}a=new tL(e),o=l.fieldTransforms.filter(e=>a.covers(e.field))}else a=null,o=l.fieldTransforms;return new lH(new nm(u),a,o)}class l2 extends lG{_toFieldTransform(e){if(2!==e.Ic)throw 1===e.Ic?e.gc(`${this._methodName}() can only appear at the top level of your update data`):e.gc(`${this._methodName}() cannot be used with set() unless you pass {merge:true}`);return e.fieldMask.push(e.path),null}isEqual(e){return e instanceof l2}}function l5(e,t,n){return new lX({Ic:3,wc:t.settings.wc,methodName:e._methodName,Rc:n},t.databaseId,t.serializer,t.ignoreUndefinedProperties)}class l4 extends lG{_toFieldTransform(e){return new rv(e.path,new rh)}isEqual(e){return e instanceof l4}}class l3 extends lG{constructor(e,t){super(e),this.Sc=t}_toFieldTransform(e){let t=l5(this,e,!0),n=new rd(this.Sc.map(e=>ut(e,t)));return new rv(e.path,n)}isEqual(e){return e instanceof l3&&d.deepEqual(this.Sc,e.Sc)}}class l6 extends lG{constructor(e,t){super(e),this.Sc=t}_toFieldTransform(e){let t=l5(this,e,!0),n=new rm(this.Sc.map(e=>ut(e,t)));return new rv(e.path,n)}isEqual(e){return e instanceof l6&&d.deepEqual(this.Sc,e.Sc)}}class l8 extends lG{constructor(e,t){super(e),this.Dc=t}_toFieldTransform(e){let t=new rp(e.serializer,rl(e.serializer,this.Dc));return new rv(e.path,t)}isEqual(e){return e instanceof l8&&this.Dc===e.Dc}}function l9(e,t,n,r){let i=e.bc(1,t,n);ui("Data must be an object, but it was:",i,r);let s=[],a=nm.empty();return tC(r,(e,r)=>{let o=uo(t,e,n);r=d.getModularInstance(r);let l=i.mc(o);if(r instanceof l2)s.push(o);else{let e=ut(r,l);null!=e&&(s.push(o),a.set(o,e))}}),new lY(a,new tL(s),i.fieldTransforms)}function l7(e,t,n,r,i,s){let a=e.bc(1,t,n),o=[us(t,r,n)],l=[i];if(s.length%2!=0)throw new D(N.INVALID_ARGUMENT,`Function ${t}() needs to be called with an even number of arguments that alternate between field names and values.`);for(let e=0;e<s.length;e+=2)o.push(us(t,s[e])),l.push(s[e+1]);let u=[],c=nm.empty();for(let e=o.length-1;e>=0;--e)if(!uu(u,o[e])){let t=o[e],n=l[e];n=d.getModularInstance(n);let r=a.mc(t);if(n instanceof l2)u.push(t);else{let e=ut(n,r);null!=e&&(u.push(t),c.set(t,e))}}return new lY(c,new tL(u),a.fieldTransforms)}function ue(e,t,n,r=!1){return ut(n,e.bc(r?4:3,t))}function ut(e,t){if(ur(e=d.getModularInstance(e)))return ui("Unsupported field value:",t,e),un(e,t);if(e instanceof lG)return function(e,t){if(!lJ(t.Ic))throw t.gc(`${e._methodName}() can only be used with update() and set()`);if(!t.path)throw t.gc(`${e._methodName}() is not currently supported inside arrays`);let n=e._toFieldTransform(t);n&&t.fieldTransforms.push(n)}(e,t),null;if(void 0===e&&t.ignoreUndefinedProperties)return null;if(t.path&&t.fieldMask.push(t.path),e instanceof Array){if(t.settings.Rc&&4!==t.Ic)throw t.gc("Nested arrays are not supported");let n=[],r=0;for(let i of e){let e=ut(i,t.fc(r));null==e&&(e={nullValue:"NULL_VALUE"}),n.push(e),r++}return{arrayValue:{values:n}}}return function(e,t){if(null===(e=d.getModularInstance(e)))return{nullValue:"NULL_VALUE"};if("number"==typeof e)return rl(t.serializer,e);if("boolean"==typeof e)return{booleanValue:e};if("string"==typeof e)return{stringValue:e};if(e instanceof Date){let n=Q.fromDate(e);return{timestampValue:r8(t.serializer,n)}}if(e instanceof Q){let n=new Q(e.seconds,1e3*Math.floor(e.nanoseconds/1e3));return{timestampValue:r8(t.serializer,n)}}if(e instanceof lQ)return{geoPointValue:{latitude:e.latitude,longitude:e.longitude}};if(e instanceof l$)return{bytesValue:r9(t.serializer,e._byteString)};if(e instanceof lC){let n=t.databaseId,r=e.firestore._databaseId;if(!r.isEqual(n))throw t.gc(`Document reference is for database ${r.projectId}/${r.database} but should be for database ${n.projectId}/${n.database}`);return{referenceValue:ie(e.firestore._databaseId||t.databaseId,e._key.path)}}if(e instanceof lj)return{mapValue:{fields:{[tZ]:{stringValue:t2},[t5]:{arrayValue:{values:e.toArray().map(e=>{if("number"!=typeof e)throw t.gc("VectorValues must only contain numeric values.");return ra(t.serializer,e)})}}}}};throw t.gc(`Unsupported field value: ${lv(e)}`)}(e,t)}function un(e,t){let n={};return tD(e)?t.path&&t.path.length>0&&t.fieldMask.push(t.path):tC(e,(e,r)=>{let i=ut(r,t.Ac(e));null!=i&&(n[e]=i)}),{mapValue:{fields:n}}}function ur(e){return!("object"!=typeof e||null===e||e instanceof Array||e instanceof Date||e instanceof Q||e instanceof lQ||e instanceof l$||e instanceof lC||e instanceof lG||e instanceof lj)}function ui(e,t,n){if(!ur(n)||"object"!=typeof n||null===n||Object.getPrototypeOf(n)!==Object.prototype&&null!==Object.getPrototypeOf(n)){let r=lv(n);throw"an object"===r?t.gc(e+" a custom object"):t.gc(e+" "+r)}}function us(e,t,n){if((t=d.getModularInstance(t))instanceof lK)return t._internalPath;if("string"==typeof t)return uo(e,t);throw ul("Field path arguments must be of type string or ",e,!1,void 0,n)}let ua=RegExp("[~\\*/\\[\\]]");function uo(e,t,n){if(t.search(ua)>=0)throw ul(`Invalid field path (${t}). Paths must not contain '~', '*', '/', '[', or ']'`,e,!1,void 0,n);try{return new lK(...t.split("."))._internalPath}catch(r){throw ul(`Invalid field path (${t}). Paths must not be empty, begin with '.', end with '.', or contain '..'`,e,!1,void 0,n)}}function ul(e,t,n,r,i){let s=r&&!r.isEmpty(),a=void 0!==i,o=`Function ${t}() called with invalid data`;n&&(o+=" (via `toFirestore()`)"),o+=". ";let l="";return(s||a)&&(l+=" (found",s&&(l+=` in field ${r}`),a&&(l+=` in document ${i}`),l+=")"),new D(N.INVALID_ARGUMENT,o+e+l)}function uu(e,t){return e.some(e=>e.isEqual(t))}class uc{constructor(e,t,n,r,i){this._firestore=e,this._userDataWriter=t,this._key=n,this._document=r,this._converter=i}get id(){return this._key.path.lastSegment()}get ref(){return new lC(this._firestore,this._converter,this._key)}exists(){return null!==this._document}data(){if(this._document){if(this._converter){let e=new uh(this._firestore,this._userDataWriter,this._key,this._document,null);return this._converter.fromFirestore(e)}return this._userDataWriter.convertValue(this._document.data.value)}}get(e){if(this._document){let t=this._document.data.field(ud("DocumentSnapshot.get",e));if(null!==t)return this._userDataWriter.convertValue(t)}}}class uh extends uc{data(){return super.data()}}function ud(e,t){return"string"==typeof t?uo(e,t):t instanceof lK?t._internalPath:t._delegate._internalPath}function uf(e){if("L"===e.limitType&&0===e.explicitOrderBy.length)throw new D(N.UNIMPLEMENTED,"limitToLast() queries require specifying at least one orderBy() clause")}class um{}class ug extends um{}class up extends ug{constructor(e,t,n){super(),this._field=e,this._op=t,this._value=n,this.type="where"}static _create(e,t,n){return new up(e,t,n)}_apply(e){let t=this._parse(e);return ux(e._query,t),new lS(e.firestore,e.converter,nX(e._query,t))}_parse(e){let t=l0(e.firestore);return function(e,t,n,r,i,s,a){let o;if(i.isKeyField()){if("array-contains"===s||"array-contains-any"===s)throw new D(N.INVALID_ARGUMENT,`Invalid Query. You can't perform '${s}' queries on documentId().`);if("in"===s||"not-in"===s){uE(a,s);let t=[];for(let n of a)t.push(ub(r,e,n));o={arrayValue:{values:t}}}else o=ub(r,e,a)}else"in"!==s&&"not-in"!==s&&"array-contains-any"!==s||uE(a,s),o=ue(n,t,a,"in"===s||"not-in"===s);return n_.create(i,s,o)}(e._query,"where",t,e.firestore._databaseId,this._field,this._op,this._value)}}class uy extends um{constructor(e,t){super(),this.type=e,this._queryConstraints=t}static _create(e,t){return new uy(e,t)}_parse(e){let t=this._queryConstraints.map(t=>t._parse(e)).filter(e=>e.getFilters().length>0);return 1===t.length?t[0]:nT.create(t,this._getOperator())}_apply(e){let t=this._parse(e);return 0===t.getFilters().length?e:(function(e,t){let n=e;for(let e of t.getFlattenedFilters())ux(n,e),n=nX(n,e)}(e._query,t),new lS(e.firestore,e.converter,nX(e._query,t)))}_getQueryConstraints(){return this._queryConstraints}_getOperator(){return"and"===this.type?"and":"or"}}class uw extends ug{constructor(e,t){super(),this._field=e,this._direction=t,this.type="orderBy"}static _create(e,t){return new uw(e,t)}_apply(e){let t=function(e,t,n){if(null!==e.startAt)throw new D(N.INVALID_ARGUMENT,"Invalid query. You must not call startAt() or startAfter() before calling orderBy().");if(null!==e.endAt)throw new D(N.INVALID_ARGUMENT,"Invalid query. You must not call endAt() or endBefore() before calling orderBy().");return new nv(t,n)}(e._query,this._field,this._direction);return new lS(e.firestore,e.converter,function(e,t){let n=e.explicitOrderBy.concat([t]);return new nK(e.path,e.collectionGroup,n,e.filters.slice(),e.limit,e.limitType,e.startAt,e.endAt)}(e._query,t))}}class uv extends ug{constructor(e,t,n){super(),this.type=e,this._limit=t,this._limitType=n}static _create(e,t,n){return new uv(e,t,n)}_apply(e){return new lS(e.firestore,e.converter,nZ(e._query,this._limit,this._limitType))}}class uI extends ug{constructor(e,t,n){super(),this.type=e,this._docOrFields=t,this._inclusive=n}static _create(e,t,n){return new uI(e,t,n)}_apply(e){var t;let n=uT(e,this.type,this._docOrFields,this._inclusive);return new lS(e.firestore,e.converter,(t=e._query,new nK(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,n,t.endAt)))}}class u_ extends ug{constructor(e,t,n){super(),this.type=e,this._docOrFields=t,this._inclusive=n}static _create(e,t,n){return new u_(e,t,n)}_apply(e){var t;let n=uT(e,this.type,this._docOrFields,this._inclusive);return new lS(e.firestore,e.converter,(t=e._query,new nK(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,t.startAt,n)))}}function uT(e,t,n,r){if(n[0]=d.getModularInstance(n[0]),n[0]instanceof uc)return function(e,t,n,r,i){if(!r)throw new D(N.NOT_FOUND,`Can't use a DocumentSnapshot that doesn't exist for ${n}().`);let s=[];for(let n of nW(e))if(n.field.isKeyField())s.push(nn(t,r.key));else{let e=r.data.field(n.field);if(tj(e))throw new D(N.INVALID_ARGUMENT,'Invalid query. You are trying to start or end a query using a document for which the field "'+n.field+'" is an uncommitted server timestamp. (Since the value of this field is unknown, you cannot start/end a query with it.)');if(null===e){let e=n.field.canonicalString();throw new D(N.INVALID_ARGUMENT,`Invalid query. You are trying to start or end a query using a document for which the field '${e}' (used as the orderBy) does not exist.`)}s.push(e)}return new np(s,i)}(e._query,e.firestore._databaseId,t,n[0]._document,r);{let i=l0(e.firestore);return function(e,t,n,r,i,s){let a=e.explicitOrderBy;if(i.length>a.length)throw new D(N.INVALID_ARGUMENT,`Too many arguments provided to ${r}(). The number of arguments must be less than or equal to the number of orderBy() clauses`);let o=[];for(let s=0;s<i.length;s++){let l=i[s];if(a[s].field.isKeyField()){if("string"!=typeof l)throw new D(N.INVALID_ARGUMENT,`Invalid query. Expected a string for document ID in ${r}(), but got a ${typeof l}`);if(!nj(e)&&-1!==l.indexOf("/"))throw new D(N.INVALID_ARGUMENT,`Invalid query. When querying a collection and ordering by documentId(), the value passed to ${r}() must be a plain document ID, but '${l}' contains a slash.`);let n=e.path.child(Y.fromString(l));if(!Z.isDocumentKey(n))throw new D(N.INVALID_ARGUMENT,`Invalid query. When querying a collection group and ordering by documentId(), the value passed to ${r}() must result in a valid document path, but '${n}' is not because it contains an odd number of segments.`);let i=new Z(n);o.push(nn(t,i))}else{let e=ue(n,r,l);o.push(e)}}return new np(o,s)}(e._query,e.firestore._databaseId,i,t,n,r)}}function ub(e,t,n){if("string"==typeof(n=d.getModularInstance(n))){if(""===n)throw new D(N.INVALID_ARGUMENT,"Invalid query. When querying with documentId(), you must provide a valid document ID, but it was an empty string.");if(!nj(t)&&-1!==n.indexOf("/"))throw new D(N.INVALID_ARGUMENT,`Invalid query. When querying a collection by documentId(), you must provide a plain document ID, but '${n}' contains a '/' character.`);let r=t.path.child(Y.fromString(n));if(!Z.isDocumentKey(r))throw new D(N.INVALID_ARGUMENT,`Invalid query. When querying a collection group by documentId(), the value provided must result in a valid document path, but '${r}' is not because it has an odd number of segments (${r.length}).`);return nn(e,new Z(r))}if(n instanceof lC)return nn(e,n._key);throw new D(N.INVALID_ARGUMENT,`Invalid query. When querying with documentId(), you must provide a valid string or a DocumentReference, but it was: ${lv(n)}.`)}function uE(e,t){if(!Array.isArray(e)||0===e.length)throw new D(N.INVALID_ARGUMENT,`Invalid Query. A non-empty array is required for '${t.toString()}' filters.`)}function ux(e,t){let n=function(e,t){for(let n of e)for(let e of n.getFlattenedFilters())if(t.indexOf(e.op)>=0)return e.op;return null}(e.filters,function(e){switch(e){case"!=":return["!=","not-in"];case"array-contains-any":case"in":return["not-in"];case"not-in":return["array-contains-any","in","not-in","!="];default:return[]}}(t.op));if(null!==n)throw n===t.op?new D(N.INVALID_ARGUMENT,`Invalid query. You cannot use more than one '${t.op.toString()}' filter.`):new D(N.INVALID_ARGUMENT,`Invalid query. You cannot use '${t.op.toString()}' filters with '${n.toString()}' filters.`)}function uS(e,t){if(!(t instanceof up||t instanceof uy))throw new D(N.INVALID_ARGUMENT,`Function ${e}() requires AppliableConstraints created with a call to 'where(...)', 'or(...)', or 'and(...)'.`)}class uC{convertValue(e,t="none"){switch(t3(e)){case 0:return null;case 1:return e.booleanValue;case 2:return tB(e.integerValue||e.doubleValue);case 3:return this.convertTimestamp(e.timestampValue);case 4:return this.convertServerTimestamp(e,t);case 5:return e.stringValue;case 6:return this.convertBytes(tz(e.bytesValue));case 7:return this.convertReference(e.referenceValue);case 8:return this.convertGeoPoint(e.geoPointValue);case 9:return this.convertArray(e.arrayValue,t);case 11:return this.convertObject(e.mapValue,t);case 10:return this.convertVectorValue(e.mapValue);default:throw x(62114,{value:e})}}convertObject(e,t){return this.convertObjectMap(e.fields,t)}convertObjectMap(e,t="none"){let n={};return tC(e,(e,r)=>{n[e]=this.convertValue(r,t)}),n}convertVectorValue(e){var t,n,r;return new lj(null==(r=null==(n=null==(t=e.fields)?void 0:t[t5].arrayValue)?void 0:n.values)?void 0:r.map(e=>tB(e.doubleValue)))}convertGeoPoint(e){return new lQ(tB(e.latitude),tB(e.longitude))}convertArray(e,t){return(e.values||[]).map(e=>this.convertValue(e,t))}convertServerTimestamp(e,t){switch(t){case"previous":let n=tW(e);return null==n?null:this.convertValue(n,t);case"estimate":return this.convertTimestamp(tH(e));default:return null}}convertTimestamp(e){let t=tU(e);return new Q(t.seconds,t.nanos)}convertDocumentKey(e,t){let n=Y.fromString(e);C(i_(n),9688,{name:e});let r=new tX(n.get(1),n.get(3)),i=new Z(n.popFirst(5));return r.isEqual(t)||T(`Document ${i} contains a document reference within a different database (${r.projectId}/${r.database}) which is not supported. It will be treated as a reference in the current database (${t.projectId}/${t.database}) instead.`),i}}function uN(e,t,n){return e?n&&(n.merge||n.mergeFields)?e.toFirestore(t,n):e.toFirestore(t):t}class uD extends uC{constructor(e){super(),this.firestore=e}convertBytes(e){return new l$(e)}convertReference(e){let t=this.convertDocumentKey(e,this.firestore._databaseId);return new lC(this.firestore,null,t)}}function uA(){return new lB("count")}class uk{constructor(e,t){this.hasPendingWrites=e,this.fromCache=t}isEqual(e){return this.hasPendingWrites===e.hasPendingWrites&&this.fromCache===e.fromCache}}class uR extends uc{constructor(e,t,n,r,i,s){super(e,t,n,r,s),this._firestore=e,this._firestoreImpl=e,this.metadata=i}exists(){return super.exists()}data(e={}){if(this._document){if(this._converter){let t=new uM(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null);return this._converter.fromFirestore(t,e)}return this._userDataWriter.convertValue(this._document.data.value,e.serverTimestamps)}}get(e,t={}){if(this._document){let n=this._document.data.field(ud("DocumentSnapshot.get",e));if(null!==n)return this._userDataWriter.convertValue(n,t.serverTimestamps)}}}class uM extends uR{data(e={}){return super.data(e)}}class uF{constructor(e,t,n,r){this._firestore=e,this._userDataWriter=t,this._snapshot=r,this.metadata=new uk(r.hasPendingWrites,r.fromCache),this.query=n}get docs(){let e=[];return this.forEach(t=>e.push(t)),e}get size(){return this._snapshot.docs.size}get empty(){return 0===this.size}forEach(e,t){this._snapshot.docs.forEach(n=>{e.call(t,new uM(this._firestore,this._userDataWriter,n.key,n,new uk(this._snapshot.mutatedKeys.has(n.key),this._snapshot.fromCache),this.query.converter))})}docChanges(e={}){let t=!!e.includeMetadataChanges;if(t&&this._snapshot.excludesMetadataChanges)throw new D(N.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===t||(this._cachedChanges=function(e,t){if(e._snapshot.oldDocs.isEmpty()){let t=0;return e._snapshot.docChanges.map(n=>{let r=new uM(e._firestore,e._userDataWriter,n.doc.key,n.doc,new uk(e._snapshot.mutatedKeys.has(n.doc.key),e._snapshot.fromCache),e.query.converter);return n.doc,{type:"added",doc:r,oldIndex:-1,newIndex:t++}})}{let n=e._snapshot.oldDocs;return e._snapshot.docChanges.filter(e=>t||3!==e.type).map(t=>{let r=new uM(e._firestore,e._userDataWriter,t.doc.key,t.doc,new uk(e._snapshot.mutatedKeys.has(t.doc.key),e._snapshot.fromCache),e.query.converter),i=-1,s=-1;return 0!==t.type&&(i=n.indexOf(t.doc.key),n=n.delete(t.doc.key)),1!==t.type&&(s=(n=n.add(t.doc)).indexOf(t.doc.key)),{type:function(e){switch(e){case 0:return"added";case 2:case 3:return"modified";case 1:return"removed";default:return x(61501,{type:e})}}(t.type),doc:r,oldIndex:i,newIndex:s}})}}(this,t),this._cachedChangesIncludeMetadataChanges=t),this._cachedChanges}}class uV extends uC{constructor(e){super(),this.firestore=e}convertBytes(e){return new l$(e)}convertReference(e){let t=this.convertDocumentKey(e,this.firestore._databaseId);return new lC(this.firestore,null,t)}}function uL(e,t){var n=lP(e);let r=new A;return n.asyncQueue.enqueueAndForget(async()=>oS(await ll(n),t,r)),r.promise}function uP(e,t,n){let r=n.docs.get(t._key),i=new uV(e);return new uR(e,i,t._key,r,new uk(n.hasPendingWrites,n.fromCache),t.converter)}function uO(e,t){let n=lI(e.firestore,lL),r=lP(n),i=tN(t,(e,t)=>new rP(t,e.aggregateType,e._internalFieldPath));return(function(e,t,n){let r=new A;return e.asyncQueue.enqueueAndForget(async()=>{try{let i=await lu(e);r.resolve(async function(e,t,n){var r;let{request:i,yt:s,parent:a}=iy(e.serializer,nY(t),n);e.connection.Uo||delete i.parent;let o=(await e.Yo("RunAggregationQuery",e.serializer.databaseId,a,i,1)).filter(e=>!!e.result);C(1===o.length,64727);let l=null==(r=o[0].result)?void 0:r.aggregateFields;return Object.keys(l).reduce((e,t)=>(e[s[t]]=l[t],e),{})}(i,t,n))}catch(e){r.reject(e)}}),r.promise})(r,e._query,i).then(t=>new lz(e,new uV(n),t))}class uq{constructor(e){this.kind="memory",this._onlineComponentProvider=o5.provider,(null==e?void 0:e.garbageCollector)?this._offlineComponentProvider=e.garbageCollector._offlineComponentProvider:this._offlineComponentProvider={build:()=>new o0(void 0)}}toJSON(){return{kind:this.kind}}}class uU{constructor(e){let t;this.kind="persistent",(null==e?void 0:e.tabManager)?(e.tabManager._initialize(e),t=e.tabManager):(t=uG(void 0))._initialize(e),this._onlineComponentProvider=t._onlineComponentProvider,this._offlineComponentProvider=t._offlineComponentProvider}toJSON(){return{kind:this.kind}}}class uB{constructor(){this.kind="memoryEager",this._offlineComponentProvider=oZ.provider}toJSON(){return{kind:this.kind}}}class uz{constructor(e){this.kind="memoryLru",this._offlineComponentProvider={build:()=>new o0(e)}}toJSON(){return{kind:this.kind}}}class u${constructor(e){this.forceOwnership=e,this.kind="persistentSingleTab"}toJSON(){return{kind:this.kind}}_initialize(e){this._onlineComponentProvider=o5.provider,this._offlineComponentProvider={build:t=>new o1(t,null==e?void 0:e.cacheSizeBytes,this.forceOwnership)}}}class uK{constructor(){this.kind="PersistentMultipleTab"}toJSON(){return{kind:this.kind}}_initialize(e){this._onlineComponentProvider=o5.provider,this._offlineComponentProvider={build:t=>new o2(t,null==e?void 0:e.cacheSizeBytes)}}}function uG(e){return new u$(null==e?void 0:e.forceOwnership)}let uQ={maxAttempts:5};class uj{constructor(e,t){this._firestore=e,this._commitHandler=t,this._mutations=[],this._committed=!1,this._dataReader=l0(e)}set(e,t,n){this._verifyNotCommitted();let r=uW(e,this._firestore),i=uN(r.converter,t,n),s=l1(this._dataReader,"WriteBatch.set",r._key,i,null!==r.converter,n);return this._mutations.push(s.toMutation(r._key,r_.none())),this}update(e,t,n,...r){let i;this._verifyNotCommitted();let s=uW(e,this._firestore);return i="string"==typeof(t=d.getModularInstance(t))||t instanceof lK?l7(this._dataReader,"WriteBatch.update",s._key,t,n,r):l9(this._dataReader,"WriteBatch.update",s._key,t),this._mutations.push(i.toMutation(s._key,r_.exists(!0))),this}delete(e){this._verifyNotCommitted();let t=uW(e,this._firestore);return this._mutations=this._mutations.concat(new rR(t._key,r_.none())),this}commit(){return this._verifyNotCommitted(),this._committed=!0,this._mutations.length>0?this._commitHandler(this._mutations):Promise.resolve()}_verifyNotCommitted(){if(this._committed)throw new D(N.FAILED_PRECONDITION,"A write batch can no longer be used after commit() has been called.")}}function uW(e,t){if((e=d.getModularInstance(e)).firestore!==t)throw new D(N.INVALID_ARGUMENT,"Provided document reference is from a different Firestore instance.");return e}class uH{constructor(e,t){this._firestore=e,this._transaction=t,this._dataReader=l0(e)}get(e){let t=uW(e,this._firestore),n=new uD(this._firestore);return this._transaction.lookup([t._key]).then(e=>{if(!e||1!==e.length)return x(24041);let r=e[0];if(r.isFoundDocument())return new uc(this._firestore,n,r.key,r,t.converter);if(r.isNoDocument())return new uc(this._firestore,n,t._key,null,t.converter);throw x(18433,{doc:r})})}set(e,t,n){let r=uW(e,this._firestore),i=uN(r.converter,t,n),s=l1(this._dataReader,"Transaction.set",r._key,i,null!==r.converter,n);return this._transaction.set(r._key,s),this}update(e,t,n,...r){let i,s=uW(e,this._firestore);return i="string"==typeof(t=d.getModularInstance(t))||t instanceof lK?l7(this._dataReader,"Transaction.update",s._key,t,n,r):l9(this._dataReader,"Transaction.update",s._key,t),this._transaction.update(s._key,i),this}delete(e){let t=uW(e,this._firestore);return this._transaction.delete(t._key),this}}class uY extends uH{constructor(e,t){super(e,t),this._firestore=e}get(e){let t=uW(e,this._firestore),n=new uV(this._firestore);return super.get(e).then(e=>new uR(this._firestore,n,t._key,e._document,new uk(!1,!1),t.converter))}}function uJ(e,t){if("string"!=typeof e[t])throw new D(N.INVALID_ARGUMENT,"Missing string value for: "+t);return e[t]}class uX{constructor(e){this._firestore=e,this.type="PersistentCacheIndexManager"}}function uZ(e,t){var n;(n=lP(e._firestore),n.asyncQueue.enqueue(async()=>{var e;return e=await la(n),void(e.Ms.fs=t)})).then(e=>_(`setting persistent cache index auto creation isEnabled=${t} succeeded`)).catch(e=>b(`setting persistent cache index auto creation isEnabled=${t} failed`,e))}let u0=new WeakMap;class u1{constructor(){throw Error("instances of this class should not be created")}static onExistenceFilterMismatch(e){return u2.instance.onExistenceFilterMismatch(e)}}class u2{constructor(){this.vc=new Map}static get instance(){return u5||function(e){if(rB)throw Error("a TestingHooksSpi instance is already set");rB=e}(u5=new u2),u5}ht(e){this.vc.forEach(t=>t(e))}onExistenceFilterMismatch(e){let t=Symbol(),n=this.vc;return n.set(t,e),()=>n.delete(t)}}let u5=null;!function(e=!0){w=u.SDK_VERSION,u._registerComponent(new c.Component("firestore",(t,{instanceIdentifier:n,options:r})=>{let i=t.getProvider("app").getImmediate(),s=new lL(new F(t.getProvider("auth-internal")),new O(i,t.getProvider("app-check-internal")),function(e,t){if(!Object.prototype.hasOwnProperty.apply(e.options,["projectId"]))throw new D(N.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');return new tX(e.options.projectId,t)}(i,n),i);return r=Object.assign({useFetchStreams:e},r),s._setSettings(r),s},"PUBLIC").setMultipleInstances(!0)),u.registerVersion(g,p,void 0),u.registerVersion(g,p,"cjs2017")}(),t.AbstractUserDataWriter=uC,t.AggregateField=lB,t.AggregateQuerySnapshot=lz,t.Bytes=l$,t.CACHE_SIZE_UNLIMITED=-1,t.CollectionReference=lN,t.DocumentReference=lC,t.DocumentSnapshot=uR,t.FieldPath=lK,t.FieldValue=lG,t.Firestore=lL,t.FirestoreError=D,t.GeoPoint=lQ,t.LoadBundleTask=lV,t.PersistentCacheIndexManager=uX,t.Query=lS,t.QueryCompositeFilterConstraint=uy,t.QueryConstraint=ug,t.QueryDocumentSnapshot=uM,t.QueryEndAtConstraint=u_,t.QueryFieldFilterConstraint=up,t.QueryLimitConstraint=uv,t.QueryOrderByConstraint=uw,t.QuerySnapshot=uF,t.QueryStartAtConstraint=uI,t.SnapshotMetadata=uk,t.Timestamp=Q,t.Transaction=uY,t.VectorValue=lj,t.WriteBatch=uj,t._AutoId=B,t._ByteString=tO,t._DatabaseId=tX,t._DocumentKey=Z,t._EmptyAppCheckTokenProvider=q,t._EmptyAuthCredentialsProvider=R,t._FieldPath=X,t._TestingHooks=u1,t._cast=lI,t._debugAssert=function(e,t){e||x(57014,t)},t._internalAggregationQueryToProtoRunAggregationQueryRequest=function(e,t){var n;let r=tN(t,(e,t)=>new rP(t,e.aggregateType,e._internalFieldPath)),i=null==(n=lP(lI(e.firestore,lL))._onlineComponents)?void 0:n.datastore.serializer;return void 0===i?null:iy(i,nY(e._query),r,!0).request},t._internalQueryToProtoQueryTarget=function(e){var t;let n=null==(t=lP(lI(e.firestore,lL))._onlineComponents)?void 0:t.datastore.serializer;return void 0===n?null:ip(n,nH(e._query)).gt},t._isBase64Available=function(){return"undefined"!=typeof atob},t._logWarn=b,t._validateIsNotUsedTogether=lp,t.addDoc=function(e,t){let n=lI(e.firestore,lL),r=lD(e),i=uN(e.converter,t);return uL(n,[l1(l0(e.firestore),"addDoc",r._key,i,null!==e.converter,{}).toMutation(r._key,r_.exists(!1))]).then(()=>r)},t.aggregateFieldEqual=function(e,t){var n,r;return e instanceof lB&&t instanceof lB&&e.aggregateType===t.aggregateType&&(null==(n=e._internalFieldPath)?void 0:n.canonicalString())===(null==(r=t._internalFieldPath)?void 0:r.canonicalString())},t.aggregateQuerySnapshotEqual=function(e,t){return lA(e.query,t.query)&&d.deepEqual(e.data(),t.data())},t.and=function(...e){return e.forEach(e=>uS("and",e)),uy._create("and",e)},t.arrayRemove=function(...e){return new l6("arrayRemove",e)},t.arrayUnion=function(...e){return new l3("arrayUnion",e)},t.average=function(e){return new lB("avg",us("average",e))},t.clearIndexedDbPersistence=function(e){if(e._initialized&&!e._terminated)throw new D(N.FAILED_PRECONDITION,"Persistence can only be cleared before a Firestore instance is initialized or after it is terminated.");let t=new A;return e._queue.enqueueAndForgetEvenWhileRestricted(async()=>{try{await async function(e){if(!ep.C())return Promise.resolve();await ep.delete(e+sU)}(sz(e._databaseId,e._persistenceKey)),t.resolve()}catch(e){t.reject(e)}}),t.promise},t.collection=function(e,t,...n){if(e=d.getModularInstance(e),lg("collection","path",t),e instanceof lE){let r=Y.fromString(t,...n);return lw(r),new lN(e,null,r)}{if(!(e instanceof lC||e instanceof lN))throw new D(N.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");let r=e._path.child(Y.fromString(t,...n));return lw(r),new lN(e.firestore,null,r)}},t.collectionGroup=function(e,t){if(e=lI(e,lE),lg("collectionGroup","collection id",t),t.indexOf("/")>=0)throw new D(N.INVALID_ARGUMENT,`Invalid collection ID '${t}' passed to function collectionGroup(). Collection IDs must not contain '/'.`);return new lS(e,null,new nK(Y.emptyPath(),t))},t.connectFirestoreEmulator=lx,t.count=uA,t.deleteAllPersistentCacheIndexes=function(e){var t;(t=lP(e._firestore)).asyncQueue.enqueue(async()=>(function(e){let t=e.indexManager;return e.persistence.runTransaction("Delete All Indexes","readwrite",e=>t.deleteAllFieldIndexes(e))})(await la(t))).then(e=>_("deleting all persistent cache indexes succeeded")).catch(e=>b("deleting all persistent cache indexes failed",e))},t.deleteDoc=function(e){return uL(lI(e.firestore,lL),[new rR(e._key,r_.none())])},t.deleteField=function(){return new l2("deleteField")},t.disableNetwork=function(e){var t;return(t=lP(e=lI(e,lL))).asyncQueue.enqueue(async()=>{let e=await ls(t),n=await lo(t);return e.setNetworkEnabled(!1),async function(e){e.da.add(0),await aF(e),e.Va.set("Offline")}(n)})},t.disablePersistentCacheIndexAutoCreation=function(e){uZ(e,!1)},t.doc=lD,t.documentId=function(){return new lK(W)},t.enableIndexedDbPersistence=function(e,t){b("enableIndexedDbPersistence() will be deprecated in the future, you can use `FirestoreSettings.cache` instead.");let n=e._freezeSettings();return lU(e,o5.provider,{build:e=>new o1(e,n.cacheSizeBytes,null==t?void 0:t.forceOwnership)}),Promise.resolve()},t.enableMultiTabIndexedDbPersistence=lq,t.enableNetwork=function(e){var t;return(t=lP(e=lI(e,lL))).asyncQueue.enqueue(async()=>{let e=await ls(t),n=await lo(t);return e.setNetworkEnabled(!0),n.da.delete(0),aM(n)})},t.enablePersistentCacheIndexAutoCreation=function(e){uZ(e,!0)},t.endAt=function(...e){return u_._create("endAt",e,!0)},t.endBefore=function(...e){return u_._create("endBefore",e,!1)},t.ensureFirestoreConfigured=lP,t.executeWrite=uL,t.getAggregateFromServer=uO,t.getCountFromServer=function(e){return uO(e,{count:uA()})},t.getDoc=function(e){e=lI(e,lC);let t=lI(e.firestore,lL);return lh(lP(t),e._key).then(n=>uP(t,e,n))},t.getDocFromCache=function(e){e=lI(e,lC);let t=lI(e.firestore,lL),n=lP(t),r=new uV(t);return(function(e,t){let n=new A;return e.asyncQueue.enqueueAndForget(async()=>(async function(e,t,n){try{let r=await e.persistence.runTransaction("read document","readonly",n=>e.localDocuments.getDocument(n,t));r.isFoundDocument()?n.resolve(r):r.isNoDocument()?n.resolve(null):n.reject(new D(N.UNAVAILABLE,"Failed to get document from cache. (However, this document may exist on the server. Run again without setting 'source' in the GetOptions to attempt to retrieve the document from the server.)"))}catch(r){let e=a6(r,`Failed to get document '${t} from cache`);n.reject(e)}})(await la(e),t,n)),n.promise})(n,e._key).then(n=>new uR(t,r,e._key,n,new uk(null!==n&&n.hasLocalMutations,!0),e.converter))},t.getDocFromServer=function(e){e=lI(e,lC);let t=lI(e.firestore,lL);return lh(lP(t),e._key,{source:"server"}).then(n=>uP(t,e,n))},t.getDocs=function(e){e=lI(e,lS);let t=lI(e.firestore,lL),n=lP(t),r=new uV(t);return uf(e._query),ld(n,e._query).then(n=>new uF(t,r,e,n))},t.getDocsFromCache=function(e){e=lI(e,lS);let t=lI(e.firestore,lL),n=lP(t),r=new uV(t);return(function(e,t){let n=new A;return e.asyncQueue.enqueueAndForget(async()=>(async function(e,t,n){try{let r=await sZ(e,t,!0),i=new og(t,r.$s),s=i.tu(r.documents),a=i.applyChanges(s,!1);n.resolve(a.snapshot)}catch(r){let e=a6(r,`Failed to execute query '${t} against cache`);n.reject(e)}})(await la(e),t,n)),n.promise})(n,e._query).then(n=>new uF(t,r,e,n))},t.getDocsFromServer=function(e){e=lI(e,lS);let t=lI(e.firestore,lL),n=lP(t),r=new uV(t);return ld(n,e._query,{source:"server"}).then(n=>new uF(t,r,e,n))},t.getFirestore=function(e,t){let n="object"==typeof e?e:u.getApp(),r="string"==typeof e?e:t||tJ,i=u._getProvider(n,"firestore").getImmediate({identifier:r});if(!i._initialized){let e=d.getDefaultEmulatorHostnameAndPort("firestore");e&&lx(i,...e)}return i},t.getPersistentCacheIndexManager=function(e){var t;e=lI(e,lL);let n=u0.get(e);if(n)return n;if("persistent"!==(null==(t=lP(e)._uninitializedComponentsProvider)?void 0:t._offline.kind))return null;let r=new uX(e);return u0.set(e,r),r},t.increment=function(e){return new l8("increment",e)},t.initializeFirestore=function(e,t,n){n||(n=tJ);let r=u._getProvider(e,"firestore");if(r.isInitialized(n)){let e=r.getImmediate({identifier:n}),i=r.getOptions(n);if(d.deepEqual(i,t))return e;throw new D(N.FAILED_PRECONDITION,"initializeFirestore() has already been called with different options. To avoid this error, call initializeFirestore() with the same options as when it was originally called, or call getFirestore() to return the already initialized instance.")}if(void 0!==t.cacheSizeBytes&&void 0!==t.localCache)throw new D(N.INVALID_ARGUMENT,"cache and cacheSizeBytes cannot be specified at the same time as cacheSizeBytes willbe deprecated. Instead, specify the cache size in the cache object");if(void 0!==t.cacheSizeBytes&&-1!==t.cacheSizeBytes&&t.cacheSizeBytes<1048576)throw new D(N.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");return t.host&&d.isCloudWorkstation(t.host)&&d.pingServer(t.host),r.initialize({options:t,instanceIdentifier:n})},t.limit=function(e){return l_("limit",e),uv._create("limit",e,"F")},t.limitToLast=function(e){return l_("limitToLast",e),uv._create("limitToLast",e,"L")},t.loadBundle=function(e,t){let n=lP(e=lI(e,lL)),r=new lV;return function(e,t,n,r){var i;let s=(i=aT(t),new o6(function(e,t){if(e instanceof Uint8Array)return o4(e,void 0);if(e instanceof ArrayBuffer)return o4(new Uint8Array(e),void 0);if(e instanceof ReadableStream)return e.getReader();throw Error("Source of `toByteStreamReader` has to be a ArrayBuffer or ReadableStream")}("string"==typeof n?U().encode(n):n),i));e.asyncQueue.enqueueAndForget(async()=>{var t;(async function(e,t,n){try{var r;let i=await t.getMetadata();if(await function(e,t){let n=r7(t.createTime);return e.persistence.runTransaction("hasNewerBundle","readonly",n=>e.Ei.getBundleMetadata(n,t.id)).then(e=>!!e&&e.createTime.compareTo(n)>=0)}(e.localStore,i))return await t.close(),n._completeWith({taskState:"Success",documentsLoaded:i.totalDocuments,bytesLoaded:i.totalBytes,totalDocuments:i.totalDocuments,totalBytes:i.totalBytes}),Promise.resolve(new Set);n._updateProgress(od(i));let s=new oh(i,e.localStore,t.serializer),a=await t.wu();for(;a;){let e=await s.Wa(a);e&&n._updateProgress(e),a=await t.wu()}let o=await s.complete();return await oq(e,o.ja,void 0),await (r=e.localStore,r.persistence.runTransaction("Save bundle","readwrite",e=>r.Ei.saveBundleMetadata(e,i))),n._completeWith(o.progress),Promise.resolve(o.za)}catch(e){return b(op,`Loading bundle failed with ${e}`),n._failWith(e),Promise.resolve(new Set)}})(t=await ll(e),s,r).then(e=>{t.sharedClientState.notifyBundleLoaded(e)})})}(n,e._databaseId,t,r),r},t.memoryEagerGarbageCollector=function(){return new uB},t.memoryLocalCache=function(e){return new uq(e)},t.memoryLruGarbageCollector=function(e){return new uz(null==e?void 0:e.cacheSizeBytes)},t.namedQuery=function(e,t){var n;return(n=lP(e=lI(e,lL)),n.asyncQueue.enqueue(async()=>{var e;return e=await la(n),e.persistence.runTransaction("Get named query","readonly",n=>e.Ei.getNamedQuery(n,t))})).then(t=>t?new lS(e,null,t.query):null)},t.onSnapshot=function(e,...t){let n,r,i;e=d.getModularInstance(e);let s={includeMetadataChanges:!1,source:"default"},a=0;"object"!=typeof t[0]||lF(t[a])||(s=t[a],a++);let o={includeMetadataChanges:s.includeMetadataChanges,source:s.source};if(lF(t[a])){let e=t[a];t[a]=null==(l=e.next)?void 0:l.bind(e),t[a+1]=null==(u=e.error)?void 0:u.bind(e),t[a+2]=null==(c=e.complete)?void 0:c.bind(e)}if(e instanceof lC)r=lI(e.firestore,lL),i=nG(e._key.path),n={next:n=>{t[a]&&t[a](uP(r,e,n))},error:t[a+1],complete:t[a+2]};else{let s=lI(e,lS);r=lI(s.firestore,lL),i=s._query;let o=new uV(r);n={next:e=>{t[a]&&t[a](new uF(r,o,s,e))},error:t[a+1],complete:t[a+2]},uf(e._query)}var l,u,c,h=lP(r),f=i;let m=new o3(n),g=new ol(f,m,o);return h.asyncQueue.enqueueAndForget(async()=>or(await lc(h),g)),()=>{m.xu(),h.asyncQueue.enqueueAndForget(async()=>oi(await lc(h),g))}},t.onSnapshotsInSync=function(e,t){return function(e,t){let n=new o3(t);return e.asyncQueue.enqueueAndForget(async()=>{var t;return t=await lc(e),void(t.Ca.add(n),n.next())}),()=>{n.xu(),e.asyncQueue.enqueueAndForget(async()=>{var t;return t=await lc(e),void t.Ca.delete(n)})}}(lP(e=lI(e,lL)),lF(t)?t:{next:t})},t.or=function(...e){return e.forEach(e=>uS("or",e)),uy._create("or",e)},t.orderBy=function(e,t="asc"){let n=ud("orderBy",e);return uw._create(n,t)},t.persistentLocalCache=function(e){return new uU(e)},t.persistentMultipleTabManager=function(){return new uK},t.persistentSingleTabManager=uG,t.query=function(e,t,...n){let r=[];for(let i of(t instanceof um&&r.push(t),function(e){let t=e.filter(e=>e instanceof uy).length,n=e.filter(e=>e instanceof up).length;if(t>1||t>0&&n>0)throw new D(N.INVALID_ARGUMENT,"InvalidQuery. When using composite filters, you cannot use more than one filter at the top level. Consider nesting the multiple filters within an `and(...)` statement. For example: change `query(query, where(...), or(...))` to `query(query, and(where(...), or(...)))`.")}(r=r.concat(n)),r))e=i._apply(e);return e},t.queryEqual=lA,t.refEqual=function(e,t){return e=d.getModularInstance(e),t=d.getModularInstance(t),(e instanceof lC||e instanceof lN)&&(t instanceof lC||t instanceof lN)&&e.firestore===t.firestore&&e.path===t.path&&e.converter===t.converter},t.runTransaction=function(e,t,n){e=lI(e,lL);let r=Object.assign(Object.assign({},uQ),n);if(r.maxAttempts<1)throw new D(N.INVALID_ARGUMENT,"Max attempts must be at least 1");return function(e,t,n){let r=new A;return e.asyncQueue.enqueueAndForget(async()=>{let i=await lu(e);new o9(e.asyncQueue,i,n,t,r).Wu()}),r.promise}(lP(e),n=>t(new uY(e,n)),r)},t.serverTimestamp=function(){return new l4("serverTimestamp")},t.setDoc=function(e,t,n){e=lI(e,lC);let r=lI(e.firestore,lL),i=uN(e.converter,t,n);return uL(r,[l1(l0(r),"setDoc",e._key,i,null!==e.converter,n).toMutation(e._key,r_.none())])},t.setIndexConfiguration=function(e,t){let n=lP(e=lI(e,lL));if(!n._uninitializedComponentsProvider||"memory"===n._uninitializedComponentsProvider._offline.kind)return b("Cannot enable indexes when persistence is disabled"),Promise.resolve();let r=function(e){let t="string"==typeof e?function(e){try{return JSON.parse(e)}catch(e){throw new D(N.INVALID_ARGUMENT,"Failed to parse JSON: "+(null==e?void 0:e.message))}}(e):e,n=[];if(Array.isArray(t.indexes))for(let e of t.indexes){let t=uJ(e,"collectionGroup"),r=[];if(Array.isArray(e.fields))for(let t of e.fields){let e=uo("setIndexConfiguration",uJ(t,"fieldPath"));"CONTAINS"===t.arrayConfig?r.push(new ei(e,2)):"ASCENDING"===t.order?r.push(new ei(e,0)):"DESCENDING"===t.order&&r.push(new ei(e,1))}n.push(new ee(ee.UNKNOWN_ID,t,r,es.empty()))}return n}(t);return n.asyncQueue.enqueue(async()=>(async function(e,t){let n=e.indexManager,r=[];return e.persistence.runTransaction("Configure indexes","readwrite",e=>n.getFieldIndexes(e).next(i=>(function(e,t,n,r,i){t=[...t],(e=[...e]).sort(n),t.sort(n);let s=e.length,a=t.length,o=0,l=0;for(;o<a&&l<s;){let s=n(e[l],t[o]);s<0?i(e[l++]):s>0?r(t[o++]):(o++,l++)}for(;o<a;)r(t[o++]);for(;l<s;)i(e[l++])})(i,t,er,t=>{r.push(n.addFieldIndex(e,t))},t=>{r.push(n.deleteFieldIndex(e,t))})).next(()=>ef.waitFor(r)))})(await la(n),r))},t.setLogLevel=function(e){v.setLogLevel(e)},t.snapshotEqual=function(e,t){return e instanceof uR&&t instanceof uR?e._firestore===t._firestore&&e._key.isEqual(t._key)&&(null===e._document?null===t._document:e._document.isEqual(t._document))&&e._converter===t._converter:e instanceof uF&&t instanceof uF&&e._firestore===t._firestore&&lA(e.query,t.query)&&e.metadata.isEqual(t.metadata)&&e._snapshot.isEqual(t._snapshot)},t.startAfter=function(...e){return uI._create("startAfter",e,!1)},t.startAt=function(...e){return uI._create("startAt",e,!0)},t.sum=function(e){return new lB("sum",us("sum",e))},t.terminate=function(e){return u._removeServiceInstance(e.app,"firestore",e._databaseId.database),e._delete()},t.updateDoc=function(e,t,n,...r){e=lI(e,lC);let i=lI(e.firestore,lL),s=l0(i);return uL(i,[("string"==typeof(t=d.getModularInstance(t))||t instanceof lK?l7(s,"updateDoc",e._key,t,n,r):l9(s,"updateDoc",e._key,t)).toMutation(e._key,r_.exists(!0))])},t.vector=function(e){return new lj(e)},t.waitForPendingWrites=function(e){var t=lP(e=lI(e,lL));let n=new A;return t.asyncQueue.enqueueAndForget(async()=>oR(await ll(t),n)),n.promise},t.where=function(e,t,n){let r=ud("where",e);return up._create(r,t,n)},t.writeBatch=function(e){return lP(e=lI(e,lL)),new uj(e,t=>uL(e,t))}}}]);